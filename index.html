<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Locus Gold | Standoff 2</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --accent: #ff9d00;
            --accent-glow: rgba(255, 157, 0, 0.5);
            --bg: #0d0d0d;
            --surface: #1a1a1a;
            --surface-bright: #262626;
            --text: #ffffff;
            --text-dim: #737373;
            --error: #ff4d4d;
            --success: #00ff88;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none; -webkit-user-select: none;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', -apple-system, sans-serif;
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* –î–ò–ó–ê–ô–ù –°–ß–ï–¢–ê: –ö–ò–ë–ï–†–°–ü–û–†–¢–ò–í–ù–´–ô –°–¢–ò–õ–¨ */
        .header {
            padding: 40px 20px 20px;
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            border-bottom: 2px solid var(--surface-bright);
        }

        .score-board {
            display: flex; flex-direction: column; align-items: center;
            position: relative;
        }

        .score-label {
            font-size: 10px; font-weight: 900; color: var(--accent);
            letter-spacing: 3px; text-transform: uppercase; margin-bottom: 5px;
        }

        .score-value-container {
            display: flex; align-items: center; gap: 10px;
        }

        .gold-icon { width: 32px; height: 32px; }

        .score-value {
            font-size: 52px; font-weight: 900; letter-spacing: -2px;
            text-shadow: 0 0 20px var(--accent-glow);
        }

        /* –ö–û–ù–¢–ï–ù–¢ */
        .main-view { flex: 1; position: relative; width: 100%; }

        .page {
            position: absolute; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center;
            padding: 20px; overflow-y: auto;
        }

        .page.active { display: flex; animation: fadeIn 0.2s ease-out; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –ö–õ–ò–ö–ï–†: –ú–û–ù–ï–¢–ê –ò–ó STANDOFF */
        .clicker-area {
            flex: 1; display: flex; align-items: center; justify-content: center;
        }

        .coin-glitch-container {
            position: relative; width: 260px; height: 260px;
        }

        .main-coin {
            width: 100%; height: 100%;
            background: radial-gradient(circle, #f9a825 0%, #bf360c 100%);
            border-radius: 50%; border: 6px solid var(--surface-bright);
            display: flex; align-items: center; justify-content: center;
            font-size: 100px; font-weight: 900; color: rgba(0,0,0,0.6);
            box-shadow: 0 0 40px rgba(191, 54, 12, 0.4), inset 0 0 30px rgba(255,255,255,0.3);
            transition: transform 0.05s; z-index: 2;
        }

        .main-coin:active { transform: scale(0.94); }

        /* –ö–ù–û–ü–ö–ò */
        .btn-stack { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 12px; }

        .btn {
            width: 100%; padding: 20px; border-radius: 12px; border: none;
            font-size: 15px; font-weight: 800; color: #fff;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            text-transform: uppercase; letter-spacing: 1px;
        }

        .btn-primary { background: var(--accent); box-shadow: 0 4px 0 #c77a00; }
        .btn-secondary { background: var(--surface-bright); }
        .btn-withdraw { background: #444; color: #888; pointer-events: none; }
        .btn-withdraw.ready { background: var(--success); color: #000; box-shadow: 0 4px 0 #00bd65; pointer-events: auto; }

        /* –ò–°–¢–û–†–ò–Ø –ò –°–ü–ò–°–ö–ò */
        .section-header { width: 100%; font-size: 12px; font-weight: 800; color: var(--text-dim); margin: 20px 0 10px; text-transform: uppercase; }
        
        .list-box { width: 100%; background: var(--surface); border-radius: 12px; border: 1px solid var(--surface-bright); }
        
        .list-item {
            padding: 15px 20px; border-bottom: 1px solid var(--surface-bright);
            display: flex; justify-content: space-between; align-items: center;
        }

        .status-badge {
            padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 900;
            background: rgba(255, 157, 0, 0.1); color: var(--accent);
        }

        /* –¢–ê–ë-–ë–ê–† */
        .nav {
            height: 80px; background: var(--surface); border-top: 1px solid var(--surface-bright);
            display: flex; padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-dim); transition: 0.2s;
        }

        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }
        .nav-label { font-size: 10px; font-weight: 800; }

        /* –ê–ù–ò–ú–ê–¶–ò–Ø –¢–ê–ü–ê */
        .tap-vfx {
            position: absolute; color: var(--accent); font-weight: 900; font-size: 32px;
            pointer-events: none; animation: tapMove 0.6s ease-out forwards;
        }
        @keyframes tapMove { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }
    </style>
</head>
<body>

    <header class="header">
        <div class="score-board">
            <div class="score-label">–¢–≤–æ–π –±–∞–ª–∞–Ω—Å –∑–æ–ª–æ—Ç–∞</div>
            <div class="score-value-container">
                <div id="gold-val" class="score-value">0</div>
            </div>
        </div>
    </header>

    <main class="main-view">
        <div id="page-main" class="page active">
            <div class="clicker-area">
                <div class="coin-glitch-container">
                    <div id="click-btn" class="main-coin">G</div>
                </div>
            </div>
            <div style="color: var(--text-dim); font-size: 11px; margin-bottom: 10px;">STANDOFF 2 EDITION V1.0</div>
        </div>

        <div id="page-bonuses" class="page">
            <div class="btn-stack">
                <button class="btn btn-primary" onclick="App.watchAd()">üì∫ –°–ú–û–¢–†–ï–¢–¨ –†–ï–ö–õ–ê–ú–£ (+10 G)</button>
                <button class="btn btn-secondary" onclick="App.invite()">üîó –ü–†–ò–ì–õ–ê–°–ò–¢–¨ –î–†–£–ì–ê</button>
            </div>
            <div class="section-header">–¢–≤–æ–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</div>
            <div id="ref-box" class="list-box">
                <div style="padding: 20px; text-align: center; color: var(--text-dim);">–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
            </div>
        </div>

        <div id="page-withdraw" class="page">
            <div class="btn-stack">
                <button id="withdraw-btn" class="btn btn-withdraw" onclick="App.startWithdraw()">üí∞ –í–´–í–ï–°–¢–ò –í STANDOFF 2</button>
            </div>
            <div class="section-header">–ò—Å—Ç–æ—Ä–∏—è –≤—ã–≤–æ–¥–æ–≤</div>
            <div id="history-box" class="list-box">
                <div style="padding: 20px; text-align: center; color: var(--text-dim);">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>
            </div>
        </div>
    </main>

    <nav class="nav">
        <div class="nav-item active" onclick="App.setTab('main', this)">
            <span class="nav-icon">üéÆ</span><span class="nav-label">–ò–ì–†–ê–¢–¨</span>
        </div>
        <div class="nav-item" onclick="App.setTab('bonuses', this)">
            <span class="nav-icon">üíé</span><span class="nav-label">–ë–û–ù–£–°–´</span>
        </div>
        <div class="nav-item" onclick="App.setTab('withdraw', this)">
            <span class="nav-icon">üè¶</span><span class="nav-label">–í–´–í–û–î</span>
        </div>
    </nav>

    <script>
        const App = {
            db: null,
            tg: window.Telegram.WebApp,
            uid: null,
            
            state: {
                gold: 0,
                journal: 0,
                isSyncing: false
            },

            config: {
                min: 750,
                syncMs: 2000,
                fb: {
                    apiKey: "AIzaSyCoa29KS-sin6hoRz0ZbE4f3ki0tZLwkKI",
                    authDomain: "gold-clicker-5d882.firebaseapp.com",
                    projectId: "gold-clicker-5d882",
                    storageBucket: "gold-clicker-5d882.firebasestorage.app",
                    messagingSenderId: "83489312782",
                    appId: "1:83489312782:web:ee5b7bdc390e53e7dd6c5f"
                }
            },

            async init() {
                this.tg.expand();
                this.uid = this.tg.initDataUnsafe?.user?.id?.toString() || "DEV_USER";

                if (!firebase.apps.length) firebase.initializeApp(this.config.fb);
                this.db = firebase.firestore();

                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –∂—É—Ä–Ω–∞–ª–∞
                const cache = localStorage.getItem('locus_cache');
                if (cache) this.state.journal = Number(cache);

                await this.load();
                this.loops();
                this.events();
                this.render();
            },

            async load() {
                try {
                    const doc = await this.db.collection('players').doc(this.uid).get();
                    if (doc.exists) {
                        this.state.gold = doc.data().gold || 0;
                    } else {
                        await this.db.collection('players').doc(this.uid).set({ gold: 0, name: this.tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫" });
                    }
                } catch (e) { console.error(e); }
            },

            async sync() {
                if (this.state.isSyncing || this.state.journal === 0) return;
                this.state.isSyncing = true;
                const toSync = this.state.journal;

                try {
                    await this.db.collection('players').doc(this.uid).update({
                        gold: firebase.firestore.FieldValue.increment(toSync)
                    });
                    this.state.journal -= toSync;
                    localStorage.setItem('locus_cache', this.state.journal);
                    
                    const doc = await this.db.collection('players').doc(this.uid).get();
                    this.state.gold = doc.data().gold;
                } catch (e) { } finally {
                    this.state.isSyncing = false;
                    this.render();
                }
            },

            loops() {
                setInterval(() => this.sync(), this.config.syncMs);
                window.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden') this.sync(); });
            },

            events() {
                const btn = document.getElementById('click-btn');
                const handle = (e) => {
                    e.preventDefault();
                    const x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    const y = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                    this.state.gold++;
                    this.state.journal++;
                    localStorage.setItem('locus_cache', this.state.journal);
                    
                    this.render();
                    this.vfx(x, y);
                    if (this.tg.HapticFeedback) this.tg.HapticFeedback.impactOccurred('medium');
                };
                btn.addEventListener('touchstart', handle, {passive: false});
            },

            render() {
                document.getElementById('gold-val').innerText = Math.floor(this.state.gold).toLocaleString();
                const wBtn = document.getElementById('withdraw-btn');
                if (this.state.gold >= this.config.min) {
                    wBtn.className = "btn btn-withdraw ready";
                    wBtn.innerText = "üí∞ –í–´–í–ï–°–¢–ò –í STANDOFF 2";
                } else {
                    wBtn.className = "btn btn-withdraw";
                    wBtn.innerText = `–ú–ò–ù. 750 (–ù–£–ñ–ù–û –ï–©–ï ${Math.ceil(this.config.min - this.state.gold)})`;
                }
            },

            vfx(x, y) {
                const el = document.createElement('div');
                el.className = 'tap-vfx';
                el.innerText = '+1';
                el.style.left = `${x - 20}px`;
                el.style.top = `${y - 40}px`;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 600);
            },

            // –í–´–í–û–î STANDOFF 2
            async startWithdraw() {
                if (this.state.gold < this.config.min) return;

                const id = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à ID Standoff 2 (8-9 —Ü–∏—Ñ—Ä):");
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å ID Standoff 2
                if (!id || id.length < 8 || id.length > 9 || isNaN(id)) {
                    this.tg.showAlert("–û—à–∏–±–∫–∞! ID Standoff 2 –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç 8 –¥–æ 9 —Ü–∏—Ñ—Ä.");
                    return;
                }

                this.tg.showConfirm(`–í—ã–≤–µ—Å—Ç–∏ ${Math.floor(this.state.gold)} G –Ω–∞ ID: ${id}?`, async (ok) => {
                    if (ok) {
                        try {
                            const amount = Math.floor(this.state.gold);
                            const request = {
                                standoffId: id,
                                amount: amount,
                                status: '–û–∂–∏–¥–∞–Ω–∏–µ',
                                date: new Date().toLocaleString(),
                                userId: this.uid,
                                username: this.tg.initDataUnsafe?.user?.username || "N/A"
                            };

                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–ª—è –∞–¥–º–∏–Ω–∞
                            await this.db.collection('withdrawals').add(request);
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–∏—á–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –∏–≥—Ä–æ–∫–∞
                            await this.db.collection('players').doc(this.uid).collection('history').add(request);

                            // –°–±—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞
                            this.state.gold = 0;
                            this.state.journal = 0;
                            await this.db.collection('players').doc(this.uid).update({ gold: 0 });

                            this.render();
                            this.loadHistory();
                            this.tg.showAlert("–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ –≤–∞—à ID.");
                        } catch (e) {
                            this.tg.showAlert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.");
                        }
                    }
                });
            },

            async loadHistory() {
                const box = document.getElementById('history-box');
                try {
                    const snap = await this.db.collection('players').doc(this.uid).collection('history').orderBy('date', 'desc').limit(5).get();
                    if (snap.empty) return;
                    box.innerHTML = "";
                    snap.forEach(doc => {
                        const d = doc.data();
                        box.innerHTML += `
                            <div class="list-item">
                                <div><b>${d.amount} G</b><br><small>ID: ${d.standoffId}</small></div>
                                <div class="status-badge">${d.status}</div>
                            </div>`;
                    });
                } catch (e) {}
            },

            setTab(id, el) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
                document.getElementById(`page-${id}`).classList.add('active');
                el.classList.add('active');
                if (id === 'withdraw') this.loadHistory();
            },

            invite() {
                const link = `https://t.me/Locus_Gold_bot/Locus_Gold?startapp=${this.uid}`;
                const el = document.createElement('textarea');
                el.value = link; document.body.appendChild(el); el.select();
                document.execCommand('copy'); document.body.removeChild(el);
                this.tg.showAlert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É.");
            },

            watchAd() {
                this.tg.showAlert("–†–µ–∫–ª–∞–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ. –ó–∞–π–¥–∏—Ç–µ –ø–æ–∑–∂–µ!");
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
