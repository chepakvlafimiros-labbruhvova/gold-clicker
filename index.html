<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Locus Gold Elite Pro</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        :root {
            --bg: #000000;
            --surface: #111112;
            --accent: #ff9d00;
            --error: #ff3b30;
            --text-dim: #8e8e93;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        
        body { 
            background: var(--bg); color: #fff; height: 100vh; overflow: hidden; 
            position: fixed; width: 100%; display: flex; flex-direction: column; 
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã */
        .app-container {
            position: absolute; inset: 0; display: none; flex-direction: column;
            padding: calc(var(--safe-top) + 15px) 15px calc(var(--safe-bottom) + 85px);
        }
        .app-container.active { display: flex; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –®–∞–ø–∫–∞ */
        .header { text-align: center; margin-bottom: 15px; }
        .gold-display { font-size: 48px; font-weight: 900; color: var(--accent); letter-spacing: -1px; }
        .rank-label { font-size: 10px; text-transform: uppercase; background: #222; padding: 3px 10px; border-radius: 12px; color: var(--accent); font-weight: 800; }

        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .stat-card { background: var(--surface); border-radius: 16px; padding: 12px; border: 1px solid #222; text-align: center; }
        .stat-card small { display: block; color: var(--text-dim); font-size: 9px; text-transform: uppercase; }
        .stat-card b { font-size: 16px; }

        /* –ö–ª–∏–∫–µ—Ä */
        .click-zone { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .coin {
            width: 220px; height: 220px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffc400, #ff8000);
            border: 10px solid #1a1a1c; box-shadow: 0 0 40px rgba(255,157,0,0.15);
            display: flex; align-items: center; justify-content: center;
            font-size: 80px; font-weight: 900; color: rgba(0,0,0,0.1);
            user-select: none; transition: transform 0.05s;
        }
        .coin:active { transform: scale(0.94); }

        .lock-mask { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            border-radius: 50%; border: 3px solid var(--error);
        }
        .lock-mask.active { display: flex; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-main { 
            background: var(--surface); border: 1px solid #27272a; border-radius: 18px; 
            padding: 16px 10px; text-align: center; color: #fff; cursor: pointer;
        }
        .btn-main b { display: block; font-size: 14px; margin-bottom: 2px; }
        .btn-main span { font-size: 9px; color: var(--accent); font-weight: 800; }
        .btn-wide { grid-column: span 2; border-color: var(--accent); }

        /* –ú–æ–¥–∞–ª–∫–∞ –ê–Ω—Ç–∏—á–∏—Ç–∞ */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; 
            display: none; align-items: center; justify-content: center; padding: 25px; 
        }
        .modal-content { background: #1c1c1e; padding: 30px; border-radius: 24px; text-align: center; border: 1px solid var(--error); width: 100%; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .tabs { 
            position: fixed; bottom: 0; width: 100%; height: calc(70px + var(--safe-bottom)); 
            background: #080808; border-top: 1px solid #1c1c1e; display: flex; padding-bottom: var(--safe-bottom);
        }
        .tab-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dim); border: none; background: none; }
        .tab-btn.active { color: var(--accent); }
        .tab-btn i { font-size: 22px; font-style: normal; margin-bottom: 3px; }
        .tab-btn span { font-size: 9px; font-weight: 700; text-transform: uppercase; }

        /* –°–ø–∏—Å–∫–∏ */
        .scroll-area { flex: 1; overflow-y: auto; margin-top: 15px; }
        .item-row { background: var(--surface); padding: 15px; border-radius: 15px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #222; }

        .f-pop { position: absolute; color: var(--accent); font-weight: 900; pointer-events: none; animation: fPop 0.6s ease-out forwards; font-size: 24px; z-index: 500; }
        @keyframes fPop { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }
    </style>
</head>
<body>

    <div class="modal-overlay" id="anticheat-modal">
        <div class="modal-content">
            <h2 style="color:var(--error); margin-bottom:10px;">–í–ù–ò–ú–ê–ù–ò–ï!</h2>
            <p style="font-size:14px; color:var(--text-dim); margin-bottom:20px;">–ê–≤—Ç–æ–∫–ª–∏–∫–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥.</p>
            <button class="btn-main btn-wide" id="ac-close-btn" style="background:var(--accent); color:#000;"><b>–•–û–†–û–®–û</b></button>
        </div>
    </div>

    <div class="app-container active" id="scr-mining">
        <div class="header">
            <span class="rank-label" id="rank-txt">BRONZE</span>
            <div class="gold-display" id="gold-txt">0.000</div>
            <div class="stats-row">
                <div class="stat-card"><small>–°–∏–ª–∞ –∫–ª–∏–∫–∞</small><b id="pwr-txt">0.001</b></div>
                <div class="stat-card"><small>–ú–æ–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</small><b id="ref-count-txt">0</b></div>
            </div>
        </div>
        <div class="click-zone">
            <div class="lock-mask" id="click-lock"><div style="font-size:40px; font-weight:900; color:var(--error)" id="lock-timer">5</div></div>
            <div class="coin" id="main-coin">G</div>
        </div>
        <div class="btn-grid">
            <div class="btn-main" id="ad-gold-btn"><i>üéÅ</i><b>–ë–æ–Ω—É—Å +5.0 G</b><span>–†–ï–ö–õ–ê–ú–ê</span></div>
            <div class="btn-main" id="ad-pwr-btn"><i>‚ö°</i><b>–°–∏–ª–∞ +0.005</b><span>–†–ï–ö–õ–ê–ú–ê</span></div>
            <div class="btn-main btn-wide" id="upgrade-btn"><b>–£–ª—É—á—à–∏—Ç—å –∑–∞ 1.000 G</b></div>
        </div>
    </div>

    <div class="app-container" id="scr-top">
        <h2 style="text-align:center;">–¢–æ–ø-50 –ò–≥—Ä–æ–∫–æ–≤</h2>
        <div class="scroll-area" id="top-list"></div>
    </div>

    <div class="app-container" id="scr-friends">
        <h2 style="text-align:center; margin-bottom:15px;">–†–µ—Ñ–µ—Ä–∞–ª—ã</h2>
        <div class="stat-card" style="margin-bottom:15px">
            <p style="font-size:14px">–ü–æ–ª—É—á–∞–π <b>+100 G</b> –∑–∞ –¥—Ä—É–≥–∞!</p>
            <button class="btn-main btn-wide" id="invite-btn" style="margin-top:10px; background:var(--accent); color:#000"><b>–ü–†–ò–ì–õ–ê–°–ò–¢–¨</b></button>
        </div>
        <div class="scroll-area" id="friend-list"></div>
    </div>

    <div class="app-container" id="scr-wallet">
        <h2 style="text-align:center; margin-bottom:15px;">–í—ã–≤–æ–¥</h2>
        <div class="stat-card">
            <p style="color:var(--text-dim); font-size:12px; margin-bottom:10px;">–ú–∏–Ω–∏–º—É–º –¥–ª—è –≤—ã–≤–æ–¥–∞: 750 G</p>
            <button class="btn-main btn-wide" id="withdraw-btn" style="opacity:0.3" disabled><b>–í–´–í–ï–°–¢–ò</b></button>
        </div>
        <div class="scroll-area" id="history-list"></div>
    </div>

    <nav class="tabs">
        <button class="tab-btn active" data-target="mining"><i>‚õèÔ∏è</i><span>–î–æ–±—ã—á–∞</span></button>
        <button class="tab-btn" data-target="top"><i>üèÜ</i><span>–¢–æ–ø-50</span></button>
        <button class="tab-btn" data-target="friends"><i>üë•</i><span>–î—Ä—É–∑—å—è</span></button>
        <button class="tab-btn" data-target="wallet"><i>üè¶</i><span>–í—ã–≤–æ–¥</span></button>
    </nav>

    <script>
    const App = {
        db: null, tg: window.Telegram.WebApp, uid: null,
        gold: 0, pwr: 0.001, journal: 0, 
        lastTaps: [], locked: false,

        async init() {
            this.tg.expand();
            this.uid = this.tg.initDataUnsafe?.user?.id?.toString() || "DEV_MODE";

            firebase.initializeApp({
                apiKey: "AIzaSyCoa29KS-sin6hoRz0ZbE4f3ki0tZLwkKI",
                projectId: "gold-clicker-5d882",
                appId: "1:83489312782:web:ee5b7bdc390e53e7dd6c5f"
            });
            this.db = firebase.firestore();

            const doc = await this.db.collection('players').doc(this.uid).get();
            if(doc.exists) {
                this.gold = doc.data().gold || 0;
                this.pwr = doc.data().pwr || 0.001;
            } else {
                await this.db.collection('players').doc(this.uid).set({
                    name: this.tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫",
                    gold: 0, pwr: 0.001, created: new Date()
                });
            }

            this.bindEvents();
            this.render();
            this.checkRef();
            setInterval(() => this.sync(), 8000);
        },

        bindEvents() {
            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            const listen = (id, fn) => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('touchend', (e) => { e.preventDefault(); fn(e); });
                    el.addEventListener('click', (e) => { fn(e); });
                }
            };

            listen('main-coin', (e) => this.handleTap(e));
            listen('ad-gold-btn', () => this.showAd('gold'));
            listen('ad-pwr-btn', () => this.showAd('pwr'));
            listen('upgrade-btn', () => this.upgrade());
            listen('invite-btn', () => this.invite());
            listen('withdraw-btn', () => this.withdraw());
            listen('ac-close-btn', () => document.getElementById('anticheat-modal').style.display = 'none');

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.app-container').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    const target = btn.getAttribute('data-target');
                    document.getElementById('scr-' + target).classList.add('active');
                    if(target === 'top') this.loadTop();
                    if(target === 'friends') this.loadFriends();
                    if(target === 'wallet') this.loadHistory();
                };
            });
        },

        handleTap(e) {
            if (this.locked) return;
            const now = Date.now();
            this.lastTaps.push(now);
            this.lastTaps = this.lastTaps.filter(t => now - t < 1000);

            if (this.lastTaps.length > 15) return this.triggerCheat();

            this.gold += this.pwr;
            this.journal += this.pwr;
            this.render();

            const pos = e.changedTouches ? e.changedTouches[0] : e;
            this.pop(pos.clientX, pos.clientY);
            if(this.tg.HapticFeedback) this.tg.HapticFeedback.impactOccurred('light');
        },

        triggerCheat() {
            this.locked = true;
            document.getElementById('anticheat-modal').style.display = 'flex';
            document.getElementById('click-lock').classList.add('active');
            let s = 5;
            const t = setInterval(() => {
                s--;
                document.getElementById('lock-timer').innerText = s;
                if(s <= 0) {
                    clearInterval(t);
                    this.locked = false;
                    document.getElementById('click-lock').classList.remove('active');
                    document.getElementById('lock-timer').innerText = "5";
                    this.lastTaps = [];
                }
            }, 1000);
        },

        showAd(type) {
            const ad = Adsgram.init({ blockId: "19895" });
            ad.show().then(() => {
                if(type === 'gold') this.gold += 5; else this.pwr += 0.005;
                this.sync(); this.render();
            }).catch(() => this.tg.showAlert("–†–µ–∫–ª–∞–º–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è..."));
        },

        async sync() {
            if (this.journal <= 0) return;
            const delta = this.journal;
            this.journal = 0;
            await this.db.collection('players').doc(this.uid).update({
                gold: firebase.firestore.FieldValue.increment(delta),
                pwr: this.pwr
            });
        },

        render() {
            document.getElementById('gold-txt').innerText = this.gold.toFixed(3);
            document.getElementById('pwr-txt').innerText = this.pwr.toFixed(3);
            
            let r = "BRONZE";
            if(this.gold > 100) r = "SILVER";
            if(this.gold > 500) r = "GOLD";
            if(this.gold > 1000) r = "ELITE";
            document.getElementById('rank-txt').innerText = r;

            const wBtn = document.getElementById('withdraw-btn');
            if(this.gold >= 750) {
                wBtn.disabled = false; wBtn.style.opacity = "1";
            }
        },

        pop(x, y) {
            const p = document.createElement('div');
            p.className = 'f-pop'; p.innerText = `+${this.pwr.toFixed(3)}`;
            p.style.left = x + 'px'; p.style.top = y + 'px';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 600);
        },

        async loadTop() {
            const l = document.getElementById('top-list');
            l.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            const snap = await this.db.collection('players').orderBy('gold', 'desc').limit(50).get();
            l.innerHTML = "";
            let i = 1;
            snap.forEach(doc => {
                l.innerHTML += `<div class="item-row"><b>${i++}. ${doc.data().name}</b><span>${Math.floor(doc.data().gold)} G</span></div>`;
            });
        },

        async loadFriends() {
            const l = document.getElementById('friend-list');
            const snap = await this.db.collection('players').doc(this.uid).collection('referrals').get();
            document.getElementById('ref-count-txt').innerText = snap.size;
            l.innerHTML = snap.empty ? "<center>–ù–µ—Ç –¥—Ä—É–∑–µ–π</center>" : "";
            snap.forEach(doc => {
                l.innerHTML += `<div class="item-row"><span>${doc.data().name}</span><b>+100 G</b></div>`;
            });
        },

        invite() {
            const link = `https://t.me/Locus_Gold_bot/app?startapp=${this.uid}`;
            this.tg.openTelegramLink(`https://t.me/share/url?url=${link}&text=–ó–∞–±–∏—Ä–∞–π+–≥–æ–ª–¥—É!`);
        },

        async withdraw() {
            const sid = prompt("ID Standoff 2:");
            if(!sid || sid.length < 5) return;
            await this.db.collection('withdrawals').add({ uid: this.uid, sid, amount: Math.floor(this.gold), date: new Date() });
            this.gold = 0; await this.db.collection('players').doc(this.uid).update({gold: 0});
            this.render(); this.tg.showAlert("–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!");
        }
    };

    window.onload = () => App.init();
    </script>
</body>
</html>
