<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nebula Core: Gold Foundry</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        :root {
            --p-color: #00d4ff;
            --gold: #ffcc00;
            --bg: #050608;
            --card: rgba(255, 255, 255, 0.04);
            --brd: rgba(255, 255, 255, 0.1);
            --safe: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: none; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; position: fixed; width: 100%; }

        #game-canvas { position: absolute; inset: 0; z-index: 5; pointer-events: none; }

        .app { position: relative; z-index: 10; display: flex; flex-direction: column; height: 100%; padding: 20px 20px calc(90px + var(--safe)); }

        /* –≠–∫–æ–Ω–æ–º–∏–∫–∞ */
        .header { text-align: center; margin-bottom: 10px; }
        .bal-main { font-size: 38px; font-weight: 900; color: #fff; display: block; }
        .gold-row { display: flex; justify-content: center; align-items: center; gap: 8px; color: var(--gold); font-weight: 800; font-size: 18px; margin-top: 5px; }

        /* –®–∫–∞–ª–∞ —É—Ä–æ–≤–Ω—è */
        .lvl-box { background: var(--card); border: 1px solid var(--brd); padding: 10px; border-radius: 15px; margin-top: 10px; }
        .lvl-info { display: flex; justify-content: space-between; font-size: 10px; font-weight: 800; color: var(--p-color); margin-bottom: 5px; }
        .bar-wrap { width: 100%; height: 6px; background: rgba(0,0,0,0.5); border-radius: 10px; overflow: hidden; border: 1px solid var(--brd); }
        .bar-fill { height: 100%; width: 100%; background: var(--p-color); transform-origin: left; transform: scaleX(0); transition: transform 0.2s linear; }

        /* –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ */
        .mine-zone { flex: 1; display: flex; align-items: center; justify-content: center; }
        .crystal { width: 200px; height: 200px; background: linear-gradient(135deg, var(--p-color), #0055ff); clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%); display: flex; align-items: center; justify-content: center; transition: transform 0.05s; }
        .crystal span { font-size: 70px; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5)); }

        /* –ö–Ω–æ–ø–∫–∏ */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .card { background: var(--card); border: 1px solid var(--brd); padding: 8px; border-radius: 12px; text-align: center; }
        .card b { display: block; font-size: 16px; }
        .card small { font-size: 9px; color: #555; }

        .btn-action { grid-column: span 2; padding: 14px; border-radius: 15px; border: none; background: linear-gradient(135deg, #ff9d00, #ff5e00); color: #fff; font-weight: 900; text-transform: uppercase; font-size: 12px; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(70px + var(--safe)); background: rgba(5,6,8,0.98); display: flex; border-top: 1px solid var(--brd); padding-bottom: var(--safe); z-index: 1000; }
        .nav-link { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #444; }
        .nav-link.active { color: var(--p-color); }
        .nav-link i { font-size: 20px; font-style: normal; }

        .screen { position: fixed; inset: 0; background: var(--bg); z-index: 500; display: none; padding: 25px 20px 100px; overflow-y: auto; }
        .screen.active { display: block; }
        .item { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--brd); }
        .upg-info b { display: block; font-size: 14px; }
        .upg-info small { color: #666; font-size: 11px; }
    </style>
</head>
<body>

    <canvas id="game-canvas"></canvas>

    <div class="app">
        <header class="header">
            <span class="bal-main" id="ui-bal">0</span>
            <div class="gold-row">
                <span>üí∞</span> <span id="ui-gold">0</span> <small style="font-size:10px; color:#555">SLOTS</small>
            </div>
            <div class="lvl-box">
                <div class="lvl-info"><span id="ui-lvl-name">–®–ê–•–¢–ï–†</span><span id="ui-lvl-num">–£–†. 1</span></div>
                <div class="bar-wrap"><div class="bar-fill" id="ui-bar"></div></div>
            </div>
        </header>

        <div class="mine-zone">
            <div class="crystal" id="crystal-node"><span>üíé</span></div>
        </div>

        <div class="grid">
            <div class="card"><small>–ö–ï–†–ù</small><b id="ui-pwr">1.0</b></div>
            <div class="card"><small>–ê–í–¢–û</small><b id="ui-dps">0.0</b></div>
            <button class="btn-action" id="ui-boost" onclick="Game.runAdBoost()">‚ö° –†–ï–ñ–ò–ú –Ø–†–û–°–¢–ò x3 (30—Å)</button>
        </div>
    </div>

    <div class="screen" id="scr-shop">
        <h2 style="margin-bottom:20px">–ú–∞–≥–∞–∑–∏–Ω –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h2>
        <div class="item" style="border: 1px solid var(--gold); background: rgba(255,204,0,0.05)" onclick="Game.runAdBoost()">
            <div class="upg-info">
                <b style="color:var(--gold)">–ö–≤–∞–Ω—Ç–æ–≤—ã–π —Å—Ç–∏–º—É–ª—è—Ç–æ—Ä</b>
                <small>–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –±—É—Å—Ç x3 –Ω–∞ 30 —Å–µ–∫</small>
            </div>
            <div style="font-weight:900; font-size:11px; color:var(--gold)">AD üì∫</div>
        </div>
        <div id="shop-list"></div>
    </div>

    <div class="screen" id="scr-market">
        <h2 style="margin-bottom:20px">–ü–ª–∞–≤–∏–ª—å–Ω—ã–π —Ü–µ—Ö</h2>
        <div class="item" style="flex-direction:column; gap:15px; text-align:center">
            <p style="font-size:13px; color:#888">–ü–µ—Ä–µ–ø–ª–∞–≤–∫–∞ 100,000 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –≤ 1 –∑–æ–ª–æ—Ç–æ–π —Å–ª–∏—Ç–æ–∫.</p>
            <div id="m-lock" style="color:#ff3b30; font-weight:900; font-size:12px">–¢–†–ï–ë–£–ï–¢–°–Ø 15 –£–†–û–í–ï–ù–¨</div>
            <div id="m-ui" style="display:none; width:100%">
                <button class="btn-action" style="width:100%; background:var(--gold); color:#000" onclick="Game.exchange()">–í–´–ü–õ–ê–í–ò–¢–¨ –°–õ–ò–¢–û–ö</button>
            </div>
        </div>
    </div>

    <div class="screen" id="scr-ref">
        <h2 style="margin-bottom:20px; text-align:center">–í–∞—à–∞ –ê—Ä—Ç–µ–ª—å</h2>
        <button class="btn-action" style="width:100%" onclick="Game.invite()">–ü–†–ò–ì–õ–ê–°–ò–¢–¨ –ù–ê–ü–ê–†–ù–ò–ö–ê</button>
    </div>

    <nav class="nav">
        <div class="nav-link active" onclick="UI.go('main', this)"><i>‚õèÔ∏è</i></div>
        <div class="nav-link" onclick="UI.go('shop', this)"><i>üõí</i></div>
        <div class="nav-link" onclick="UI.go('ref', this)"><i>üë•</i></div>
        <div class="nav-link" onclick="UI.go('market', this)"><i>üí∞</i></div>
    </nav>

    <script>
        // --- RENDER ENGINE ---
        const Renderer = {
            canvas: document.getElementById('game-canvas'),
            ctx: null, texts: [],
            init() {
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.onresize = () => this.resize();
                this.loop();
            },
            resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
            spawn(x, y, val) { this.texts.push({ x, y, val, life: 1 }); },
            loop() {
                this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
                this.ctx.font = "bold 26px sans-serif";
                for(let i=this.texts.length-1; i>=0; i--) {
                    let t = this.texts[i]; t.y -= 2; t.life -= 0.025;
                    this.ctx.fillStyle = `rgba(0, 212, 255, ${t.life})`;
                    this.ctx.fillText(t.val, t.x, t.y);
                    if(t.life <= 0) this.texts.splice(i, 1);
                }
                requestAnimationFrame(() => this.loop());
            }
        };

        // --- AUDIO ---
        const Ambience = {
            ctx: null, started: false,
            init() {
                if(this.started) return;
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.type = 'sine'; o.frequency.setValueAtTime(80, this.ctx.currentTime);
                g.gain.setValueAtTime(0.01, this.ctx.currentTime);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); this.started = true;
            }
        };

        // --- GAME ---
        const Game = {
            d: { bal: 0, gold: 0, pwr: 1, dps: 0, xp: 0, lvl: 1, mult: 1, u: [0,0,0,0] },
            shop: [
                { n: "–†—É—á–Ω–∞—è –∫–∏—Ä–∫–∞", p: 150, b: 0.8, t: 'pwr' },
                { n: "–ê–≤—Ç–æ-–¥—Ä–µ–ª—å", p: 800, b: 2.5, t: 'dps' },
                { n: "–ü–ª–∞–∑–º–µ–Ω–Ω—ã–π —Ä–µ–∑–∞–∫", p: 5000, b: 10, t: 'pwr' },
                { n: "–®–∞—Ö—Ç–Ω—ã–π –∫–æ–º–±–∞–π–Ω", p: 25000, b: 60, t: 'dps' }
            ],

            init() {
                this.load();
                Renderer.init();
                const node = document.getElementById('crystal-node');
                node.addEventListener('touchstart', (e) => {
                    e.preventDefault(); Ambience.init();
                    for(let t of e.changedTouches) this.tap(t.clientX, t.clientY);
                });
                setInterval(() => this.tick(), 100);
                this.upd();
            },

            tap(x, y) {
                const gain = this.d.pwr * this.d.mult;
                this.d.bal += gain; this.d.xp += 15;
                this.lvl(); Renderer.spawn(x, y, `+${gain.toFixed(1)}`);
                if(window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.impactOccurred('light');
                document.getElementById('crystal-node').style.transform = 'scale(0.95)';
                setTimeout(()=>document.getElementById('crystal-node').style.transform='scale(1)', 50);
            },

            tick() { if(this.d.dps > 0) this.d.bal += this.d.dps / 10; this.upd(); },

            lvl() {
                const req = this.d.lvl * 1500;
                if(this.d.xp >= req) { this.d.xp = 0; this.d.lvl++; this.save(); }
            },

            upd() {
                document.getElementById('ui-bal').innerText = Math.floor(this.d.bal).toLocaleString();
                document.getElementById('ui-gold').innerText = this.d.gold.toLocaleString();
                document.getElementById('ui-pwr').innerText = (this.d.pwr * this.d.mult).toFixed(1);
                document.getElementById('ui-dps').innerText = this.d.dps.toFixed(1);
                document.getElementById('ui-lvl-num').innerText = `–£–†. ${this.d.lvl}`;
                const req = this.d.lvl * 1500;
                document.getElementById('ui-bar').style.transform = `scaleX(${Math.min(this.d.xp/req, 1)})`;
                if(this.d.lvl >= 15) { document.getElementById('m-lock').style.display='none'; document.getElementById('m-ui').style.display='block'; }
            },

            exchange() {
                if(this.d.bal >= 100000) {
                    this.d.bal -= 100000; this.d.gold += 1; this.save();
                    Telegram.WebApp.showPopup({ title: "–£—Å–ø–µ—Ö", message: "–°–ª–∏—Ç–æ–∫ –≤—ã–ø–ª–∞–≤–ª–µ–Ω!" });
                } else { Telegram.WebApp.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ (–Ω—É–∂–Ω–æ 100,000)"); }
            },

            runAdBoost() {
                const start = () => {
                    this.d.mult = 3; document.getElementById('ui-boost').disabled = true;
                    let s = 30;
                    const itv = setInterval(() => {
                        s--; document.getElementById('ui-boost').innerText = `–Ø–†–û–°–¢–¨: ${s}—Å`;
                        if(s <= 0) { clearInterval(itv); this.d.mult = 1; document.getElementById('ui-boost').disabled = false; document.getElementById('ui-boost').innerText = `‚ö° –†–ï–ñ–ò–ú –Ø–†–û–°–¢–ò x3 (30—Å)`; }
                    }, 1000);
                };
                if(window.Adsgram) Adsgram.init({ blockId: "19895" }).show().then(start).catch(start); else start();
            },

            buy(i) {
                const itm = this.shop[i];
                const cost = Math.floor(itm.p * Math.pow(1.65, this.d.u[i]));
                if(this.d.bal >= cost) {
                    this.d.bal -= cost; this.d.u[i]++;
                    if(itm.t === 'pwr') this.d.pwr += itm.b; else this.d.dps += itm.b;
                    UI.drawShop(); this.save();
                }
            },

            invite() {
                const uid = Telegram.WebApp.initDataUnsafe?.user?.id || "0";
                const url = `https://t.me/YOUR_BOT_NAME/app?startapp=${uid}`;
                Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${url}&text=–í—Å—Ç—É–ø–∞–π –≤ –º–æ—é –∞—Ä—Ç–µ–ª—å!`);
            },

            save() { localStorage.setItem('nebula_foundry_v1', JSON.stringify(this.d)); },
            load() { const s = localStorage.getItem('nebula_foundry_v1'); if(s) this.d = {...this.d, ...JSON.parse(s)}; }
        };

        const UI = {
            go(id, el) {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                el.classList.add('active');
                if(id !== 'main') { document.getElementById('scr-'+id).classList.add('active'); if(id === 'shop') this.drawShop(); }
            },
            drawShop() {
                document.getElementById('shop-list').innerHTML = Game.shop.map((itm, i) => {
                    const cost = Math.floor(itm.p * Math.pow(1.65, Game.d.u[i]));
                    return `<div class="item" onclick="Game.buy(${i})">
                        <div class="upg-info"><b>${itm.n}</b><small>+${itm.b} –∫ –≤—ã—Ä–∞–±–æ—Ç–∫–µ</small></div>
                        <div style="font-weight:900; font-size:13px">${cost.toLocaleString()} üíé</div>
                    </div>`;
                }).join('');
            }
        };

        window.onload = () => Game.init();
    </script>
</body>
</html>
