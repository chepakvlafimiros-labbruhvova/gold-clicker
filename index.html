<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nebula Core: Deep Mine</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        :root {
            --p-color: #00d4ff;
            --p-deep: #0055ff;
            --gold: #ffcc00;
            --bg: #050608;
            --card: rgba(255, 255, 255, 0.04);
            --brd: rgba(255, 255, 255, 0.1);
            --safe: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: none; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; position: fixed; width: 100%; }

        /* Canvas —Å–ª–æ–π –¥–ª—è —á–∞—Å—Ç–∏—Ü –∏ —Ç–µ–∫—Å—Ç–∞ (–º–∞–∫—Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å) */
        #game-canvas { position: absolute; inset: 0; z-index: 5; pointer-events: none; }

        .app { position: relative; z-index: 10; display: flex; flex-direction: column; height: 100%; padding: 20px 20px calc(90px + var(--safe)); }

        /* Header */
        .header { text-align: center; margin-bottom: 15px; }
        .bal-val { font-size: 54px; font-weight: 900; background: linear-gradient(#fff, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 15px rgba(0,212,255,0.4)); }
        
        /* Progress Bar */
        .lvl-box { background: var(--card); border: 1px solid var(--brd); padding: 12px; border-radius: 18px; backdrop-filter: blur(10px); margin-top: 10px; }
        .lvl-info { display: flex; justify-content: space-between; font-size: 11px; font-weight: 800; color: var(--p-color); margin-bottom: 6px; }
        .bar-wrap { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 10px; overflow: hidden; border: 1px solid var(--brd); }
        .bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--p-deep), var(--p-color)); box-shadow: 0 0 15px var(--p-color); transition: width 0.4s ease-out; }

        /* Crystal Area */
        .mine-zone { flex: 1; display: flex; align-items: center; justify-content: center; }
        .crystal { 
            width: 230px; height: 230px; 
            background: linear-gradient(135deg, var(--p-color), var(--p-deep));
            clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.05s;
            position: relative;
        }
        .crystal span { font-size: 85px; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.4)); }

        /* Controls */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: var(--card); border: 1px solid var(--brd); padding: 12px; border-radius: 15px; text-align: center; }
        .card small { font-size: 9px; color: rgba(255,255,255,0.3); text-transform: uppercase; display: block; }
        .card b { font-size: 18px; }

        .btn-action { 
            grid-column: span 2; padding: 16px; border-radius: 18px; border: none;
            background: linear-gradient(135deg, #ff9d00, #ff5e00);
            color: #fff; font-weight: 900; font-size: 13px; text-transform: uppercase;
            box-shadow: 0 6px 20px rgba(255, 94, 0, 0.2);
        }
        .btn-action:disabled { opacity: 0.4; filter: grayscale(1); }

        /* Nav */
        .nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(75px + var(--safe)); background: rgba(5,6,8,0.95); backdrop-filter: blur(10px); display: flex; border-top: 1px solid var(--brd); padding-bottom: var(--safe); z-index: 1000; }
        .nav-link { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; text-decoration: none; }
        .nav-link.active { color: var(--p-color); }
        .nav-link i { font-size: 22px; font-style: normal; margin-bottom: 2px; }
        .nav-link span { font-size: 9px; font-weight: 800; text-transform: uppercase; }

        /* Screens */
        .screen { position: fixed; inset: 0; background: var(--bg); z-index: 500; display: none; padding: 25px 20px 100px; overflow-y: auto; }
        .screen.active { display: block; }
        .upgrade-item { background: var(--card); padding: 16px; border-radius: 18px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--brd); }
        .upg-meta h4 { font-size: 15px; color: #fff; }
        .upg-meta p { font-size: 11px; color: #666; }
        .price-tag { background: #fff; color: #000; padding: 6px 12px; border-radius: 8px; font-weight: 900; font-size: 13px; }

        .ref-box { background: var(--card); border: 2px dashed var(--brd); padding: 20px; border-radius: 20px; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

    <canvas id="game-canvas"></canvas>

    <div class="app">
        <header class="header">
            <div class="bal-val" id="ui-bal">0</div>
            <div class="lvl-box">
                <div class="lvl-info">
                    <span id="ui-lvl-name">–®–∞—Ö—Ç–µ—Ä-—Å—Ç–∞–∂–µ—Ä</span>
                    <span id="ui-lvl-num">–£–†. 1</span>
                </div>
                <div class="bar-wrap"><div class="bar-fill" id="ui-bar"></div></div>
            </div>
        </header>

        <main class="mine-zone">
            <div class="crystal" id="crystal-node"><span>üíé</span></div>
        </main>

        <footer class="grid">
            <div class="card"><small>–ö–µ—Ä–Ω</small><b id="ui-pwr">1.0</b></div>
            <div class="card"><small>–ê–≤—Ç–æ-—Å–±–æ—Ä</small><b id="ui-dps">0.0</b></div>
            <button class="btn-action" id="ui-boost" onclick="Game.runAd()">üöÄ –§–û–†–°–ê–ñ x3 (–†–ï–ö–õ–ê–ú–ê)</button>
        </footer>
    </div>

    <div class="screen" id="scr-shop">
        <h2 style="margin-bottom:20px; text-align:center">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h2>
        <div id="shop-list"></div>
    </div>

    <div class="screen" id="scr-ref">
        <h2 style="margin-bottom:20px; text-align:center">–ê—Ä—Ç–µ–ª—å</h2>
        <div class="ref-box">
            <p style="color:#888; margin-bottom:15px; font-size:14px">–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –∑–∞–±–∏—Ä–∞–π—Ç–µ 20% –æ—Ç –∏—Ö –æ–±—â–µ–π –≤—ã—Ä–∞–±–æ—Ç–∫–∏!</p>
            <button class="btn-action" onclick="Game.invite()">–ü–†–ò–ì–õ–ê–°–ò–¢–¨ –ù–ê–ü–ê–†–ù–ò–ö–ê</button>
        </div>
        <div id="ref-status" style="margin-top:20px; color:var(--p-color); font-weight:bold; text-align:center"></div>
    </div>

    <div class="screen" id="scr-market">
        <h2 style="margin-bottom:20px; text-align:center">–°–±—ã—Ç —Ä–µ—Å—É—Ä—Å–æ–≤</h2>
        <div class="upgrade-item" style="flex-direction:column; gap:15px; text-align:center">
            <p>–í—ã–≤–æ–¥ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –≤ —ç–∫–æ—Å–∏—Å—Ç–µ–º—É —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏.</p>
            <div id="m-lock" style="color:#ff3b30; font-weight:900">–ù–£–ñ–ï–ù 15 –£–†–û–í–ï–ù–¨</div>
            <button id="m-btn" style="display:none; width:100%; padding:15px; border:none; border-radius:12px; background:var(--p-color); font-weight:900" onclick="Game.market()">–û–ë–ú–ï–ù–Ø–¢–¨ 1000 üíé</button>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-link active" onclick="UI.go('main', this)"><i>‚õèÔ∏è</i><span>–î–æ–±—ã—á–∞</span></div>
        <div class="nav-link" onclick="UI.go('shop', this)"><i>‚öôÔ∏è</i><span>–ú–∞–≥–∞–∑–∏–Ω</span></div>
        <div class="nav-link" onclick="UI.go('ref', this)"><i>üë•</i><span>–ê—Ä—Ç–µ–ª—å</span></div>
        <div class="nav-link" onclick="UI.go('market', this)"><i>üåå</i><span>–ú–∞—Ä–∫–µ—Ç</span></div>
    </nav>

    <script>
        // --- SOUND ENGINE ---
        const AudioEngine = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            lastTap: 0,
            pitch: 400,
            playTap() {
                const now = Date.now();
                const delta = now - this.lastTap;
                // –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ –∫–ª–∏–∫, —Ç–µ–º –≤—ã—à–µ –∑–≤—É–∫ (Pitch Shift)
                this.pitch = delta < 100 ? Math.min(this.pitch + 20, 1000) : 400;
                this.lastTap = now;

                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(this.pitch, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.1);
            }
        };

        // --- CANVAS RENDERER (–î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ª–∞–≥–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–∞—Ö) ---
        const Renderer = {
            canvas: document.getElementById('game-canvas'),
            ctx: null,
            particles: [],
            texts: [],
            init() {
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.onresize = () => this.resize();
                this.loop();
            },
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },
            spawn(x, y, val, color) {
                this.texts.push({ x, y, val, opacity: 1, vy: -2 });
                for(let i=0; i<6; i++) {
                    this.particles.push({
                        x, y, 
                        vx: (Math.random()-0.5)*8, 
                        vy: (Math.random()-0.5)*8, 
                        life: 1, c: color
                    });
                }
            },
            loop() {
                this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
                // –¢–µ–∫—Å—Ç—ã
                this.texts.forEach((t, i) => {
                    t.y += t.vy; t.opacity -= 0.02;
                    this.ctx.fillStyle = `rgba(255,255,255,${t.opacity})`;
                    this.ctx.font = `bold 24px Inter`;
                    this.ctx.fillText(t.val, t.x - 10, t.y);
                    if(t.opacity <= 0) this.texts.splice(i, 1);
                });
                // –ß–∞—Å—Ç–∏—Ü—ã
                this.particles.forEach((p, i) => {
                    p.x += p.vx; p.y += p.vy; p.life -= 0.03;
                    this.ctx.fillStyle = p.c;
                    this.ctx.globalAlpha = p.life;
                    this.ctx.fillRect(p.x, p.y, 3, 3);
                    if(p.life <= 0) this.particles.splice(i, 1);
                });
                requestAnimationFrame(() => this.loop());
            }
        };

        // --- GAME LOGIC ---
        const Game = {
            state: { bal: 0, pwr: 1, dps: 0, xp: 0, lvl: 1, mult: 1, u: [0,0,0,0] },
            shop: [
                { n: "–†—Ç—É—Ç–Ω—ã–µ –ø–æ—Ä—à–Ω–∏", d: "+0.5 –∑–∞ –∫–ª–∏–∫", b: 0.5, p: 100, t: 'pwr' },
                { n: "–£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–æ–π –±—É—Ä", d: "+2.0 –∑–∞ –∫–ª–∏–∫", b: 2, p: 1000, t: 'pwr' },
                { n: "–î—Ä–æ–Ω—ã-—Ä–∞–∑–≤–µ–¥—á–∏–∫–∏", d: "+1.5/—Å–µ–∫ –∞–≤—Ç–æ", b: 1.5, p: 500, t: 'dps' },
                { n: "–ì–ª—É–±–∏–Ω–Ω–∞—è –ø–æ–º–ø–∞", d: "+10.0/—Å–µ–∫ –∞–≤—Ç–æ", b: 10, p: 4000, t: 'dps' }
            ],
            ranks: ["–ß–µ—Ä–Ω–æ—Ä–∞–±–æ—á–∏–π", "–ó–∞–±–æ–π—â–∏–∫", "–ë—Ä–∏–≥–∞–¥–∏—Ä", "–¢–µ—Ö–Ω–æ-–º–∞–≥", "–ú–∞—Å—Ç–µ—Ä —è–¥—Ä–∞", "–õ–µ–≥–µ–Ω–¥–∞ —à–∞—Ö—Ç"],
            
            init() {
                this.load();
                Renderer.init();
                
                const node = document.getElementById('crystal-node');
                node.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    for(let t of e.changedTouches) this.handleTap(t.clientX, t.clientY);
                });

                setInterval(() => { if(this.state.dps > 0) { this.state.bal += this.state.dps/10; this.render(); } }, 100);
                setInterval(() => this.save(), 5000);
                this.render();
            },

            handleTap(x, y) {
                const val = this.state.pwr * this.state.mult;
                this.state.bal += val;
                this.state.xp += 10;
                
                this.checkLvl();
                this.render();
                Renderer.spawn(x, y, `+${val.toFixed(1)}`, this.state.mult > 1 ? '#ffcc00' : '#00d4ff');
                AudioEngine.playTap();

                document.getElementById('crystal-node').style.transform = 'scale(0.94)';
                setTimeout(() => document.getElementById('crystal-node').style.transform = 'scale(1)', 40);
                
                if(window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.impactOccurred('light');
            },

            checkLvl() {
                const goal = this.state.lvl * 1000;
                if(this.state.xp >= goal) {
                    this.state.xp = 0;
                    this.state.lvl++;
                    Telegram.WebApp.showAlert(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í–∞—à –Ω–æ–≤—ã–π —á–∏–Ω: ${this.ranks[this.state.lvl-1] || "–≠–ª–∏—Ç–∞"}`);
                }
            },

            buy(i) {
                const itm = this.shop[i];
                const cost = Math.floor(itm.p * Math.pow(1.6, this.state.u[i]));
                if(this.state.bal >= cost) {
                    this.state.bal -= cost;
                    this.state.u[i]++;
                    if(itm.t === 'pwr') this.state.pwr += itm.b; else this.state.dps += itm.b;
                    this.render(); UI.drawShop(); this.save();
                    if(window.Telegram) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                } else {
                    Telegram.WebApp.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ –∫–∞–∑–Ω–µ!");
                }
            },

            runAd() {
                const btn = document.getElementById('ui-boost');
                const start = () => {
                    this.state.mult = 3;
                    btn.disabled = true;
                    let s = 30;
                    const timer = setInterval(() => {
                        s--; btn.innerText = `–§–û–†–°–ê–ñ x3: ${s}—Å`;
                        if(s <= 0) {
                            clearInterval(timer); this.state.mult = 1; btn.disabled = false;
                            btn.innerText = `üöÄ –§–û–†–°–ê–ñ x3 (–†–ï–ö–õ–ê–ú–ê)`;
                        }
                    }, 1000);
                };
                if(window.Adsgram) {
                    Adsgram.init({ blockId: "19895" }).show().then(start).catch(start);
                } else start();
            },

            render() {
                document.getElementById('ui-bal').innerText = Math.floor(this.state.bal).toLocaleString();
                document.getElementById('ui-pwr').innerText = (this.state.pwr * this.state.mult).toFixed(1);
                document.getElementById('ui-dps').innerText = this.state.dps.toFixed(1);
                document.getElementById('ui-lvl-num').innerText = `–£–†. ${this.state.lvl}`;
                document.getElementById('ui-lvl-name').innerText = this.ranks[Math.min(this.state.lvl-1, 5)];
                
                const goal = this.state.lvl * 1000;
                document.getElementById('ui-bar').style.width = (this.state.xp/goal*100) + "%";
                
                if(this.state.lvl >= 15) {
                    document.getElementById('m-lock').style.display = 'none';
                    document.getElementById('m-btn').style.display = 'block';
                }
            },

            invite() {
                const uid = Telegram.WebApp.initDataUnsafe?.user?.id || "miner";
                const link = `https://t.me/Locus_Gold_bot/app?startapp=${uid}`;
                Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${link}&text=–í—Å—Ç—É–ø–∞–π –≤ –º–æ—é –∞—Ä—Ç–µ–ª—å! –î–æ–±—ã–≤–∞–µ–º –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –≤–º–µ—Å—Ç–µ.`);
            },

            save() { localStorage.setItem('nebula_core_save_v5', JSON.stringify(this.state)); },
            load() { 
                const s = localStorage.getItem('nebula_core_save_v5'); 
                if(s) this.state = {...this.state, ...JSON.parse(s)}; 
            },
            market() {
                const res = prompt("–í–≤–µ–¥–∏—Ç–µ ID –∫–æ—à–µ–ª—å–∫–∞:");
                if(res && this.state.bal >= 1000) {
                    this.state.bal -= 1000; this.render(); this.save();
                    alert("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ!");
                }
            }
        };

        const UI = {
            go(id, el) {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                el.classList.add('active');
                if(id !== 'main') {
                    document.getElementById('scr-' + id).classList.add('active');
                    if(id === 'shop') this.drawShop();
                }
            },
            drawShop() {
                const container = document.getElementById('shop-list');
                container.innerHTML = Game.shop.map((itm, i) => {
                    const cost = Math.floor(itm.p * Math.pow(1.6, Game.state.u[i]));
                    return `
                        <div class="upgrade-item" onclick="Game.buy(${i})">
                            <div class="upg-meta">
                                <h4>${itm.n}</h4>
                                <p>${itm.d} (–£—Ä. ${Game.state.u[i]})</p>
                            </div>
                            <div class="price-tag">${cost} üíé</div>
                        </div>
                    `;
                }).join('');
            }
        };

        window.onload = () => Game.init();
    </script>
</body>
</html>
