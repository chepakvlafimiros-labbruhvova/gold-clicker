<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Locus Gold: Official Drop</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        :root {
            --accent: #00d4ff; --gold: #ffcc00; --bg: #050505;
            --card: rgba(255, 255, 255, 0.07); --brd: rgba(255, 255, 255, 0.12);
            --safe: env(safe-area-inset-bottom);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; position: fixed; width: 100%; }
        
        .app { display: flex; flex-direction: column; height: 100%; padding: 20px 20px calc(95px + var(--safe)); z-index: 10; position: relative; }
        
        /* –ë–∞–ª–∞–Ω—Å */
        .bal-wrap { text-align: center; margin-bottom: 20px; transition: all 0.3s; }
        .bal-val { font-size: 58px; font-weight: 900; color: #fff; text-shadow: 0 0 20px rgba(0,212,255,0.4); }
        .gold-val { color: var(--gold); font-size: 26px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* –ó–æ–Ω–∞ –∫–ª–∏–∫–∞ */
        .click-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .crystal { 
            width: 230px; height: 230px; background: radial-gradient(circle at 30% 30%, var(--accent), #0033ff);
            clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%);
            display: flex; align-items: center; justify-content: center; transition: transform 0.05s;
            box-shadow: 0 0 50px rgba(0, 211, 255, 0.3); z-index: 5;
        }
        .crystal:active { transform: scale(0.92); }
        .crystal img { width: 100px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); }

        /* –ú–∞–ª–µ–Ω—å–∫–∞—è –∫–Ω–æ–ø–∫–∞ –±–æ–Ω—É—Å–∞ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞) */
        #mini-bonus {
            margin-top: 30px; background: rgba(255, 204, 0, 0.1); border: 1.5px solid var(--gold);
            padding: 10px 20px; border-radius: 50px; display: none; align-items: center; gap: 10px;
            cursor: pointer; z-index: 20; backdrop-filter: blur(5px);
            animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        #mini-bonus span { font-size: 14px; font-weight: 800; color: var(--gold); }

        /* –ò–Ω—Ñ–æ-–ø–∞–Ω–µ–ª–∏ */
        .stats-box { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-top: 10px; }
        .stat-card { background: var(--card); border: 1px solid var(--brd); padding: 18px; border-radius: 24px; text-align: center; }
        .stat-card b { display: block; font-size: 22px; color: var(--accent); }
        .stat-card small { font-size: 12px; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { position: fixed; bottom: 0; width: 100%; height: calc(85px + var(--safe)); background: rgba(10,10,10,0.95); border-top: 1px solid var(--brd); display: flex; padding-bottom: var(--safe); z-index: 1000; backdrop-filter: blur(10px); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; transition: 0.2s; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 24px; font-style: normal; margin-bottom: 5px; }
        .nav-item span { font-size: 12px; font-weight: 700; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { position: fixed; inset: 0; background: var(--bg); padding: 40px 25px 120px; display: none; overflow-y: auto; flex-direction: column; z-index: 500; }
        .screen.active { display: flex; }
        .screen-title { font-size: 28px; font-weight: 900; margin-bottom: 25px; border-left: 5px solid var(--accent); padding-left: 15px; }

        .btn-action { width: 100%; padding: 20px; border-radius: 20px; border: none; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.2s; color: #fff; }
        .btn-action:active { transform: scale(0.97); }
        .btn-main { background: linear-gradient(135deg, #ff9d00, #ff5e00); box-shadow: 0 5px 15px rgba(255,94,0,0.3); }
        .btn-alt { background: var(--accent); box-shadow: 0 5px 15px rgba(0,212,255,0.3); }

        .item-card { background: var(--card); border: 1px solid var(--brd); padding: 22px; border-radius: 25px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .item-card:active { background: rgba(255,255,255,0.1); }
        .item-info b { font-size: 18px; display: block; }
        .item-info small { color: var(--accent); font-weight: 600; }

        #fx-layer { position: absolute; inset: 0; pointer-events: none; z-index: 100; }
    </style>
</head>
<body>
    <canvas id="fx-layer"></canvas>

    <div class="app">
        <div class="bal-wrap">
            <div class="bal-val" id="main-bal">0</div>
            <div class="gold-val">üí∞ <span id="gold-bal">0</span></div>
        </div>

        <div class="click-area">
            <div class="crystal" id="tap-target">
                <img src="https://cdn-icons-png.flaticon.com/512/3203/3203925.png">
            </div>
            
            <div id="mini-bonus">
                <span>üéÅ –ë–û–ù–£–°: +<span id="bonus-amount">5000</span></span>
                <b id="bonus-timer" style="color:#ff3b30; margin-left:5px">10—Å</b>
            </div>
        </div>

        <div class="stats-box">
            <div class="stat-card">
                <small>–ú–æ—â–Ω–æ—Å—Ç—å</small>
                <b id="pwr-display">1.0</b>
            </div>
            <div class="stat-card">
                <small>–£—Ä–æ–≤–µ–Ω—å</small>
                <b id="lvl-display">1</b>
            </div>
        </div>
    </div>

    <div class="screen" id="scr-shop">
        <div class="screen-title">–ú–∞–≥–∞–∑–∏–Ω</div>
        <button class="btn-action btn-alt" style="margin-bottom:25px" onclick="GameCore.showAd('boost')">üöÄ –§–û–†–°–ê–ñ X3 (30 –°–ï–ö)</button>
        <div id="shop-items-list"></div>
    </div>

    <div class="screen" id="scr-market">
        <div class="screen-title">–û–±–º–µ–Ω</div>
        <div class="item-card" style="flex-direction:column; text-align:center; gap:20px; background: rgba(255,204,0,0.05); border-color: var(--gold);">
            <p style="font-size: 18px; font-weight: 700;">100,000 üíé = 1 üí∞</p>
            <button class="btn-action btn-main" onclick="GameCore.doExchange()">–û–ë–ú–ï–ù–Ø–¢–¨</button>
            <p style="font-size:12px; opacity:0.6;">–ü—Ä–∏ –æ–±–º–µ–Ω–µ —É—Ä–æ–≤–µ–Ω—å –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è!</p>
        </div>

        <div id="withdraw-container" style="display:none; margin-top:30px;">
            <div class="screen-title" style="border-color: #00ff88;">–í—ã–≤–æ–¥</div>
            <div class="item-card" style="border-color: #00ff88; background: rgba(0,255,136,0.05);">
                <div class="item-info">
                    <b>–î–æ—Å—Ç—É–ø–Ω–æ –∫ –≤—ã–≤–æ–¥—É</b>
                    <small style="color:#00ff88">–ü—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–æ—à–µ–ª–µ–∫</small>
                </div>
                <button class="btn-action btn-alt" style="width:auto; padding:12px 25px; background:#00ff88;" onclick="GameCore.doWithdraw()">–í–´–í–ï–°–¢–ò</button>
            </div>
        </div>
    </div>

    <div class="screen" id="scr-friends">
        <div class="screen-title">–î—Ä—É–∑—å—è</div>
        <div class="item-card" style="margin-top:20px; text-align:center; flex-direction:column; gap:20px;">
            <p>–ü–æ–ª—É—á–∞–π—Ç–µ <span style="color:var(--accent); font-weight:900;">20%</span> –æ—Ç –¥–æ—Ö–æ–¥–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞!</p>
            <button class="btn-action btn-alt" onclick="GameCore.invite()">–ü–†–ò–ì–õ–ê–°–ò–¢–¨</button>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" data-tab="main"><i>‚õèÔ∏è</i><span>–î–æ–±—ã—á–∞</span></div>
        <div class="nav-item" data-tab="shop"><i>üõí</i><span>–ú–∞–≥–∞–∑–∏–Ω</span></div>
        <div class="nav-item" data-tab="market"><i>üí∞</i><span>–û–±–º–µ–Ω</span></div>
        <div class="nav-item" data-tab="friends"><i>üë•</i><span>–î—Ä—É–∑—å—è</span></div>
    </nav>

    <script>
    /**
     * LOCUS GOLD ENGINE v6.0 - DROP READY
     * –ê–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–∞–≤–∫–∏: –§–∏–∫—Å 0.0, Deep Save, –†–∞–±–æ—Ç–∞—é—â–∏–µ –∫–Ω–æ–ø–∫–∏
     */
    const GameCore = {
        db: null, tg: window.Telegram.WebApp, uid: null,
        
        // –ñ–µ—Å—Ç–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è 0.0
        data: {
            bal: 0.0,
            gold: 0,
            pwr: 1.0, // –ë–∞–∑–æ–≤—ã–π –∫–ª–∏–∫
            lvl: 1,
            xp: 0,
            upg: [0,0,0,0],
            mult: 1.0,
            lastSave: Date.now()
        },

        shop: [
            { n: "–ö–∏—Ä–∫–∞ –ù–æ–≤–∏—á–∫–∞", p: 150, b: 0.5 },
            { n: "–î—Ä–µ–ª—å Nebula", p: 1500, b: 2.5 },
            { n: "–ü–ª–∞–∑–º–∞-–ì–∞–Ω", p: 12000, b: 12.0 },
            { n: "–û—Ä–±–∏—Ç–∞–ª—å–Ω—ã–π –ë—É—Ä", p: 85000, b: 65.0 }
        ],

        isBonusLive: false,
        bonusTimer: 0,

        async init() {
            this.tg.expand();
            this.tg.ready();
            this.uid = this.tg.initDataUnsafe?.user?.id?.toString() || "DEBUG_PLAYER";

            // Firebase
            firebase.initializeApp({
                apiKey: "AIzaSyCoa29KS-sin6hoRz0ZbE4f3ki0tZLwkKI",
                projectId: "gold-clicker-5d882",
                appId: "1:83489312782:web:ee5b7bdc390e53e7dd6c5f"
            });
            this.db = firebase.firestore();

            await this.loadProgress();
            this.setupListeners();
            
            // –¶–∏–∫–ª—ã
            setInterval(() => this.cloudSave(), 20000);
            setInterval(() => this.processBonusLogic(), 1000);
            setInterval(() => { if(UI.current === 'main') this.triggerBonus(); }, 45000);
            
            Visuals.init();
            this.renderFrame();
        },

        async loadProgress() {
            // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º LocalStorage
            const local = localStorage.getItem('locus_gold_v6_' + this.uid);
            if(local) {
                const parsed = JSON.parse(local);
                if(parsed.pwr < 1.0) parsed.pwr = 1.0; // –§–∏–∫—Å –±–∞–≥–æ–≤ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
                this.data = {...this.data, ...parsed};
            }

            // 2. –ó–∞—Ç–µ–º Firebase (Deep Merge)
            try {
                const doc = await this.db.collection('players').doc(this.uid).get();
                if(doc.exists) {
                    const cloud = doc.data();
                    // –ë–µ—Ä–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
                    this.data.gold = Math.max(this.data.gold, cloud.gold || 0);
                    this.data.bal = Math.max(this.data.bal, cloud.bal || 0);
                    this.data.lvl = Math.max(this.data.lvl, cloud.lvl || 1);
                    if(cloud.pwr > this.data.pwr) this.data.pwr = cloud.pwr;
                    if(cloud.upg) this.data.upg = cloud.upg;
                }
            } catch(e) { console.warn("Firebase Load Error", e); }
        },

        setupListeners() {
            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    UI.switch(btn.dataset.tab, btn);
                });
            });

            // –ö–ª–∏–∫ –ø–æ –∫—Ä–∏—Å—Ç–∞–ª–ª—É
            document.getElementById('tap-target').addEventListener('click', (e) => {
                this.handleTap(e);
            });

            // –ë–æ–Ω—É—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞
            document.getElementById('mini-bonus').addEventListener('click', () => {
                this.claimBonus();
            });
        },

        handleTap(e) {
            const gain = parseFloat(this.data.pwr) * parseFloat(this.data.mult);
            this.data.bal += gain;
            this.data.xp += 15;

            Visuals.spawn(e.clientX, e.clientY, `+${gain.toFixed(1)}`);
            if(this.tg.HapticFeedback) this.tg.HapticFeedback.impactOccurred('light');

            // –£—Ä–æ–≤–Ω–∏
            const needed = this.data.lvl * 1500;
            if(this.data.xp >= needed) {
                this.data.xp = 0;
                this.data.lvl++;
                this.tg.HapticFeedback?.notificationOccurred('success');
            }
        },

        triggerBonus() {
            if(this.isBonusLive) return;
            const amount = Math.floor(5000 + (this.data.bal * 0.15));
            document.getElementById('bonus-amount').innerText = amount.toLocaleString();
            this.bonusTimer = 10;
            this.isBonusLive = true;
            document.getElementById('mini-bonus').style.display = 'flex';
        },

        processBonusLogic() {
            if(this.isBonusLive) {
                this.bonusTimer--;
                document.getElementById('bonus-timer').innerText = this.bonusTimer + '—Å';
                if(this.bonusTimer <= 0) {
                    this.isBonusLive = false;
                    document.getElementById('mini-bonus').style.display = 'none';
                }
            }
        },

        claimBonus() {
            const ad = Adsgram.init({ blockId: "19969" });
            ad.show().then(() => {
                const amount = Math.floor(5000 + (this.data.bal * 0.15));
                this.data.bal += amount;
                this.isBonusLive = false;
                document.getElementById('mini-bonus').style.display = 'none';
                this.cloudSave();
            }).catch(() => { this.tg.showAlert("–†–µ–∫–ª–∞–º–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞"); });
        },

        showAd(type) {
            const ad = Adsgram.init({ blockId: "19969" });
            ad.show().then(() => {
                if(type === 'boost') {
                    this.data.mult = 3.0;
                    setTimeout(() => { this.data.mult = 1.0; }, 30000);
                    this.tg.showAlert("–§–û–†–°–ê–ñ x3 –í–ö–õ–Æ–ß–ï–ù!");
                }
                this.cloudSave();
            });
        },

        doExchange() {
            if(this.data.bal >= 100000) {
                this.data.bal -= 100000;
                this.data.gold += 1;
                this.data.upg = [0,0,0,0];
                this.data.pwr = 1.0;
                this.data.lvl = 1;
                this.data.xp = 0;
                this.cloudSave();
                this.tg.showAlert("–°–ª–∏—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω! –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã.");
                UI.drawShop();
            } else {
                this.tg.showAlert("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 100,000 üíé");
            }
        },

        doWithdraw() {
            this.tg.showPopup({
                title: "–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤",
                message: `–£ –≤–∞—Å ${this.data.gold} üí∞. –ñ–µ–ª–∞–µ—Ç–µ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å –±–æ—Ç–∞?`,
                buttons: [{id: 'send', type: 'default', text: '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É'}]
            }, (btn) => {
                if(btn === 'send') this.tg.showAlert("–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –û–∂–∏–¥–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏.");
            });
        },

        renderFrame() {
            document.getElementById('main-bal').innerText = Math.floor(this.data.bal).toLocaleString();
            document.getElementById('gold-bal').innerText = this.data.gold;
            document.getElementById('pwr-display').innerText = (this.data.pwr * this.data.mult).toFixed(1);
            document.getElementById('lvl-display').innerText = this.data.lvl;

            // –ö–Ω–æ–ø–∫–∞ –≤—ã–≤–æ–¥–∞
            document.getElementById('withdraw-container').style.display = this.data.gold >= 1 ? 'block' : 'none';

            requestAnimationFrame(() => this.renderFrame());
        },

        cloudSave() {
            this.data.lastSave = Date.now();
            const payload = JSON.parse(JSON.stringify(this.data));
            localStorage.setItem('locus_gold_v6_' + this.uid, JSON.stringify(payload));
            this.db.collection('players').doc(this.uid).set(payload, {merge: true}).catch(e => {});
        },

        buy(i) {
            const itm = this.shop[i];
            const cost = Math.floor(itm.p * Math.pow(1.9, this.data.upg[i]));
            if(this.data.bal >= cost) {
                this.data.bal -= cost;
                this.data.upg[i]++;
                this.data.pwr = parseFloat(this.data.pwr) + itm.b;
                this.cloudSave();
                UI.drawShop();
            } else {
                this.tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤!");
            }
        },

        invite() {
            const link = `https://t.me/Locus_Gold_bot/app?startapp=${this.uid}`;
            this.tg.openTelegramLink(`https://t.me/share/url?url=${link}&text=–ü–æ–º–æ–≥–∏ –º–Ω–µ –¥–æ–±—ã—Ç—å –∑–æ–ª–æ—Ç–æ –≤ Locus!`);
        }
    };

    const UI = {
        current: 'main',
        switch(id, el) {
            this.current = id;
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
            if(id !== 'main') {
                const screen = document.getElementById('scr-' + id);
                if(screen) screen.classList.add('active');
                if(id === 'shop') this.drawShop();
            }
        },
        drawShop() {
            const container = document.getElementById('shop-items-list');
            container.innerHTML = GameCore.shop.map((item, i) => {
                const cost = Math.floor(item.p * Math.pow(1.9, GameCore.data.upg[i]));
                return `
                <div class="item-card" onclick="GameCore.buy(${i})">
                    <div class="item-info">
                        <b>${item.n} [${GameCore.data.upg[i]}]</b>
                        <small>+${item.b} –∫ –∫–ª–∏–∫—É</small>
                    </div>
                    <div style="font-weight:900; color:var(--gold)">${cost.toLocaleString()} üíé</div>
                </div>`;
            }).join('');
        }
    };

    const Visuals = {
        canvas: document.getElementById('fx-layer'),
        ctx: null,
        pops: [],
        init() {
            this.ctx = this.canvas.getContext('2d');
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
            this.loop();
        },
        spawn(x, y, txt) {
            this.pops.push({ x, y, txt, a: 1.0, v: 2 });
        },
        loop() {
            this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
            this.ctx.font = "bold 26px Inter";
            for(let i=this.pops.length-1; i>=0; i--) {
                const p = this.pops[i];
                p.y -= p.v; p.a -= 0.02;
                this.ctx.fillStyle = `rgba(0, 212, 255, ${p.a})`;
                this.ctx.fillText(p.txt, p.x - 20, p.y);
                if(p.a <= 0) this.pops.splice(i, 1);
            }
            requestAnimationFrame(() => this.loop());
        }
    };

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≤—ã–ª–µ—Ç–æ–≤
    window.onerror = function() { return true; };

    window.onload = () => GameCore.init();
    </script>
</body>
</html>
