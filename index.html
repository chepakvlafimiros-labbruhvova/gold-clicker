<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Locus Gold: Nebula Engine v5</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        :root {
            --accent: #00d4ff; --gold: #ffcc00; --bg: #050505;
            --card: rgba(255, 255, 255, 0.05); --brd: rgba(255, 255, 255, 0.1);
            --safe: env(safe-area-inset-bottom);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; position: fixed; width: 100%; }
        
        /* –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω */
        .app { display: flex; flex-direction: column; height: 100%; padding: 20px 20px calc(90px + var(--safe)); z-index: 10; position: relative; }
        .bal-wrap { text-align: center; margin-bottom: 20px; }
        .bal-val { font-size: 56px; font-weight: 900; color: #fff; line-height: 1; }
        .gold-val { color: var(--gold); font-size: 24px; font-weight: 800; margin-top: 5px; }

        /* –ö—Ä–∏—Å—Ç–∞–ª–ª */
        .click-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .crystal { 
            width: 210px; height: 210px; background: radial-gradient(circle at 30% 30%, var(--accent), #0033ff);
            clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%);
            display: flex; align-items: center; justify-content: center; transition: transform 0.1s;
            box-shadow: 0 0 40px rgba(0, 211, 255, 0.2);
        }
        .crystal:active { transform: scale(0.94); }
        .crystal img { width: 90px; }

        /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –±–æ–Ω—É—Å–∞ */
        #mini-bonus {
            margin-top: 25px; background: rgba(255, 204, 0, 0.15); border: 1px solid var(--gold);
            padding: 8px 16px; border-radius: 30px; display: none; align-items: center; gap: 8px;
            animation: pulse 2s infinite; cursor: pointer;
        }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        #mini-bonus span { font-size: 13px; font-weight: 800; color: var(--gold); }

        /* –°—Ç–∞—Ç—ã */
        .stats-box { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        .stat-card { background: var(--card); border: 1px solid var(--brd); padding: 15px; border-radius: 20px; text-align: center; }
        .stat-card b { display: block; font-size: 20px; color: var(--accent); }
        .stat-card small { font-size: 11px; opacity: 0.5; text-transform: uppercase; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { position: fixed; bottom: 0; width: 100%; height: calc(80px + var(--safe)); background: #0a0a0a; border-top: 1px solid var(--brd); display: flex; padding-bottom: var(--safe); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 22px; font-style: normal; margin-bottom: 4px; }
        .nav-item span { font-size: 11px; font-weight: 700; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { position: fixed; inset: 0; background: var(--bg); padding: 30px 20px 100px; display: none; overflow-y: auto; flex-direction: column; z-index: 50; }
        .screen.active { display: flex; }
        .btn-action { width: 100%; padding: 18px; border-radius: 20px; border: none; font-weight: 900; text-transform: uppercase; cursor: pointer; background: linear-gradient(135deg, #ff9d00, #ff5e00); color: #fff; }
        .item-card { background: var(--card); border: 1px solid var(--brd); padding: 20px; border-radius: 22px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }

        /* –ö–∞–Ω–≤–∞—Å —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ */
        #fx-layer { position: absolute; inset: 0; pointer-events: none; z-index: 100; }
    </style>
</head>
<body>
    <canvas id="fx-layer"></canvas>

    <div class="app">
        <div class="bal-wrap">
            <div class="bal-val" id="main-bal">0</div>
            <div class="gold-val">üí∞ <span id="gold-bal">0</span></div>
        </div>

        <div class="click-area">
            <div class="crystal" id="tap-target">
                <img src="https://cdn-icons-png.flaticon.com/512/3203/3203925.png">
            </div>
            
            <div id="mini-bonus" onclick="Core.claimBonus()">
                <span>üéÅ –ë–û–ù–£–°: +<span id="bonus-val">5000</span> üíé</span>
                <small id="bonus-timer" style="color:#ff3b30">10—Å</small>
            </div>
        </div>

        <div class="stats-box">
            <div class="stat-card"><small>–ú–û–©–ù–û–°–¢–¨</small><b id="pwr-val">1.0</b></div>
            <div class="stat-card"><small>–£–†–û–í–ï–ù–¨</small><b id="lvl-val">1</b></div>
        </div>
    </div>

    <div class="screen" id="scr-shop">
        <h2 style="margin-bottom:20px">–£–ª—É—á—à–µ–Ω–∏—è Nebula</h2>
        <button class="btn-action" style="background:var(--accent); margin-bottom:20px" onclick="Core.watchAd('boost')">üöÄ –§–û–†–°–ê–ñ X3 (30 —Å–µ–∫)</button>
        <div id="shop-list"></div>
    </div>

    <div class="screen" id="scr-market">
        <h2 style="margin-bottom:20px">–û–±–º–µ–Ω –∏ –í—ã–≤–æ–¥</h2>
        <div class="item-card" style="flex-direction:column; text-align:center; gap:15px">
            <p>100,000 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ ‚ûî 1 –∑–æ–ª–æ—Ç–æ–π —Å–ª–∏—Ç–æ–∫</p>
            <button class="btn-action" id="btn-exchange" onclick="Core.exchange()">–û–±–º–µ–Ω—è—Ç—å</button>
            <p style="font-size:11px; color:#ff3b30">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –æ–±–º–µ–Ω–µ!</p>
        </div>

        <div id="withdraw-section" style="display:none; margin-top:20px">
            <div class="item-card" style="border-color:var(--gold); background:rgba(255,204,0,0.05)">
                <div style="flex:1">
                    <b style="color:var(--gold)">–î–û–°–¢–£–ü–ï–ù –í–´–í–û–î</b><br>
                    <small>–í—ã –º–æ–∂–µ—Ç–µ –≤—ã–≤–µ—Å—Ç–∏ –≤–∞—à–∏ —Å–ª–∏—Ç–∫–∏</small>
                </div>
                <button class="btn-action" style="width:auto; padding:10px 20px" onclick="Core.withdraw()">–í—ã–≤–µ—Å—Ç–∏</button>
            </div>
        </div>
    </div>

    <div class="screen" id="scr-friends">
        <h2>–ê—Ä—Ç–µ–ª—å</h2>
        <p style="margin:20px 0; opacity:0.7">–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ 20% –æ—Ç –∏—Ö –¥–æ–±—ã—á–∏.</p>
        <button class="btn-action" onclick="Core.shareLink()">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="UI.tab('main', this)"><i>‚õèÔ∏è</i><span>–î–æ–±—ã—á–∞</span></div>
        <div class="nav-item" onclick="UI.tab('shop', this)"><i>üõí</i><span>–ú–∞–≥–∞–∑–∏–Ω</span></div>
        <div class="nav-item" onclick="UI.tab('market', this)"><i>üí∞</i><span>–û–±–º–µ–Ω</span></div>
        <div class="nav-item" onclick="UI.tab('friends', this)"><i>üë•</i><span>–î—Ä—É–∑—å—è</span></div>
    </nav>

    <script>
    /**
     * CORE ENGINE v5
     * –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
     */
    const Core = {
        db: null, tg: window.Telegram.WebApp, uid: null,
        user: { bal: 0, gold: 0, pwr: 1.0, lvl: 1, xp: 0, u: [0,0,0,0], mult: 1 },
        shop: [
            { n: "–ö–∏—Ä–∫–∞ –ö–≤–∞—Ä—Ü–∞", p: 150, b: 0.5 },
            { n: "–ü–∞—Ä–æ–≤–æ–π –ë—É—Ä", p: 1200, b: 2.0 },
            { n: "–õ–∞–∑–µ—Ä–Ω—ã–π –†–µ–∑–∞–∫", p: 9000, b: 10.0 },
            { n: "–ò–ò-–°–±–æ—Ä—â–∏–∫", p: 55000, b: 50.0 }
        ],
        bonusActive: false, bonusTime: 0,

        async init() {
            this.tg.expand();
            this.uid = this.tg.initDataUnsafe?.user?.id?.toString() || "DEV_TEST";
            
            // Firebase Init
            firebase.initializeApp({
                apiKey: "AIzaSyCoa29KS-sin6hoRz0ZbE4f3ki0tZLwkKI",
                projectId: "gold-clicker-5d882",
                appId: "1:83489312782:web:ee5b7bdc390e53e7dd6c5f"
            });
            this.db = firebase.firestore();

            // Load Data
            const cache = localStorage.getItem('nebula_v5_cache_' + this.uid);
            if(cache) this.user = JSON.parse(cache);

            try {
                const doc = await this.db.collection('players').doc(this.uid).get();
                if(doc.exists) {
                    const cloud = doc.data();
                    if(cloud.gold >= this.user.gold) this.user = {...this.user, ...cloud};
                }
            } catch(e) { console.log("Cloud offline"); }

            // Start Loops
            FX.init();
            document.getElementById('tap-target').onclick = (e) => this.tap(e);
            setInterval(() => this.save(), 15000);
            setInterval(() => this.logicTick(), 1000);
            setInterval(() => this.spawnBonus(), 40000);
            
            this.render();
        },

        tap(e) {
            const val = this.user.pwr * this.user.mult;
            this.user.bal += val;
            this.user.xp += 10;
            FX.pop(e.clientX, e.clientY, `+${val.toFixed(1)}`);
            if(this.tg.HapticFeedback) this.tg.HapticFeedback.impactOccurred('medium');
            
            // Leveling
            if(this.user.xp >= (this.user.lvl * 1000)) {
                this.user.xp = 0;
                this.user.lvl++;
            }
        },

        spawnBonus() {
            if(UI.activeTab !== 'main') return;
            const amount = Math.floor(5000 + (this.user.bal * 0.1));
            document.getElementById('bonus-val').innerText = amount.toLocaleString();
            this.bonusTime = 10;
            this.bonusActive = true;
            document.getElementById('mini-bonus').style.display = 'flex';
        },

        claimBonus() {
            const ad = Adsgram.init({ blockId: "19969" });
            ad.show().then(() => {
                const amount = Math.floor(5000 + (this.user.bal * 0.1));
                this.user.bal += amount;
                this.bonusActive = false;
                document.getElementById('mini-bonus').style.display = 'none';
                this.save();
            }).catch(() => { this.tg.showAlert("–†–µ–∫–ª–∞–º–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞"); });
        },

        logicTick() {
            if(this.bonusActive) {
                this.bonusTime--;
                document.getElementById('bonus-timer').innerText = this.bonusTime + '—Å';
                if(this.bonusTime <= 0) {
                    this.bonusActive = false;
                    document.getElementById('mini-bonus').style.display = 'none';
                }
            }
        },

        watchAd(type) {
            const ad = Adsgram.init({ blockId: "19969" });
            ad.show().then(() => {
                if(type === 'boost') {
                    this.user.mult = 3;
                    setTimeout(() => { this.user.mult = 1; }, 30000);
                    this.tg.showAlert("–§–æ—Ä—Å–∞–∂ x3 –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!");
                }
                this.save();
            });
        },

        exchange() {
            if(this.user.bal >= 100000) {
                this.user.bal -= 100000;
                this.user.gold += 1;
                // –°–±—Ä–æ—Å —É–ª—É—á—à–µ–Ω–∏–π
                this.user.u = [0,0,0,0];
                this.user.pwr = 1.0;
                this.tg.showAlert("–û–±–º–µ–Ω —É—Å–ø–µ—à–µ–Ω! –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã.");
                this.save();
                UI.renderShop();
            } else {
                this.tg.showAlert("–ù—É–∂–Ω–æ 100,000 üíé");
            }
        },

        withdraw() {
            this.tg.showPopup({
                title: "–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤",
                message: `–£ –≤–∞—Å ${this.user.gold} üí∞. –ñ–µ–ª–∞–µ—Ç–µ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É?`,
                buttons: [{id: 'ok', type: 'default', text: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å'}]
            });
        },

        render() {
            document.getElementById('main-bal').innerText = Math.floor(this.user.bal).toLocaleString();
            document.getElementById('gold-bal').innerText = this.user.gold;
            document.getElementById('pwr-val').innerText = (this.user.pwr * this.user.mult).toFixed(1);
            document.getElementById('lvl-val').innerText = this.user.lvl;

            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–Ω–æ–ø–∫–∞ –≤—ã–≤–æ–¥–∞
            document.getElementById('withdraw-section').style.display = this.user.gold >= 1 ? 'block' : 'none';

            requestAnimationFrame(() => this.render());
        },

        async save() {
            localStorage.setItem('nebula_v5_cache_' + this.uid, JSON.stringify(this.user));
            try {
                await this.db.collection('players').doc(this.uid).set(this.user, {merge: true});
            } catch(e) {}
        },

        buy(i) {
            const itm = this.shop[i];
            const price = Math.floor(itm.p * Math.pow(1.8, this.user.u[i]));
            if(this.user.bal >= price) {
                this.user.bal -= price;
                this.user.u[i]++;
                this.user.pwr += itm.b;
                this.save();
                UI.renderShop();
            }
        },

        shareLink() {
            const link = `https://t.me/Locus_Gold_bot/app?startapp=${this.uid}`;
            this.tg.openTelegramLink(`https://t.me/share/url?url=${link}&text=–î–æ–±—ã–≤–∞–π –∑–æ–ª–æ—Ç–æ —Å–æ –º–Ω–æ–π!`);
        }
    };

    const UI = {
        activeTab: 'main',
        tab(id, el) {
            this.activeTab = id;
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
            if(id !== 'main') {
                document.getElementById('scr-' + id).classList.add('active');
                if(id === 'shop') this.renderShop();
            }
        },
        renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = Core.shop.map((itm, i) => {
                const price = Math.floor(itm.p * Math.pow(1.8, Core.user.u[i]));
                return `
                <div class="item-card" onclick="Core.buy(${i})">
                    <div>
                        <b>${itm.n} <small>(Lvl ${Core.user.u[i]})</small></b><br>
                        <small>+${itm.b} –∫ –∫–ª–∏–∫—É</small>
                    </div>
                    <div style="font-weight:900">${price.toLocaleString()} üíé</div>
                </div>`;
            }).join('');
        }
    };

    const FX = {
        c: document.getElementById('fx-layer'), ctx: null, items: [],
        init() {
            this.ctx = this.c.getContext('2d');
            this.resize();
            window.onresize = () => this.resize();
            this.loop();
        },
        resize() { this.c.width = window.innerWidth; this.c.height = window.innerHeight; },
        pop(x, y, text) { this.items.push({ x, y, text, a: 1, s: 20 }); },
        loop() {
            this.ctx.clearRect(0, 0, this.c.width, this.c.height);
            this.ctx.font = "bold 24px sans-serif";
            for(let i = this.items.length-1; i >= 0; i--) {
                let p = this.items[i];
                p.y -= 2; p.a -= 0.02;
                this.ctx.fillStyle = `rgba(0, 212, 255, ${p.a})`;
                this.ctx.fillText(p.text, p.x - 20, p.y);
                if(p.a <= 0) this.items.splice(i, 1);
            }
            requestAnimationFrame(() => this.loop());
        }
    };

    window.onload = () => Core.init();
    </script>
</body>
</html>
