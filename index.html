<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Locus Gold | Standoff 2 Elite</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --accent: #ff9d00;
            --accent-dark: #cc7e00;
            --bg: #0a0a0b;
            --surface: #151517;
            --surface-light: #1c1c1f;
            --text: #ffffff;
            --text-dim: #8e8e93;
            --success: #34c759;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* –ì–û–†–Ø–ß–ò–ô –î–ò–ó–ê–ô–ù –ë–ê–õ–ê–ù–°–ê */
        .header {
            padding: 45px 20px 25px;
            background: linear-gradient(180deg, #1a1a1c 0%, var(--bg) 100%);
            text-align: center; border-bottom: 1px solid #222;
        }

        .score-title { font-size: 11px; font-weight: 800; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; }
        .score-value { font-size: 54px; font-weight: 900; text-shadow: 0 0 25px rgba(255,157,0,0.3); }

        /* –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ */
        .viewport { flex: 1; position: relative; }
        .page { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; padding: 20px; }
        .page.active { display: flex; }

        /* –ö–õ–ò–ö–ï–† */
        .clicker-box { flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        .coin {
            width: 250px; height: 250px; border-radius: 50%;
            background: radial-gradient(circle, #fbc02d 0%, #f57f17 100%);
            border: 8px solid var(--surface-light);
            display: flex; align-items: center; justify-content: center;
            font-size: 110px; font-weight: 900; color: rgba(0,0,0,0.5);
            box-shadow: 0 0 50px rgba(245, 127, 23, 0.2);
            transition: transform 0.05s; cursor: pointer;
        }
        .coin:active { transform: scale(0.92); }

        /* –ö–ù–û–ü–ö–ò */
        .action-list { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 12px; }
        .btn {
            width: 100%; padding: 18px; border-radius: 14px; border: none;
            font-size: 16px; font-weight: 700; color: white; transition: 0.2s;
        }
        .btn-main { background: var(--accent); }
        .btn-sec { background: var(--surface-light); }
        .btn-withdraw { background: #222; color: #555; pointer-events: none; }
        .btn-withdraw.active { background: var(--success); color: black; pointer-events: auto; }

        /* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–í–û–î–ê ID */
        #withdraw-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            z-index: 1000; display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: var(--surface); width: 100%; max-width: 350px;
            padding: 30px; border-radius: 24px; border: 1px solid var(--accent);
            text-align: center;
        }
        .modal-title { margin-bottom: 20px; font-size: 18px; font-weight: 800; }
        .id-input {
            width: 100%; background: var(--bg); border: 2px solid #333;
            padding: 15px; border-radius: 12px; color: white; font-size: 20px;
            text-align: center; margin-bottom: 20px; outline: none;
        }
        .id-input:focus { border-color: var(--accent); }

        /* –ò–°–¢–û–†–ò–Ø */
        .history-box { width: 100%; margin-top: 20px; background: var(--surface); border-radius: 16px; overflow: hidden; }
        .history-item { padding: 15px 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .status-wait { color: var(--accent); font-size: 12px; font-weight: 700; text-transform: uppercase; }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .nav { height: 85px; background: var(--surface); border-top: 1px solid #222; display: flex; }
        .nav-tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dim); }
        .nav-tab.active { color: var(--accent); }
        .nav-tab span { font-size: 10px; font-weight: 700; margin-top: 4px; }

        .tap-vfx { position: absolute; color: var(--accent); font-weight: 900; pointer-events: none; animation: tapUp 0.6s ease-out forwards; }
        @keyframes tapUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }
    </style>
</head>
<body>

    <header class="header">
        <div class="score-title">–ó–æ–ª–æ—Ç–æ Locus</div>
        <div id="balance" class="score-value">0</div>
    </header>

    <div class="viewport">
        <div id="page-main" class="page active">
            <div class="clicker-box">
                <div id="coin-trigger" class="coin">G</div>
            </div>
            <div style="font-size: 12px; color: #444;">ID –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: <span id="user-id-display">...</span></div>
        </div>

        <div id="page-bonus" class="page">
            <div class="action-list">
                <button class="btn btn-main" onclick="App.watchAd()">üì∫ –°–ú–û–¢–†–ï–¢–¨ –†–ï–ö–õ–ê–ú–£ (+10 G)</button>
                <button class="btn btn-sec" onclick="App.copyLink()">üîó –ü–†–ò–ì–õ–ê–°–ò–¢–¨ –î–†–£–ì–ê</button>
            </div>
        </div>

        <div id="page-withdraw" class="page">
            <div class="action-list">
                <button id="withdraw-init-btn" class="btn btn-withdraw" onclick="App.openModal()">üè¶ –í–´–í–ï–°–¢–ò –í STANDOFF 2</button>
            </div>
            <div class="history-box" id="history-container">
                <div style="padding: 20px; text-align: center; color: #555;">–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç –ø—É—Å—Ç–∞</div>
            </div>
        </div>
    </div>

    <div id="withdraw-modal">
        <div class="modal-content">
            <div class="modal-title">–í–´–í–û–î –°–†–ï–î–°–¢–í</div>
            <p style="font-size: 13px; color: #888; margin-bottom: 15px;">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∏–≥—Ä–æ–≤–æ–π ID Standoff 2 (8-9 —Ü–∏—Ñ—Ä)</p>
            <input type="number" id="id-input-field" class="id-input" placeholder="12345678">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-sec" style="padding: 12px;" onclick="App.closeModal()">–û–¢–ú–ï–ù–ê</button>
                <button class="btn btn-main" style="padding: 12px; flex: 1;" onclick="App.confirmWithdraw()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-tab active" onclick="App.switchPage('main', this)">üéÆ<span>–ò–ì–†–ê–¢–¨</span></div>
        <div class="nav-tab" onclick="App.switchPage('bonus', this)">üíé<span>–ë–û–ù–£–°–´</span></div>
        <div class="nav-tab" onclick="App.switchPage('withdraw', this)">üè¶<span>–í–´–í–û–î</span></div>
    </nav>

    <script>
        const App = {
            db: null,
            tg: window.Telegram.WebApp,
            uid: null,
            
            state: { gold: 0, journal: 0, isSyncing: false },
            config: { min: 750, syncInterval: 2500 },

            async init() {
                this.tg.expand();
                this.uid = this.tg.initDataUnsafe?.user?.id?.toString() || "DEV_TEST_USER";
                document.getElementById('user-id-display').innerText = this.uid;

                // Firebase
                const config = {
                    apiKey: "AIzaSyCoa29KS-sin6hoRz0ZbE4f3ki0tZLwkKI",
                    authDomain: "gold-clicker-5d882.firebaseapp.com",
                    projectId: "gold-clicker-5d882",
                    storageBucket: "gold-clicker-5d882.firebasestorage.app",
                    messagingSenderId: "83489312782",
                    appId: "1:83489312782:web:ee5b7bdc390e53e7dd6c5f"
                };

                if (!firebase.apps.length) firebase.initializeApp(config);
                this.db = firebase.firestore();

                await this.loadData();
                this.startLoops();
                this.bindEvents();
                this.render();
            },

            async loadData() {
                try {
                    const doc = await this.db.collection('players').doc(this.uid).get();
                    if (doc.exists) {
                        this.state.gold = doc.data().gold || 0;
                    } else {
                        await this.db.collection('players').doc(this.uid).set({ 
                            gold: 0, 
                            username: this.tg.initDataUnsafe?.user?.username || "Unknown" 
                        });
                    }
                } catch (e) { console.error("Load Error:", e); }
            },

            async sync() {
                if (this.state.journal === 0 || this.state.isSyncing) return;
                this.state.isSyncing = true;
                const toAdd = this.state.journal;

                try {
                    await this.db.collection('players').doc(this.uid).update({
                        gold: firebase.firestore.FieldValue.increment(toAdd)
                    });
                    this.state.journal -= toAdd;
                    const updatedDoc = await this.db.collection('players').doc(this.uid).get();
                    this.state.gold = updatedDoc.data().gold;
                } catch (e) { console.error("Sync Error:", e); }
                finally { this.state.isSyncing = false; this.render(); }
            },

            startLoops() {
                setInterval(() => this.sync(), this.config.syncInterval);
            },

            bindEvents() {
                const coin = document.getElementById('coin-trigger');
                coin.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.state.gold += 1;
                    this.state.journal += 1;
                    this.render();
                    this.spawnVFX(e.touches[0].clientX, e.touches[0].clientY);
                    if (this.tg.HapticFeedback) this.tg.HapticFeedback.impactOccurred('light');
                });
            },

            render() {
                document.getElementById('balance').innerText = Math.floor(this.state.gold).toLocaleString();
                const btn = document.getElementById('withdraw-init-btn');
                if (this.state.gold >= this.config.min) {
                    btn.className = "btn btn-withdraw active";
                    btn.innerText = "üè¶ –í–´–í–ï–°–¢–ò –í STANDOFF 2";
                } else {
                    btn.className = "btn btn-withdraw";
                    btn.innerText = `–ù–£–ñ–ù–û –ï–©–ï ${Math.ceil(this.config.min - this.state.gold)} G`;
                }
            },

            spawnVFX(x, y) {
                const v = document.createElement('div');
                v.className = 'tap-vfx'; v.innerText = '+1';
                v.style.left = x + 'px'; v.style.top = y + 'px';
                document.body.appendChild(v);
                setTimeout(() => v.remove(), 600);
            },

            // –ú–û–î–ê–õ–ö–ê –í–´–í–û–î–ê
            openModal() { document.getElementById('withdraw-modal').style.display = 'flex'; },
            closeModal() { document.getElementById('withdraw-modal').style.display = 'none'; },

            async confirmWithdraw() {
                const standoffId = document.getElementById('id-input-field').value;
                if (!standoffId || standoffId.length < 8 || standoffId.length > 9) {
                    this.tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID Standoff 2 (8-9 —Ü–∏—Ñ—Ä)!");
                    return;
                }

                try {
                    const amount = Math.floor(this.state.gold);
                    const tx = {
                        standoffId,
                        amount,
                        status: '–û–∂–∏–¥–∞–Ω–∏–µ',
                        date: new Date().toLocaleString(),
                        uid: this.uid
                    };

                    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø–∏—Å–∞—Ç—å –≤ –±–∞–∑—É
                    await this.db.collection('withdrawals').add(tx);
                    await this.db.collection('players').doc(this.uid).collection('history').add(tx);
                    
                    // –û–±–Ω—É–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                    this.state.gold = 0;
                    this.state.journal = 0;
                    await this.db.collection('players').doc(this.uid).update({ gold: 0 });

                    this.closeModal();
                    this.render();
                    this.loadHistory();
                    this.tg.showAlert("–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è.");
                } catch (e) {
                    console.error("Database Error Details:", e);
                    this.tg.showAlert("–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase Firestore.");
                }
            },

            async loadHistory() {
                const cont = document.getElementById('history-container');
                try {
                    const snap = await this.db.collection('players').doc(this.uid).collection('history').orderBy('date', 'desc').limit(5).get();
                    if (snap.empty) return;
                    cont.innerHTML = "";
                    snap.forEach(doc => {
                        const d = doc.data();
                        cont.innerHTML += `
                            <div class="history-item">
                                <div><b>${d.amount} G</b><br><small style="color:#555">ID: ${d.standoffId}</small></div>
                                <div class="status-wait">${d.status}</div>
                            </div>`;
                    });
                } catch (e) { console.error(e); }
            },

            switchPage(id, el) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.getElementById('page-' + id).classList.add('active');
                el.classList.add('active');
                if (id === 'withdraw') this.loadHistory();
            },

            copyLink() {
                const link = `https://t.me/Locus_Gold_bot/Locus_Gold?startapp=${this.uid}`;
                this.tg.showAlert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
            },

            watchAd() { this.tg.showAlert("–†–µ–∫–ª–∞–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞."); }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
