<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Locus Gold: Standoff Edition</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        :root {
            --accent: #00d4ff; --gold: #ffcc00; --bg: #050505;
            --card: rgba(255, 255, 255, 0.08); --brd: rgba(255, 255, 255, 0.15);
            --safe: env(safe-area-inset-bottom);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; position: fixed; width: 100%; }
        
        .app { display: flex; flex-direction: column; height: 100%; padding: 20px 20px calc(95px + var(--safe)); position: relative; z-index: 10; }
        
        .bal-wrap { text-align: center; margin-bottom: 15px; }
        .bal-val { font-size: 60px; font-weight: 900; line-height: 1.1; text-shadow: 0 0 30px rgba(0,212,255,0.4); }
        .gold-val { color: var(--gold); font-size: 26px; font-weight: 800; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        .mine-zone { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .crystal-container { position: relative; width: 240px; height: 240px; display: flex; align-items: center; justify-content: center; }
        .crystal { 
            width: 100%; height: 100%; background: radial-gradient(circle at 30% 30%, var(--accent), #0033ff);
            clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%);
            transition: transform 0.05s cubic-bezier(0, 0, 0.2, 1);
            box-shadow: 0 0 60px rgba(0, 211, 255, 0.2);
        }
        .crystal:active { transform: scale(0.92); }
        .crystal-img { position: absolute; width: 100px; pointer-events: none; filter: drop-shadow(0 0 15px rgba(255,255,255,0.3)); }

        #mini-bonus {
            margin-top: 25px; background: rgba(255, 204, 0, 0.12); border: 2px solid var(--gold);
            padding: 10px 22px; border-radius: 40px; display: none; align-items: center; gap: 10px;
            cursor: pointer; animation: float 3s infinite ease-in-out;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .stat-node { background: var(--card); border: 1px solid var(--brd); padding: 18px; border-radius: 24px; text-align: center; }
        .stat-node b { display: block; font-size: 22px; color: var(--accent); }

        .nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(85px + var(--safe)); background: rgba(10,10,10,0.98); border-top: 1px solid var(--brd); display: flex; padding-bottom: var(--safe); z-index: 1000; backdrop-filter: blur(15px); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; }
        .nav-item.active { color: var(--accent); }

        .screen { position: fixed; inset: 0; background: var(--bg); padding: 40px 25px 120px; display: none; overflow-y: auto; flex-direction: column; z-index: 500; }
        .screen.active { display: flex; }
        .title { font-size: 30px; font-weight: 900; margin-bottom: 20px; }

        .btn { width: 100%; padding: 18px; border-radius: 22px; border: none; font-weight: 900; text-transform: uppercase; cursor: pointer; color: #fff; transition: 0.2s; }
        .btn:active { transform: scale(0.96); }
        .btn-gold { background: linear-gradient(135deg, #ff9d00, #ff5e00); }

        .card-item { background: var(--card); border: 1px solid var(--brd); padding: 20px; border-radius: 24px; margin-bottom: 12px; }
        
        /* –ò—Å—Ç–æ—Ä–∏—è –≤—ã–≤–æ–¥–∞ */
        .history-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--brd); font-size: 13px; }
        .status-pending { color: var(--gold); }

        #fx-canvas { position: absolute; inset: 0; pointer-events: none; z-index: 100; }
    </style>
</head>
<body>
    <canvas id="fx-canvas"></canvas>

    <div class="app">
        <div class="bal-wrap">
            <div class="bal-val" id="ui-bal">0</div>
            <div class="gold-val">üí∞ <span id="ui-gold">0</span></div>
        </div>
        <div class="mine-zone">
            <div class="crystal-container">
                <div class="crystal" id="crystal"></div>
                <img src="https://cdn-icons-png.flaticon.com/512/3203/3203925.png" class="crystal-img">
            </div>
            <div id="mini-bonus" onclick="Game.takeBonus()">
                <b>üéÅ –ë–û–ù–£–°: +<span id="bonus-amt">0</span></b>
                <span id="bonus-sec" style="color:red; font-weight:900; margin-left:8px">10</span>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-node"><span>–ö–ª–∏–∫</span><b id="ui-pwr">1.0</b></div>
            <div class="stat-node"><span>–£—Ä–æ–≤–µ–Ω—å</span><b id="ui-lvl">1</b></div>
        </div>
    </div>

    <div class="screen" id="scr-shop">
        <div class="title">–ú–∞–≥–∞–∑–∏–Ω</div>
        <button class="btn" style="background:var(--accent); margin-bottom:20px" onclick="Game.ad('boost')">üöÄ –§–û–†–°–ê–ñ X3 (30 –°–ï–ö)</button>
        <div id="shop-content"></div>
    </div>

    <div class="screen" id="scr-market">
        <div class="title">–û–±–º–µ–Ω</div>
        <div class="card-item" style="text-align:center; border: 2px solid var(--gold)">
            <p style="margin-bottom:15px">100,000 üíé ‚ûî 1 üí∞</p>
            <button class="btn btn-gold" onclick="Game.exchange()">–ü–ï–†–ï–ü–õ–ê–í–ò–¢–¨</button>
        </div>

        <div id="withdraw-ui" style="display:none; margin-top:20px">
            <div class="title" style="font-size:24px">–í—ã–≤–æ–¥ Standoff 2</div>
            <div class="card-item">
                <p style="font-size:14px; margin-bottom:10px; opacity:0.7">–ö—É—Ä—Å: 1 üí∞ = 100 Gold</p>
                <button class="btn" style="background:#00ff88" onclick="Game.openWithdrawModal()">–í–´–í–ï–°–¢–ò –í STANDOFF 2</button>
            </div>
            
            <div class="title" style="font-size:20px; margin-top:20px">–ò—Å—Ç–æ—Ä–∏—è</div>
            <div class="card-item" id="history-list" style="max-height: 200px; overflow-y: auto;">
                <p style="opacity:0.5; font-size:12px">–¢—É—Ç –±—É–¥–µ—Ç –≤–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç...</p>
            </div>
        </div>
    </div>

    <div class="screen" id="scr-ref">
        <div class="title">–î—Ä—É–∑—å—è</div>
        <div class="card-item" style="text-align:center">
            <p style="margin-bottom:20px">20% –æ—Ç –¥–æ—Ö–æ–¥–∞ –¥—Ä—É–∑–µ–π ‚Äî –≤–∞—à–∏!</p>
            <button class="btn" style="background:var(--accent)" onclick="Game.invite()">–ü–†–ò–ì–õ–ê–°–ò–¢–¨</button>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="UI.go('main', this)"><i>‚õèÔ∏è</i><span>–î–æ–±—ã—á–∞</span></div>
        <div class="nav-item" onclick="UI.go('shop', this)"><i>üõí</i><span>–ú–∞–≥–∞–∑–∏–Ω</span></div>
        <div class="nav-item" onclick="UI.go('market', this)"><i>üí∞</i><span>–û–±–º–µ–Ω</span></div>
        <div class="nav-item" onclick="UI.go('ref', this)"><i>üë•</i><span>–î—Ä—É–∑—å—è</span></div>
    </nav>

    <script>
    const Game = {
        db: null, tg: window.Telegram.WebApp, uid: null,
        d: { bal: 0, gold: 0, pwr: 1.0, lvl: 1, xp: 0, u: [0,0,0,0], m: 1, history: [] },
        items: [
            { n: "–ö–∏—Ä–∫–∞ –ù–æ–≤–∏—á–∫–∞", p: 200, b: 0.5 },
            { n: "–î—Ä–µ–ª—å Nebula", p: 1500, b: 2.5 },
            { n: "–ü–ª–∞–∑–º–∞-–ì–∞–Ω", p: 12000, b: 12.0 },
            { n: "–û—Ä–±–∏—Ç–∞–ª—å–Ω—ã–π –ë—É—Ä", p: 85000, b: 65.0 }
        ],
        bOn: false, bT: 0,

        async init() {
            this.tg.expand();
            this.uid = this.tg.initDataUnsafe?.user?.id?.toString() || "DEV_USER";

            firebase.initializeApp({
                apiKey: "AIzaSyCoa29KS-sin6hoRz0ZbE4f3ki0tZLwkKI",
                projectId: "gold-clicker-5d882",
                appId: "1:83489312782:web:ee5b7bdc390e53e7dd6c5f"
            });
            this.db = firebase.firestore();

            const cache = localStorage.getItem('loc_v8_' + this.uid);
            if(cache) this.apply(JSON.parse(cache));

            try {
                const snap = await this.db.collection('players').doc(this.uid).get();
                if(snap.exists) this.apply(snap.data());
            } catch(e) {}

            FX.init();
            document.getElementById('crystal').onclick = (e) => this.tap(e);
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã + –ø—Ä–∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö
            setInterval(() => this.save(), 2000);
            setInterval(() => this.tick(), 1000);
            setInterval(() => { if(UI.cur === 'main') this.spawnB(); }, 40000);
            
            this.loop();
        },

        apply(s) {
            if(!s) return;
            this.d.bal = s.bal ?? 0;
            this.d.gold = s.gold ?? 0;
            this.d.pwr = (s.pwr && s.pwr >= 1) ? s.pwr : 1.0;
            this.d.lvl = s.lvl ?? 1;
            this.d.u = Array.isArray(s.u) ? s.u : [0,0,0,0];
            this.d.history = Array.isArray(s.history) ? s.history : [];
            this.updateHistoryUI();
        },

        tap(e) {
            const gain = this.d.pwr * this.d.m;
            this.d.bal += gain;
            this.d.xp += 10;
            FX.pop(e.clientX, e.clientY, `+${gain.toFixed(1)}`);
            if(this.tg.HapticFeedback) this.tg.HapticFeedback.impactOccurred('light');
            if(this.d.xp >= this.d.lvl * 1200) { this.d.xp = 0; this.d.lvl++; }
            this.save(); // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ
        },

        spawnB() {
            if(this.bOn) return;
            const amt = Math.floor(5000 + (this.d.bal * 0.1));
            document.getElementById('bonus-amt').innerText = amt.toLocaleString();
            this.bT = 10; this.bOn = true;
            document.getElementById('mini-bonus').style.display = 'flex';
        },

        tick() {
            if(this.bOn) {
                this.bT--;
                document.getElementById('bonus-sec').innerText = this.bT;
                if(this.bT <= 0) { this.bOn = false; document.getElementById('mini-bonus').style.display = 'none'; }
            }
        },

        takeBonus() {
            const ad = Adsgram.init({ blockId: "19969" });
            ad.show().then(() => {
                this.d.bal += Math.floor(5000 + (this.d.bal * 0.1));
                this.bOn = false;
                document.getElementById('mini-bonus').style.display = 'none';
                this.save();
            }).catch(() => this.tg.showAlert("–†–µ–∫–ª–∞–º–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞"));
        },

        exchange() {
            if(this.d.bal >= 100000) {
                this.d.bal -= 100000; this.d.gold++;
                this.d.u = [0,0,0,0]; this.d.pwr = 1.0; this.d.lvl = 1;
                this.save(); UI.drawShop();
            } else this.tg.showAlert("–ù—É–∂–Ω–æ 100,000 üíé");
        },

        openWithdrawModal() {
            this.tg.showPopup({
                title: '–í—ã–≤–æ–¥ Standoff 2',
                message: `–í–≤–µ–¥–∏—Ç–µ ID –∏ —Å—É–º–º—É (—É –≤–∞—Å ${this.d.gold} üí∞)`,
                buttons: [
                    {id: 'ok', type: 'default', text: '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É'},
                    {id: 'cancel', type: 'destructive', text: '–û—Ç–º–µ–Ω–∞'}
                ]
            }, (id) => {
                if(id === 'ok') {
                    // Telegram Web App –Ω–µ –∏–º–µ–µ—Ç –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ Input –≤ Popup, 
                    // –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º prompt –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ ID
                    const sid = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à ID Standoff 2:");
                    const samt = parseInt(prompt(`–ö–∞–∫—É—é —Å—É–º–º—É –≤—ã–≤–µ—Å—Ç–∏? (–ú–∞–∫—Å: ${this.d.gold})`));

                    if(sid && samt > 0 && samt <= this.d.gold) {
                        this.d.gold -= samt;
                        const entry = {
                            id: sid,
                            amt: samt,
                            date: new Date().toLocaleDateString(),
                            status: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'
                        };
                        this.d.history.unshift(entry);
                        this.updateHistoryUI();
                        this.save();
                        this.tg.showAlert("–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!");
                    } else {
                        this.tg.showAlert("–û—à–∏–±–∫–∞: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ID –∏–ª–∏ —Å—É–º–º—É!");
                    }
                }
            });
        },

        updateHistoryUI() {
            const list = document.getElementById('history-list');
            if(!list) return;
            if(this.d.history.length === 0) return;
            list.innerHTML = this.d.history.map(h => `
                <div class="history-item">
                    <span>ID: ${h.id} (${h.amt}üí∞)</span>
                    <span class="status-pending">${h.status}</span>
                </div>
            `).join('');
        },

        save() {
            const dataToSave = JSON.parse(JSON.stringify(this.d));
            localStorage.setItem('loc_v8_' + this.uid, JSON.stringify(dataToSave));
            this.db.collection('players').doc(this.uid).set(dataToSave, {merge: true}).catch(() => {});
        },

        loop() {
            document.getElementById('ui-bal').innerText = Math.floor(this.d.bal).toLocaleString();
            document.getElementById('ui-gold').innerText = this.d.gold;
            document.getElementById('ui-pwr').innerText = (this.d.pwr * this.d.m).toFixed(1);
            document.getElementById('ui-lvl').innerText = this.d.lvl;
            document.getElementById('withdraw-ui').style.display = this.d.gold >= 1 ? 'block' : 'none';
            requestAnimationFrame(() => this.loop());
        },

        buy(i) {
            const itm = this.items[i];
            const cost = Math.floor(itm.p * Math.pow(1.9, this.d.u[i]));
            if(this.d.bal >= cost) {
                this.d.bal -= cost; this.d.u[i]++; this.d.pwr += itm.b;
                this.save(); UI.drawShop();
            }
        },

        invite() {
            this.tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/Locus_Gold_bot/app?startapp=${this.uid}&text=–ó–∞–±–∏—Ä–∞–π –ì–æ–ª–¥—É –≤ –°—Ç–∞–Ω–¥–æ—Ñ—Ñ!`);
        },

        ad(t) {
            Adsgram.init({ blockId: "19969" }).show().then(() => {
                if(t === 'boost') { this.d.m = 3; setTimeout(() => { this.d.m = 1; }, 30000); }
                this.save();
            });
        }
    };

    const UI = {
        cur: 'main',
        go(id, el) {
            this.cur = id;
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
            if(id !== 'main') {
                document.getElementById('scr-' + id).classList.add('active');
                if(id === 'shop') this.drawShop();
            }
        },
        drawShop() {
            const content = document.getElementById('shop-content');
            content.innerHTML = Game.items.map((itm, i) => {
                const cost = Math.floor(itm.p * Math.pow(1.9, Game.d.u[i]));
                return `<div class="card-item" onclick="Game.buy(${i})" style="display:flex; justify-content:space-between; align-items:center">
                    <div><b>${itm.n} [${Game.d.u[i]}]</b><br><small>+${itm.b} –∫ –∫–ª–∏–∫—É</small></div>
                    <div style="color:var(--gold); font-weight:900">${cost.toLocaleString()} üíé</div>
                </div>`;
            }).join('');
        }
    };

    const FX = {
        c: document.getElementById('fx-canvas'), ctx: null, p: [],
        init() { this.ctx = this.c.getContext('2d'); this.res(); this.anim(); },
        res() { this.c.width = window.innerWidth; this.c.height = window.innerHeight; },
        pop(x, y, t) { this.p.push({ x, y, t, a: 1 }); },
        anim() {
            this.ctx.clearRect(0,0,this.c.width,this.c.height);
            this.ctx.font = "bold 26px Inter";
            for(let i=this.p.length-1; i>=0; i--) {
                let p = this.p[i]; p.y -= 2.5; p.a -= 0.03;
                this.ctx.fillStyle = `rgba(0, 212, 255, ${p.a})`;
                this.ctx.fillText(p.t, p.x - 20, p.y);
                if(p.a <= 0) this.p.splice(i, 1);
            }
            requestAnimationFrame(() => this.anim());
        }
    };

    window.onload = () => Game.init();
    </script>
</body>
</html>
