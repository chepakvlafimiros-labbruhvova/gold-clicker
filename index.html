<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nebula: Golden Prestige V2</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        :root {
            --p-color: #00d4ff; --gold: #ffcc00; --bg: #050505;
            --card: rgba(255, 255, 255, 0.05); --brd: rgba(255, 255, 255, 0.1);
            --safe: env(safe-area-inset-bottom);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: none; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; position: fixed; width: 100%; }
        #fx-canvas { position: absolute; inset: 0; z-index: 5; pointer-events: none; }
        
        .app { position: relative; z-index: 10; display: flex; flex-direction: column; height: 100%; padding: 20px 20px calc(85px + var(--safe)); }
        .header { text-align: center; margin-bottom: 10px; }
        .bal-main { font-size: 48px; font-weight: 900; color: #fff; text-shadow: 0 0 20px rgba(0,212,255,0.3); }
        .gold-row { display: flex; justify-content: center; align-items: center; gap: 8px; color: var(--gold); font-weight: 800; font-size: 22px; }
        
        /* –ö—Ä–∏—Å—Ç–∞–ª–ª */
        .mine-zone { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .crystal { 
            width: 220px; height: 220px; background: radial-gradient(circle at 30% 30%, var(--p-color), #0033ff);
            clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%);
            display: flex; align-items: center; justify-content: center; transition: transform 0.05s;
            box-shadow: 0 0 50px rgba(0,212,255,0.2);
        }
        .crystal span { font-size: 80px; }

        /* –û–§–§–ï–† –¢–ê–ô–ú–ï–† */
        #offer-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; background: #111; border: 2px solid var(--gold);
            border-radius: 25px; padding: 20px; z-index: 3000; text-align: center;
            display: none; box-shadow: 0 0 40px rgba(0,0,0,0.8);
        }

        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .card { background: var(--card); border: 1px solid var(--brd); padding: 12px; border-radius: 15px; text-align: center; }
        .card b { display: block; font-size: 18px; color: var(--p-color); }
        .card small { font-size: 10px; opacity: 0.6; text-transform: uppercase; }

        .btn-boost { width: 100%; padding: 18px; border-radius: 20px; border: none; background: linear-gradient(135deg, #ff9d00, #ff5e00); color: #fff; font-weight: 900; text-transform: uppercase; cursor: pointer; }
        
        .nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(75px + var(--safe)); background: #0a0a0a; border-top: 1px solid var(--brd); display: flex; padding-bottom: var(--safe); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; text-decoration: none; }
        .nav-item.active { color: var(--p-color); }

        .screen { position: fixed; inset: 0; background: var(--bg); z-index: 500; display: none; padding: 30px 20px 110px; overflow-y: auto; flex-direction: column; }
        .screen.active { display: flex; }
        .item { background: var(--card); padding: 18px; border-radius: 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--brd); }
    </style>
</head>
<body>
    <canvas id="fx-canvas"></canvas>

    <div id="offer-overlay">
        <h2 style="color:var(--gold); margin-bottom:10px">–í–´–ì–û–î–ù–û!</h2>
        <p id="offer-desc" style="margin-bottom:20px; font-size:14px; line-height:1.4">–ü–æ–ª—É—á–∏ –±–æ–Ω—É—Å –∑–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∫–ª–∞–º—ã!</p>
        <button class="btn-boost" onclick="Game.acceptOffer()">–°–ú–û–¢–†–ï–¢–¨</button>
        <p style="margin-top:10px; font-size:10px; opacity:0.5">–ò—Å—á–µ–∑–Ω–µ—Ç —á–µ—Ä–µ–∑ 10 —Å–µ–∫</p>
    </div>

    <div class="app">
        <div class="header">
            <div class="bal-main" id="ui-bal">0</div>
            <div class="gold-row">üí∞ <span id="ui-gold">0</span></div>
        </div>
        
        <div class="mine-zone">
            <div class="crystal" id="crystal"><span>üíé</span></div>
        </div>

        <div class="stats">
            <div class="card"><small>–ó–ê –ö–õ–ò–ö</small><b id="ui-pwr">1.00</b></div>
            <div class="card"><small>–£–†–û–í–ï–ù–¨</small><b id="ui-lvl">1</b></div>
        </div>
    </div>

    <div class="screen" id="scr-shop">
        <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
        <div style="margin: 20px 0;">
            <button class="btn-boost" style="background: linear-gradient(135deg, #00d4ff, #0055ff);" onclick="Game.showAd('boost')">üöÄ –ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨ –§–û–†–°–ê–ñ x3</button>
        </div>
        <div id="shop-list"></div>
    </div>
    
    <div class="screen" id="scr-market">
        <h2>–û–±–º–µ–Ω –Ω–∞ –∑–æ–ª–æ—Ç–æ</h2>
        <div class="item" style="flex-direction:column; gap:15px; text-align:center; margin-top:20px">
            <p>100,000 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ ‚ûî 1 —Å–ª–∏—Ç–æ–∫</p>
            <p style="color:var(--gold); font-size:12px">‚ö†Ô∏è –ü–†–ò –û–ë–ú–ï–ù–ï –í–°–ï –£–õ–£–ß–®–ï–ù–ò–Ø –°–ë–†–ê–°–´–í–ê–Æ–¢–°–Ø!</p>
            <button id="m-btn" class="btn-boost" style="width:100%; display:none" onclick="Game.exchange()">–û–ë–ú–ï–ù–Ø–¢–¨ –ù–ê –ó–û–õ–û–¢–û</button>
            <div id="m-lock" style="color:#ff3b30; font-weight:bold">–ù–£–ñ–ï–ù 15 –£–†–û–í–ï–ù–¨</div>
        </div>
    </div>

    <div class="screen" id="scr-ref">
        <h2>–î—Ä—É–∑—å—è</h2>
        <div class="item" style="margin-top:20px; text-align:center; flex-direction:column; gap:15px">
            <p>–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π 20% –æ—Ç –∏—Ö –¥–æ–±—ã—á–∏ –Ω–∞ —Å–≤–æ–π –±–∞–ª–∞–Ω—Å!</p>
            <button class="btn-boost" onclick="Game.invite()">–ü–†–ò–ì–õ–ê–°–ò–¢–¨ –î–†–£–ì–ê</button>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="UI.go('main', this)"><i>‚õèÔ∏è</i><span>–î–æ–±—ã—á–∞</span></div>
        <div class="nav-item" onclick="UI.go('shop', this)"><i>üõí</i><span>–ú–∞–≥–∞–∑–∏–Ω</span></div>
        <div class="nav-item" onclick="UI.go('market', this)"><i>üí∞</i><span>–û–±–º–µ–Ω</span></div>
        <div class="nav-item" onclick="UI.go('ref', this)"><i>üë•</i><span>–î—Ä—É–∑—å—è</span></div>
    </nav>

    <script>
    const Game = {
        db: null, tg: window.Telegram.WebApp, uid: null,
        d: { bal: 0, gold: 0, pwr: 1.0, lvl: 1, xp: 0, u: [0,0,0,0], mult: 1 },
        shop: [
            { n: "–ö–∏—Ä–∫–∞ —Å—Ç–∞–∂–µ—Ä–∞", p: 150, b: 0.5 },
            { n: "–ü–Ω–µ–≤–º–æ-–±—É—Ä", p: 1200, b: 2.0 },
            { n: "–õ–∞–∑–µ—Ä–Ω—ã–π —Ä–µ–∑–∞–∫", p: 10000, b: 10.0 },
            { n: "–ò–ò-–ö–æ–º–±–∞–π–Ω", p: 50000, b: 50.0 }
        ],

        async init() {
            this.tg.expand();
            this.uid = this.tg.initDataUnsafe?.user?.id?.toString() || "DEV_PLAYER";
            
            firebase.initializeApp({
                apiKey: "AIzaSyCoa29KS-sin6hoRz0ZbE4f3ki0tZLwkKI",
                projectId: "gold-clicker-5d882",
                appId: "1:83489312782:web:ee5b7bdc390e53e7dd6c5f"
            });
            this.db = firebase.firestore();

            const cache = localStorage.getItem('neb_v3_cache_' + this.uid);
            if(cache) this.d = JSON.parse(cache);

            try {
                const doc = await this.db.collection('players').doc(this.uid).get();
                if(doc.exists) {
                    const cloud = doc.data();
                    if(cloud.gold >= this.d.gold) this.d = {...this.d, ...cloud};
                }
            } catch(e) {}

            FX.init();
            document.getElementById('crystal').onclick = (e) => this.tap(e);
            
            // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–æ–≤
            setInterval(() => this.saveCloud(), 15000);
            setInterval(() => this.triggerOffer(), 40000); // –û—Ñ—Ñ–µ—Ä –∫–∞–∂–¥—ã–µ 40 —Å–µ–∫
            this.renderLoop();
        },

        tap(e) {
            const gain = this.d.pwr * this.d.mult;
            this.d.bal += gain;
            this.d.xp += 10;
            FX.pop(e.clientX, e.clientY, `+${gain.toFixed(1)}`);
            if(this.tg.HapticFeedback) this.tg.HapticFeedback.impactOccurred('light');
            this.checkLvl();
        },

        checkLvl() {
            const req = this.d.lvl * 1200;
            if(this.d.xp >= req) { this.d.xp = 0; this.d.lvl++; this.saveCloud(); }
        },

        triggerOffer() {
            const bonus = Math.floor(5000 + (this.d.bal * 0.15));
            document.getElementById('offer-desc').innerText = `–í—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!\n–ü–æ–ª—É—á–∏ +${bonus.toLocaleString()} üíé –∑–∞ —Ä–µ–∫–ª–∞–º—É.`;
            const overlay = document.getElementById('offer-overlay');
            overlay.style.display = 'block';
            setTimeout(() => { overlay.style.display = 'none'; }, 10000); // –ò—Å—á–µ–∑–∞–µ—Ç —á–µ—Ä–µ–∑ 10 —Å–µ–∫
        },

        acceptOffer() {
            const ad = Adsgram.init({ blockId: "19969" });
            ad.show().then(() => {
                const bonus = Math.floor(5000 + (this.d.bal * 0.15));
                this.d.bal += bonus;
                document.getElementById('offer-overlay').style.display = 'none';
                this.saveCloud();
            }).catch(() => { this.tg.showAlert("–†–µ–∫–ª–∞–º–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞"); });
        },

        showAd(type) {
            const ad = Adsgram.init({ blockId: "19969" });
            ad.show().then(() => {
                if(type === 'boost') {
                    this.d.mult = 3;
                    setTimeout(() => { this.d.mult = 1; }, 30000);
                    this.tg.showAlert("–§–û–†–°–ê–ñ x3 –í–ö–õ–Æ–ß–ï–ù –ù–ê 30 –°–ï–ö–£–ù–î!");
                }
                this.saveCloud();
            });
        },

        exchange() {
            if(this.d.bal >= 100000) {
                this.d.bal -= 100000;
                this.d.gold += 1;
                // –°–ë–†–û–° (–ü–†–ï–°–¢–ò–ñ)
                this.d.u = [0,0,0,0];
                this.d.pwr = 1.0; 
                this.saveCloud();
                this.tg.showPopup({title: '–û–±–º–µ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω!', message: '–í—ã –ø–æ–ª—É—á–∏–ª–∏ 1 —Å–ª–∏—Ç–æ–∫. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã –¥–æ –±–∞–∑–æ–≤—ã—Ö.'});
                UI.drawShop();
            }
        },

        renderLoop() {
            document.getElementById('ui-bal').innerText = Math.floor(this.d.bal).toLocaleString();
            document.getElementById('ui-gold').innerText = this.d.gold;
            document.getElementById('ui-pwr').innerText = (this.d.pwr * this.d.mult).toFixed(1);
            document.getElementById('ui-lvl').innerText = this.d.lvl;

            document.getElementById('m-btn').style.display = (this.d.lvl >= 15 && this.d.bal >= 100000) ? 'block' : 'none';
            document.getElementById('m-lock').style.display = this.d.lvl >= 15 ? 'none' : 'block';

            requestAnimationFrame(() => this.renderLoop());
        },

        async saveCloud() {
            localStorage.setItem('neb_v3_cache_' + this.uid, JSON.stringify(this.d));
            try { await this.db.collection('players').doc(this.uid).set(this.d, {merge: true}); } catch(e) {}
        },

        buy(i) {
            const itm = this.shop[i];
            const cost = Math.floor(itm.p * Math.pow(1.8, this.d.u[i]));
            if(this.d.bal >= cost) {
                this.d.bal -= cost;
                this.d.u[i]++;
                this.d.pwr += itm.b;
                UI.drawShop();
                this.saveCloud();
            } else { this.tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤!"); }
        },

        invite() {
            const link = `https://t.me/Locus_Gold_bot/app?startapp=${this.uid}`;
            this.tg.openTelegramLink(`https://t.me/share/url?url=${link}&text=–ü–æ–º–æ–≥–∏ –º–Ω–µ –≤ —à–∞—Ö—Ç–µ!`);
        }
    };

    const FX = {
        c: document.getElementById('fx-canvas'), ctx: null, p: [],
        init() { this.ctx = this.c.getContext('2d'); this.res(); window.onresize = () => this.res(); this.loop(); },
        res() { this.c.width = window.innerWidth; this.c.height = window.innerHeight; },
        pop(x, y, t) { this.p.push({ x, y, t, a: 1 }); },
        loop() {
            this.ctx.clearRect(0,0,this.c.width,this.c.height);
            this.ctx.font = "bold 24px Inter";
            for(let i=this.p.length-1; i>=0; i--) {
                let p = this.p[i]; p.y -= 2.5; p.a -= 0.02;
                this.ctx.fillStyle = `rgba(0, 212, 255, ${p.a})`;
                this.ctx.fillText(p.t, p.x, p.y);
                if(p.a <= 0) this.p.splice(i, 1);
            }
            requestAnimationFrame(() => this.loop());
        }
    };

    const UI = {
        go(id, el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
            if(id !== 'main') {
                document.getElementById('scr-'+id).classList.add('active');
                if(id === 'shop') this.drawShop();
            }
        },
        drawShop() {
            document.getElementById('shop-list').innerHTML = Game.shop.map((itm, i) => {
                const cost = Math.floor(itm.p * Math.pow(1.8, Game.d.u[i]));
                return `<div class="item" onclick="Game.buy(${i})">
                    <div><b>${itm.n}</b><br><small>+${itm.b} –∫ –∫–ª–∏–∫—É</small></div>
                    <div style="font-weight:900">${cost.toLocaleString()} üíé</div>
                </div>`;
            }).join('');
        }
    };

    window.onload = () => Game.init();
    </script>
</body>
</html>
