<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Locus Nebula: Crystal Miner</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        :root {
            --bg-deep: #0a0a0c;
            --glass: rgba(255, 255, 255, 0.05);
            --accent: #00d4ff;
            --gold: #ffcc00;
            --text: #e0e0e0;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-deep); color: var(--text); height: 100vh; overflow: hidden; position: fixed; width: 100%; }

        .app-container { height: 100%; display: flex; flex-direction: column; padding: 20px; }

        .header-stats { text-align: center; margin-bottom: 20px; }
        .main-balance { font-size: 42px; font-weight: 800; color: #fff; text-shadow: 0 0 15px rgba(0,212,255,0.4); }
        .lvl-info { display: flex; justify-content: space-between; font-size: 11px; color: var(--accent); font-weight: bold; margin-bottom: 4px; }
        .lvl-bar { width: 100%; height: 10px; background: #1a1a1a; border-radius: 5px; overflow: hidden; border: 1px solid #333; position: relative; }
        .lvl-progress { height: 100%; background: linear-gradient(90deg, #00d4ff, #0055ff); width: 0%; transition: width 0.1s linear; }

        .game-world { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .crystal-container { position: relative; width: 220px; height: 220px; cursor: pointer; }
        .crystal {
            width: 100%; height: 100%; background: linear-gradient(135deg, #00d4ff, #0055ff);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 50px rgba(0, 212, 255, 0.2); transition: transform 0.05s;
        }
        .crystal:active { transform: scale(0.90); }
        .crystal-icon { font-size: 80px; filter: drop-shadow(0 0 10px rgba(0,0,0,0.3)); user-select: none; }

        /* –¢–∞–π–º–µ—Ä –±—É—Å—Ç–∞ */
        #boost-timer { color: #ff3b30; font-weight: bold; display: none; margin-top: 10px; font-size: 14px; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 80px; }
        .card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 16px; text-align: center; }
        .card b { display: block; font-size: 16px; margin-bottom: 4px; color: #fff; }
        .card span { font-size: 10px; color: #888; text-transform: uppercase; }

        .btn-boost { background: linear-gradient(90deg, #ff9d00, #ff5e00); color: #fff; font-weight: 800; border: none; grid-column: span 2; padding: 16px; border-radius: 14px; font-size: 14px; }
        .btn-boost.active-mode { background: #111; border: 2px solid #ff9d00; color: #ff9d00; }

        .navbar { position: fixed; bottom: 0; left: 0; right: 0; height: calc(65px + var(--safe-bottom)); background: #0f0f14; display: flex; border-top: 1px solid #222; padding-bottom: var(--safe-bottom); }
        .nav-link { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; text-decoration: none; font-size: 10px; }
        .nav-link.active { color: var(--accent); }

        .screen { position: fixed; inset: 0; background: var(--bg-deep); z-index: 100; display: none; padding: 20px 20px 100px 20px; overflow-y: auto; }
        .screen.active { display: block; }
        .list-entry { background: var(--glass); padding: 18px; border-radius: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); }

        .floating-text { position: absolute; pointer-events: none; color: var(--accent); font-weight: 900; animation: floatUp 0.6s ease-out forwards; font-size: 26px; z-index: 500; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="header-stats">
            <div class="main-balance" id="val-bal">0</div>
            <div id="boost-timer">–ö–í–ê–ù–¢–û–í–´–ô –ü–†–´–ñ–û–ö (x3): 00:30</div>
            <div class="lvl-info">
                <span id="val-lvl-name">–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –∫–∞–¥–µ—Ç</span>
                <span id="val-lvl-num">–£—Ä. 1</span>
            </div>
            <div class="lvl-bar"><div class="lvl-progress" id="val-prog"></div></div>
        </header>

        <main class="game-world">
            <div class="crystal-container" id="tap-zone">
                <div class="crystal"><span class="crystal-icon">üíé</span></div>
            </div>
        </main>

        <section class="action-grid">
            <div class="card"><span>–ó–∞ –∫–ª–∏–∫</span><b id="val-pwr">1.0</b></div>
            <div class="card"><span>–ê–≤—Ç–æ-—Å–±–æ—Ä</span><b id="val-dps">0.0</b></div>
            <button class="btn-boost" id="ad-btn" onclick="Engine.showRewardAd()">üî• –£–°–ö–û–†–ï–ù–ò–ï x3 (–†–ï–ö–õ–ê–ú–ê)</button>
        </section>
    </div>

    <div class="screen" id="scr-upg">
        <h2 style="margin-bottom: 20px; text-align: center;">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –ù–µ–±—É–ª—ã</h2>
        <div class="list-entry" onclick="Engine.buyUpg('pwr')">
            <div><b>–õ–∞–∑–µ—Ä–Ω—ã–π –±—É—Ä</b><br><small>+0.5 –∑–∞ –∫–ª–∏–∫</small></div>
            <b id="cost-pwr">100 üíé</b>
        </div>
        <div class="list-entry" onclick="Engine.buyUpg('dps')">
            <div><b>–ë–æ—Ç-—Å–±–æ—Ä—â–∏–∫</b><br><small>+1.0/—Å–µ–∫</small></div>
            <b id="cost-dps">500 üíé</b>
        </div>
    </div>

    <div class="screen" id="scr-ref">
        <h2 style="margin-bottom: 20px; text-align: center;">–ö–æ–º–∞–Ω–¥–∞ —à–∞—Ö—Ç–µ—Ä–æ–≤</h2>
        <button class="btn-boost" onclick="Engine.copyRef()">–ü–†–ò–ì–õ–ê–°–ò–¢–¨ –ù–ê–ü–ê–†–ù–ò–ö–ê</button>
    </div>

    <nav class="navbar">
        <div class="nav-link active" onclick="UI.go('main', this)"><i>üõ∏</i><span>–î–æ–±—ã—á–∞</span></div>
        <div class="nav-link" onclick="UI.go('upg', this)"><i>üõ†Ô∏è</i><span>–ê–ø–≥—Ä–µ–π–¥—ã</span></div>
        <div class="nav-link" onclick="UI.go('ref', this)"><i>üë•</i><span>–î—Ä—É–∑—å—è</span></div>
    </nav>

    <script>
        const Engine = {
            state: { bal: 0, pwr: 1, dps: 0, xp: 0, lvl: 1, uid: "0", boost: 1 },
            levels: [
                "–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –∫–∞–¥–µ—Ç", "–°–±–æ—Ä—â–∏–∫ –ø—ã–ª–∏", "–õ—É–Ω–Ω—ã–π —Å—Ç–∞—Ä–∞—Ç–µ–ª—å", "–ú–∞—Ä—Å–∏–∞–Ω—Å–∫–∏–π –±–∞—Ä–æ–Ω", 
                "–ú–∞—Å—Ç–µ—Ä –°–∞—Ç—É—Ä–Ω–∞", "–ò—Å–∫–∞—Ç–µ–ª—å —á–µ—Ä–Ω—ã—Ö –¥—ã—Ä", "–ó–≤–µ–∑–¥–Ω—ã–π –∏–º–ø–µ—Ä–∞—Ç–æ—Ä", "–ü–æ–≤–µ–ª–∏—Ç–µ–ª—å –ù–µ–±—É–ª—ã",
                "–ö—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–π –±–æ–≥", "–í–Ω–µ –≤—Ä–µ–º–µ–Ω–∏"
            ],
            tg: window.Telegram.WebApp,
            
            init() {
                this.tg.expand();
                this.state.uid = this.tg.initDataUnsafe?.user?.id || "dev_user";
                this.load();
                this.render();
                this.loop();

                // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —à–∫–∞–ª—ã –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ (pointerdown)
                document.getElementById('tap-zone').addEventListener('pointerdown', (e) => {
                    this.tap(e);
                });

                setInterval(() => this.save(), 5000);
            },

            tap(e) {
                const clickPower = this.state.pwr * this.state.boost;
                this.state.bal += clickPower;
                this.state.xp += 10; // –û–ø—ã—Ç –∑–∞ –∫–ª–∏–∫
                
                this.checkLvl();
                this.spawn(e.clientX, e.clientY, `+${clickPower.toFixed(1)}`);
                this.render();
                if(this.tg.HapticFeedback) this.tg.HapticFeedback.impactOccurred('light');
            },

            checkLvl() {
                let xpNeeded = this.state.lvl * 500;
                if(this.state.xp >= xpNeeded) {
                    this.state.xp = 0;
                    this.state.lvl++;
                    this.tg.showAlert(`üöÄ –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —Å—Ç–∞—Ç—É—Å–∞: ${this.levels[this.state.lvl-1] || "–õ–µ–≥–µ–Ω–¥–∞"}`);
                }
            },

            showRewardAd() {
                const ad = Adsgram.init({ blockId: "19895" }); // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à ID
                ad.show().then(() => {
                    this.activateBoost();
                }).catch(() => {
                    this.tg.showAlert("–†–µ–∫–ª–∞–º–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å, –Ω–æ –º—ã –¥–∞–ª–∏ –≤–∞–º –±–æ–Ω—É—Å –∑–∞ –ø–æ–ø—ã—Ç–∫—É!");
                    this.activateBoost(); // –î–ª—è —Ç–µ—Å—Ç–∞ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å
                });
            },

            activateBoost() {
                if(this.state.boost > 1) return;
                this.state.boost = 3;
                let timeLeft = 30;
                const btn = document.getElementById('ad-btn');
                const timerLabel = document.getElementById('boost-timer');
                
                btn.disabled = true;
                btn.classList.add('active-mode');
                timerLabel.style.display = 'block';

                const countdown = setInterval(() => {
                    timeLeft--;
                    timerLabel.innerText = `–ö–í–ê–ù–¢–û–í–´–ô –ü–†–´–ñ–û–ö (x3): 00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
                    if(timeLeft <= 0) {
                        clearInterval(countdown);
                        this.state.boost = 1;
                        btn.disabled = false;
                        btn.classList.remove('active-mode');
                        timerLabel.style.display = 'none';
                        this.render();
                    }
                }, 1000);
            },

            render() {
                document.getElementById('val-bal').innerText = Math.floor(this.state.bal).toLocaleString();
                document.getElementById('val-pwr').innerText = (this.state.pwr * this.state.boost).toFixed(1);
                document.getElementById('val-dps').innerText = this.state.dps.toFixed(1);
                
                // –ù–∞–∑–≤–∞–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π
                document.getElementById('val-lvl-name').innerText = this.levels[this.state.lvl-1] || "–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π —Å–∫–∏—Ç–∞–ª–µ—Ü";
                document.getElementById('val-lvl-num').innerText = `–£—Ä. ${this.state.lvl}`;
                
                // –ê–ø–≥—Ä–µ–π–¥—ã
                document.getElementById('cost-pwr').innerText = Math.floor(this.state.pwr * 250) + " üíé";
                document.getElementById('cost-dps').innerText = Math.floor((this.state.dps + 1) * 600) + " üíé";
                
                // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                let xpNeeded = this.state.lvl * 500;
                let perc = (this.state.xp / xpNeeded) * 100;
                document.getElementById('val-prog').style.width = perc + "%";
            },

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            loop() { setInterval(() => { if(this.state.dps > 0) { this.state.bal += this.state.dps / 10; this.render(); } }, 100); },
            spawn(x, y, txt) {
                const el = document.createElement('div');
                el.className = 'floating-text';
                if(this.state.boost > 1) el.style.color = '#ff9d00';
                el.innerText = txt;
                el.style.left = x + 'px'; el.style.top = y + 'px';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 600);
            },
            save() { localStorage.setItem('locus_nebula_save', JSON.stringify(this.state)); },
            load() { const data = localStorage.getItem('locus_nebula_save'); if(data) this.state = {...this.state, ...JSON.parse(data)}; },
            copyRef() { 
                const link = `https://t.me/Locus_Gold_bot/app?startapp=${this.state.uid}`;
                this.tg.openTelegramLink(`https://t.me/share/url?url=${link}&text=–î–∞–≤–∞–π –¥–æ–±—ã–≤–∞—Ç—å –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –≤–º–µ—Å—Ç–µ!`);
            },
            buyUpg(type) {
                let cost = type === 'pwr' ? Math.floor(this.state.pwr * 250) : Math.floor((this.state.dps + 1) * 600);
                if(this.state.bal >= cost) {
                    this.state.bal -= cost;
                    if(type === 'pwr') this.state.pwr += 0.5; else this.state.dps += 1.0;
                    this.render(); this.save();
                } else { this.tg.showAlert("–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤!"); }
            }
        };

        const UI = {
            go(id, el) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                if(id !== 'main') document.getElementById('scr-' + id).classList.add('active');
                el.classList.add('active');
            }
        };

        window.onload = () => Engine.init();
    </script>
</body>
</html>
