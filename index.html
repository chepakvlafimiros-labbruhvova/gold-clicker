<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nebula: Golden Empire</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --p-color: #00d4ff;
            --gold: #ffcc00;
            --bg: #08090c;
            --card: rgba(255, 255, 255, 0.03);
            --brd: rgba(255, 255, 255, 0.07);
            --safe: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: none; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; position: fixed; width: 100%; }

        #fx-canvas { position: absolute; inset: 0; z-index: 5; pointer-events: none; }

        .app { position: relative; z-index: 10; display: flex; flex-direction: column; height: 100%; padding: 20px 20px calc(85px + var(--safe)); }

        /* –≠–∫–æ–Ω–æ–º–∏–∫–∞ */
        .header { text-align: center; margin-bottom: 15px; }
        .bal-main { font-size: 44px; font-weight: 900; background: linear-gradient(#fff, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: block; }
        .gold-row { display: flex; justify-content: center; align-items: center; gap: 8px; color: var(--gold); font-weight: 800; font-size: 19px; margin-top: 5px; }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω—è */
        .lvl-card { background: var(--card); border: 1px solid var(--brd); padding: 12px; border-radius: 18px; margin-top: 10px; }
        .lvl-meta { display: flex; justify-content: space-between; font-size: 10px; font-weight: 800; color: var(--p-color); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .bar-outer { width: 100%; height: 6px; background: rgba(0,0,0,0.4); border-radius: 10px; overflow: hidden; border: 1px solid var(--brd); }
        .bar-inner { height: 100%; width: 100%; background: var(--p-color); transform-origin: left; transform: scaleX(0); will-change: transform; transition: transform 0.3s ease-out; }

        /* –ò–≥—Ä–æ–≤–æ–π –ö—Ä–∏—Å—Ç–∞–ª–ª */
        .game-area { flex: 1; display: flex; align-items: center; justify-content: center; }
        .crystal { 
            width: 210px; height: 210px; 
            background: radial-gradient(circle at 30% 30%, var(--p-color), #0033aa);
            clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.05s;
        }
        .crystal span { font-size: 75px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.4)); }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { background: var(--card); border: 1px solid var(--brd); padding: 10px; border-radius: 14px; text-align: center; }
        .stat-card b { display: block; font-size: 16px; }
        .stat-card small { font-size: 9px; opacity: 0.4; text-transform: uppercase; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { border: none; font-weight: 900; text-transform: uppercase; transition: 0.2s; cursor: pointer; }
        .btn-boost { grid-column: span 2; padding: 16px; border-radius: 16px; background: linear-gradient(135deg, #ff9d00, #ff5e00); color: #fff; font-size: 12px; margin-top: 8px; }
        .btn-withdraw { background: var(--gold); color: #000; padding: 18px; border-radius: 16px; width: 100%; margin-top: 20px; font-size: 14px; display: none; box-shadow: 0 0 20px rgba(255,204,0,0.2); }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(75px + var(--safe)); background: rgba(8,9,12,0.98); display: flex; border-top: 1px solid var(--brd); padding-bottom: var(--safe); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #444; }
        .nav-item.active { color: var(--p-color); }

        .screen { position: fixed; inset: 0; background: var(--bg); z-index: 500; display: none; padding: 30px 20px 100px; overflow-y: auto; }
        .screen.active { display: block; }
        
        .list-item { background: var(--card); padding: 16px; border-radius: 18px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--brd); }
        .ref-info { border-left: 3px solid var(--p-color); padding-left: 12px; }
    </style>
</head>
<body>

    <canvas id="fx-canvas"></canvas>

    <div class="app">
        <div class="header">
            <span class="bal-main" id="ui-bal">0</span>
            <div class="gold-row">üí∞ <span id="ui-gold">0</span> <small style="font-size:10px; opacity:0.6">SLOTS</small></div>
            <div class="lvl-card">
                <div class="lvl-meta"><span id="ui-rank">–†–ê–ë–û–ß–ò–ô</span><span id="ui-lvl">–£–†. 1</span></div>
                <div class="bar-outer"><div class="bar-inner" id="ui-bar"></div></div>
            </div>
        </div>

        <div class="game-area">
            <div class="crystal" id="crystal"><span>üíé</span></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><small>–ö–µ—Ä–Ω</small><b id="ui-pwr">1.0</b></div>
            <div class="stat-card"><small>–ê–≤—Ç–æ–º–∞—Ç</small><b id="ui-dps">0.0</b></div>
            <button class="btn btn-boost" onclick="Game.runAd()">üöÄ –§–û–†–°–ê–ñ x3 (30 —Å–µ–∫)</button>
        </div>
    </div>

    <div class="screen" id="scr-shop">
        <h2 style="margin-bottom:20px">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h2>
        <div id="shop-list"></div>
    </div>

    <div class="screen" id="scr-ref">
        <h2 style="margin-bottom:10px">–í–∞—à–∞ –ê—Ä—Ç–µ–ª—å</h2>
        <p style="color:#666; font-size:14px; margin-bottom:20px">–ó–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ <b style="color:var(--p-color)">+20%</b> –æ—Ç –µ–≥–æ –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞ –Ω–∞–≤—Å–µ–≥–¥–∞.</p>
        <button class="btn btn-boost" style="width:100%; margin-bottom:20px" onclick="Game.invite()">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤ –∑–∞–±–æ–π</button>
        <div id="ref-list">
            <div class="list-item">
                <div class="ref-info"><b>–ù–∞–ø–∞—Ä–Ω–∏–∫ #421</b><br><small>–î–æ—Ö–æ–¥: +0.0 üíé/—Å–µ–∫</small></div>
                <div style="color:var(--p-color); font-weight:900">20%</div>
            </div>
        </div>
    </div>

    <div class="screen" id="scr-market">
        <h2 style="margin-bottom:20px">–ó–æ–ª–æ—Ç–æ–π —Ä–µ–∑–µ—Ä–≤</h2>
        <div class="list-item" style="flex-direction:column; text-align:center; gap:15px">
            <p style="font-size:14px; opacity:0.7">–û–±–º–µ–Ω 100,000 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –Ω–∞ 1 —Å–ª–∏—Ç–æ–∫.</p>
            <div id="m-lock" style="color:#ff3b30; font-weight:900; font-size:12px">–ù–£–ñ–ï–ù 15 –£–†–û–í–ï–ù–¨</div>
            <div id="m-ui" style="display:none; width:100%">
                <button class="btn" style="width:100%; padding:15px; border-radius:12px; background:var(--p-color); font-weight:900" onclick="Game.exchange()">–í—ã–ø–ª–∞–≤–∏—Ç—å 1 —Å–ª–∏—Ç–æ–∫</button>
            </div>
        </div>
        <button id="ui-withdraw" class="btn btn-withdraw" onclick="Game.withdraw()">–í—ã–≤–µ—Å—Ç–∏ 100 –°–ª–∏—Ç–∫–æ–≤</button>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="UI.go('main', this)"><i>‚õèÔ∏è</i></div>
        <div class="nav-item" onclick="UI.go('shop', this)"><i>üõí</i></div>
        <div class="nav-item" onclick="UI.go('ref', this)"><i>üë•</i></div>
        <div class="nav-item" onclick="UI.go('market', this)"><i>üí∞</i></div>
    </nav>

    <script>
        // --- –î–í–ò–ñ–û–ö –≠–§–§–ï–ö–¢–û–í ---
        const FX = {
            c: document.getElementById('fx-canvas'),
            ctx: null, particles: [],
            init() { this.ctx = this.c.getContext('2d'); this.res(); window.onresize = () => this.res(); this.loop(); },
            res() { this.c.width = window.innerWidth; this.c.height = window.innerHeight; },
            pop(x, y, txt) { this.particles.push({ x, y, txt, l: 1 }); },
            loop() {
                this.ctx.clearRect(0,0,this.c.width,this.c.height);
                this.ctx.font = "bold 26px Inter";
                for(let i=this.particles.length-1; i>=0; i--){
                    let p = this.particles[i]; p.y -= 2; p.l -= 0.02;
                    this.ctx.fillStyle = `rgba(0, 212, 255, ${p.l})`;
                    this.ctx.fillText(p.txt, p.x, p.y);
                    if(p.l <= 0) this.particles.splice(i, 1);
                }
                requestAnimationFrame(() => this.loop());
            }
        };

        // --- –ó–í–£–ö–û–í–û–ô –î–í–ò–ñ–û–ö ---
        const Sound = {
            ctx: null, s: false,
            init() { 
                if(this.s) return;
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.type = 'sine'; o.frequency.setValueAtTime(100, this.ctx.currentTime);
                g.gain.setValueAtTime(0.01, this.ctx.currentTime);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); this.s = true;
            }
        };

        // --- –Ø–î–†–û –ò–ì–†–´ ---
        const Game = {
            save_key: 'nebula_pro_v10',
            d: { bal: 0, gold: 0, pwr: 1, dps: 0, xp: 0, lvl: 1, mult: 1, u: [0,0,0,0] },
            shop: [
                { n: "–ö–∏—Ä–∫–∞ —Å—Ç–∞–∂–µ—Ä–∞", p: 120, b: 0.5, t: 'pwr' },
                { n: "–î—Ä–µ–ª—å '–ö—Ä–æ—Ç'", p: 600, b: 2.0, t: 'dps' },
                { n: "–õ–∞–∑–µ—Ä '–ó–≤–µ–∑–¥–∞'", p: 3000, b: 8, t: 'pwr' },
                { n: "–ò–ò-–ó–∞–±–æ–π—â–∏–∫", p: 15000, b: 50, t: 'dps' }
            ],

            init() {
                this.load();
                FX.init();
                const cry = document.getElementById('crystal');
                cry.addEventListener('touchstart', (e) => {
                    e.preventDefault(); Sound.init();
                    for(let t of e.changedTouches) this.tap(t.clientX, t.clientY);
                });
                setInterval(() => this.tick(), 100);
                this.render();
            },

            tap(x, y) {
                const g = this.d.pwr * this.d.mult;
                this.d.bal += g; this.d.xp += 12;
                this.checkLvl();
                FX.pop(x, y, `+${g.toFixed(1)}`);
                if(window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.impactOccurred('light');
                document.getElementById('crystal').style.transform = 'scale(0.94)';
                setTimeout(()=>document.getElementById('crystal').style.transform='scale(1)', 50);
            },

            tick() { 
                if(this.d.dps > 0) this.d.bal += this.d.dps/10; 
                this.render(); 
            },

            checkLvl() {
                const req = this.d.lvl * 1200;
                if(this.d.xp >= req) { this.d.xp = 0; this.d.lvl++; this.save(); }
            },

            render() {
                document.getElementById('ui-bal').innerText = Math.floor(this.d.bal).toLocaleString();
                document.getElementById('ui-gold').innerText = this.d.gold;
                document.getElementById('ui-pwr').innerText = (this.d.pwr * this.d.mult).toFixed(1);
                document.getElementById('ui-dps').innerText = this.d.dps.toFixed(1);
                document.getElementById('ui-lvl').innerText = `–£–†. ${this.d.lvl}`;
                
                const req = this.d.lvl * 1200;
                document.getElementById('ui-bar').style.transform = `scaleX(${Math.min(this.d.xp/req, 1)})`;

                if(this.d.lvl >= 15) {
                    document.getElementById('m-lock').style.display = 'none';
                    document.getElementById('m-ui').style.display = 'block';
                }

                // –£—Å–ª–æ–≤–∏–µ –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –≤—ã–≤–æ–¥–∞ (100 —Å–ª–∏—Ç–∫–æ–≤)
                const wBtn = document.getElementById('ui-withdraw');
                wBtn.style.display = this.d.gold >= 100 ? 'block' : 'none';
            },

            exchange() {
                if(this.d.bal >= 100000) {
                    this.d.bal -= 100000; this.d.gold += 1; this.save();
                    Telegram.WebApp.showPopup({ title: '–ì–æ—Ç–æ–≤–æ!', message: '–í—ã–ø–ª–∞–≤–ª–µ–Ω 1 —Å–ª–∏—Ç–æ–∫' });
                } else { Telegram.WebApp.showAlert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤!'); }
            },

            withdraw() {
                const wallet = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ –¥–ª—è –≤—ã–ø–ª–∞—Ç—ã:");
                if(wallet) {
                    this.d.gold -= 100; this.save();
                    alert("–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ –ø—Ä–∏–Ω—è—Ç–∞! –û–∂–∏–¥–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏.");
                }
            },

            runAd() {
                const start = () => {
                    this.d.mult = 3;
                    setTimeout(() => { this.d.mult = 1; }, 30000);
                };
                if(window.Adsgram) {
                    Adsgram.init({ blockId: "19895" }).show().then(start).catch(start);
                } else start();
            },

            invite() {
                const uid = Telegram.WebApp.initDataUnsafe?.user?.id || "0";
                const link = `https://t.me/YOUR_BOT_NAME/app?startapp=${uid}`;
                Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${link}&text=–í—Å—Ç—É–ø–∞–π –≤ –º–æ—é –∞—Ä—Ç–µ–ª—å!`);
            },

            buy(i) {
                const itm = this.shop[i];
                const cost = Math.floor(itm.p * Math.pow(1.6, this.d.u[i]));
                if(this.d.bal >= cost) {
                    this.d.bal -= cost; this.d.u[i]++;
                    if(itm.t === 'pwr') this.d.pwr += itm.b; else this.d.dps += itm.b;
                    UI.drawShop(); this.save();
                }
            },

            save() { localStorage.setItem(this.save_key, JSON.stringify(this.d)); },
            load() { const s = localStorage.getItem(this.save_key); if(s) this.d = {...this.d, ...JSON.parse(s)}; }
        };

        const UI = {
            go(id, el) {
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                el.classList.add('active');
                if(id !== 'main') {
                    document.getElementById('scr-'+id).classList.add('active');
                    if(id === 'shop') this.drawShop();
                }
            },
            drawShop() {
                document.getElementById('shop-list').innerHTML = Game.shop.map((itm, i) => {
                    const cost = Math.floor(itm.p * Math.pow(1.6, Game.d.u[i]));
                    return `<div class="list-item" onclick="Game.buy(${i})">
                        <div><b>${itm.n}</b><br><small>+${itm.b} –∫ —Å–∏–ª–µ</small></div>
                        <div style="font-weight:900">${cost.toLocaleString()} üíé</div>
                    </div>`;
                }).join('');
            }
        };

        window.onload = () => Game.init();
    </script>
</body>
</html>
