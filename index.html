<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Locus Gold Elite Ultimate</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        :root {
            --bg: #000000;
            --surface: #111112;
            --accent: #ff9d00;
            --error: #ff3b30;
            --text-dim: #8e8e93;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; position: fixed; width: 100%; display: flex; flex-direction: column; }

        .screen { position: absolute; inset: 0; display: none; flex-direction: column; padding: 20px 20px calc(80px + var(--safe-bottom)); }
        .screen.active { display: flex; }

        /* –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ: –î–ò–ó–ê–ô–ù */
        .gold-header { text-align: center; margin-top: 10px; }
        .gold-count { font-size: 56px; font-weight: 900; color: var(--accent); letter-spacing: -2px; }
        .gold-label { font-size: 14px; color: var(--text-dim); text-transform: uppercase; font-weight: 800; margin-top: -5px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 25px 0; }
        .stat-card { background: var(--surface); border-radius: 20px; padding: 15px; text-align: center; border: 1px solid #1c1c1e; }
        .stat-card span { display: block; color: var(--text-dim); font-size: 10px; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; }
        .stat-card b { font-size: 18px; color: #fff; }

        /* –ú–û–ù–ï–¢–ê */
        .click-area { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .coin {
            width: 230px; height: 230px; border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #ffc400, #ff8000);
            border: 12px solid #1a1a1c; box-shadow: 0 0 40px rgba(255, 157, 0, 0.1);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.05s; cursor: pointer; user-select: none;
        }
        .coin:active { transform: scale(0.93); }
        .coin span { font-size: 90px; font-weight: 900; color: rgba(0,0,0,0.1); }

        /* –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô */
        .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .btn-act { background: var(--surface); border: 1px solid #222; border-radius: 22px; padding: 18px 10px; text-align: center; cursor: pointer; transition: 0.2s; }
        .btn-act:active { transform: scale(0.97); background: #1c1c1e; }
        .btn-act b { display: block; font-size: 15px; color: #fff; text-transform: uppercase; }
        .btn-act small { color: var(--accent); font-size: 10px; font-weight: 800; }
        
        .btn-upg { grid-column: span 2; border: 1px solid var(--accent); background: rgba(255, 157, 0, 0.05); }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .nav { position: fixed; bottom: 0; width: 100%; height: calc(70px + var(--safe-bottom)); background: #080808; border-top: 1px solid #161618; display: flex; padding-bottom: var(--safe-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dim); font-size: 22px; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .nav-item span { font-size: 10px; font-weight: 700; text-transform: uppercase; margin-top: 4px; }

        /* –ê–ù–¢–ò–ß–ò–¢ */
        .ac-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 30px; }
        .ac-box { background: #1c1c1e; padding: 35px; border-radius: 30px; text-align: center; border: 1px solid var(--error); width: 100%; }
        .ac-btn { background: var(--accent); color: #000; border: none; padding: 18px; border-radius: 18px; width: 100%; font-weight: 900; margin-top: 20px; text-transform: uppercase; }

        .f-pop { position: absolute; color: var(--accent); font-weight: 900; pointer-events: none; animation: fPop 0.7s forwards; font-size: 26px; z-index: 1000; }
        @keyframes fPop { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-110px); } }
        
        .list-item { background: var(--surface); padding: 16px; border-radius: 18px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #1c1c1e; }
    </style>
</head>
<body>

    <div class="ac-modal" id="ac-modal">
        <div class="ac-box">
            <h2 style="color:var(--error); margin-bottom:10px;">üõ°Ô∏è –ê–ù–¢–ò–ß–ò–¢</h2>
            <p style="font-size:15px; line-height:1.4;">–ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–∫–ª–∏–∫–µ—Ä, —É–ª—É—á—à–∏—Ç–µ –º–æ—â–Ω–æ—Å—Ç—å –∫–ª–∏–∫–∞ —Å –ø–æ–º–æ—â—å—é –º–∞–≥–∞–∑–∏–Ω–∞ –∏–ª–∏ —Ä–µ–∫–ª–∞–º—ã</p>
            <button class="ac-btn" onclick="Game.closeAC()">–•–û–†–û–®–û</button>
        </div>
    </div>

    <div class="screen active" id="scr-main">
        <div class="gold-header">
            <div class="gold-count" id="gold-val">0.000</div>
            <div class="gold-label">GOLD BALANCE</div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card"><span>–ö–õ–ò–ö</span><b id="pwr-val">0.001</b></div>
            <div class="stat-card"><span>–î–†–£–ó–¨–Ø</span><b id="ref-val">0</b></div>
        </div>

        <div class="click-area">
            <div class="coin" id="coin-btn"><span>G</span></div>
        </div>

        <div class="action-btns">
            <div class="btn-act" onclick="Game.showAd('gold')"><b>–ë–û–ù–£–°</b><small>+5.0 G</small></div>
            <div class="btn-act" onclick="Game.showAd('pwr')"><b>–°–ò–õ–ê</b><small>+0.005</small></div>
            <div class="btn-act btn-upg" id="upg-btn" onclick="Game.upgrade()">
                <b id="upg-txt">–£–õ–£–ß–®–ò–¢–¨ –ó–ê 1 G</b>
                <small>–£–í–ï–õ–ò–ß–ò–¢–¨ –ú–û–©–ù–û–°–¢–¨ –ö–õ–ò–ö–ê</small>
            </div>
        </div>
    </div>

    <div class="screen" id="scr-wallet">
        <h2 style="text-align:center; margin-bottom:20px;">–í–´–í–û–î –°–†–ï–î–°–¢–í</h2>
        <div class="stat-card" style="margin-bottom:20px;">
            <span id="wd-info">–ú–ò–ù. –í–´–í–û–î: 750 G</span>
            <button class="ac-btn" id="wd-btn" style="opacity:0.3" disabled onclick="Game.withdraw()">–í–´–í–ï–°–¢–ò</button>
        </div>
        <div id="history-list"></div>
    </div>

    <div class="screen" id="scr-top">
        <h2 style="text-align:center; margin-bottom:20px;">–¢–û–ü-50</h2>
        <div id="top-list"></div>
    </div>

    <div class="screen" id="scr-ref">
        <h2 style="text-align:center; margin-bottom:20px;">–†–ï–§–ï–†–ê–õ–´</h2>
        <button class="ac-btn" onclick="Game.invite()" style="margin-bottom:20px;">–ü–†–ò–ì–õ–ê–°–ò–¢–¨ –î–†–£–ì–ê (+100 G)</button>
        <div id="ref-list"></div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="UI.nav('main', this)"><i>‚õèÔ∏è</i><span>–î–û–ë–´–ß–ê</span></div>
        <div class="nav-item" onclick="UI.nav('top', this)"><i>üèÜ</i><span>–¢–û–ü</span></div>
        <div class="nav-item" onclick="UI.nav('ref', this)"><i>üë•</i><span>–î–†–£–ó–¨–Ø</span></div>
        <div class="nav-item" onclick="UI.nav('wallet', this)"><i>üè¶</i><span>–í–´–í–û–î</span></div>
    </nav>

    <script>
    const Game = {
        db: null, tg: window.Telegram.WebApp, uid: null,
        data: { gold: 0, pwr: 0.001, upg: 0, name: 'User' },
        lastTaps: [], isLocked: false, 

        async init() {
            this.tg.expand();
            this.uid = this.tg.initDataUnsafe?.user?.id?.toString() || "DEV_USER";
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ LocalStorage (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
            const local = localStorage.getItem('locus_data_' + this.uid);
            if(local) this.data = JSON.parse(local);

            firebase.initializeApp({
                apiKey: "AIzaSyCoa29KS-sin6hoRz0ZbE4f3ki0tZLwkKI",
                projectId: "gold-clicker-5d882",
                appId: "1:83489312782:web:ee5b7bdc390e53e7dd6c5f"
            });
            this.db = firebase.firestore();

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –æ–±–ª–∞–∫–∞
            const doc = await this.db.collection('players').doc(this.uid).get();
            if(doc.exists) {
                const cloudData = doc.data();
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º: –±–µ—Ä–µ–º –±–æ–ª—å—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–æ–ª–æ—Ç–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç–∫–∞—Ç–∞)
                if(cloudData.gold > this.data.gold) this.data = cloudData;
            } else {
                this.data.name = this.tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫";
                await this.db.collection('players').doc(this.uid).set(this.data);
            }

            this.render();
            this.bind();
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫
            setInterval(() => this.saveCloud(), 15000);
        },

        bind() {
            document.getElementById('coin-btn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                for(let t of e.changedTouches) this.tap(t.clientX, t.clientY);
            });
        },

        tap(x, y) {
            if(this.isLocked) return;
            const now = Date.now();
            this.lastTaps.push(now);
            this.lastTaps = this.lastTaps.filter(t => now - t < 1000);

            if(this.lastTaps.length > 20) {
                this.isLocked = true;
                document.getElementById('ac-modal').style.display = 'flex';
                return;
            }

            this.data.gold += this.data.pwr;
            this.render();
            this.spawn(x, y);
            this.saveLocal();
            if(this.tg.HapticFeedback) this.tg.HapticFeedback.impactOccurred('light');
        },

        getPrice() {
            const u = this.data.upg || 0;
            if(u >= 20) return 150;
            if(u >= 10) return 15;
            if(u >= 3) return 5;
            return 1;
        },

        upgrade() {
            const p = this.getPrice();
            if(this.data.gold < p) return this.tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Gold");
            this.data.gold -= p;
            this.data.pwr += 0.005;
            this.data.upg++;
            this.saveLocal();
            this.saveCloud();
            this.render();
        },

        saveLocal() {
            localStorage.setItem('locus_data_' + this.uid, JSON.stringify(this.data));
        },

        async saveCloud() {
            await this.db.collection('players').doc(this.uid).update(this.data);
            console.log("Cloud Synced");
        },

        render() {
            document.getElementById('gold-val').innerText = this.data.gold.toFixed(3);
            document.getElementById('pwr-val').innerText = this.data.pwr.toFixed(3);
            document.getElementById('upg-txt').innerText = `–£–õ–£–ß–®–ò–¢–¨ –ó–ê ${this.getPrice()} G`;
            
            const btn = document.getElementById('wd-btn');
            if(this.data.gold >= 750) {
                btn.disabled = false; btn.style.opacity = "1";
            } else {
                btn.disabled = true; btn.style.opacity = "0.3";
            }
        },

        async withdraw() {
            const sid = prompt("ID Standoff 2:");
            if(!sid || sid.length < 5) return;
            const amt = Math.floor(this.data.gold);
            
            await this.db.collection('withdrawals').add({
                uid: this.uid, sid, amount: amt, status: '–û–∂–∏–¥–∞–Ω–∏–µ', date: new Date().toLocaleString()
            });
            
            this.data.gold -= amt;
            this.saveLocal();
            this.saveCloud();
            this.render();
            this.tg.showAlert("–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!");
            this.loadHistory();
        },

        async loadHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            const snap = await this.db.collection('withdrawals').where('uid', '==', this.uid).get();
            list.innerHTML = snap.empty ? "<center>–ù–µ—Ç –≤—ã–ø–ª–∞—Ç</center>" : "";
            snap.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `<div class="list-item"><b>${d.amount} G</b><span>${d.status}</span></div>`;
            });
        },

        async loadTop() {
            const list = document.getElementById('top-list');
            list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            const snap = await this.db.collection('players').orderBy('gold', 'desc').limit(50).get();
            list.innerHTML = "";
            let i = 1;
            snap.forEach(doc => {
                list.innerHTML += `<div class="list-item"><b>${i++}. ${doc.data().name}</b><span>${Math.floor(doc.data().gold)} G</span></div>`;
            });
        },

        async loadRefs() {
            const list = document.getElementById('ref-list');
            const snap = await this.db.collection('players').doc(this.uid).collection('referrals').get();
            document.getElementById('ref-val').innerText = snap.size;
            list.innerHTML = snap.empty ? "<center>–ù–µ—Ç –¥—Ä—É–∑–µ–π</center>" : "";
            snap.forEach(doc => {
                list.innerHTML += `<div class="list-item"><b>${doc.data().name}</b><span>+100 G</span></div>`;
            });
        },

        showAd(type) {
            const ad = Adsgram.init({ blockId: "19895" });
            ad.show().then(() => {
                if(type === 'gold') this.data.gold += 5; else this.data.pwr += 0.005;
                this.saveLocal(); this.render();
            });
        },

        invite() {
            const link = `https://t.me/Locus_Gold_bot/app?startapp=${this.uid}`;
            this.tg.openTelegramLink(`https://t.me/share/url?url=${link}&text=–ì–æ–ª–¥–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!`);
        },

        spawn(x, y) {
            const el = document.createElement('div');
            el.className = 'f-pop'; el.innerText = `+${this.data.pwr.toFixed(3)}`;
            el.style.left = x + 'px'; el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 700);
        },

        closeAC() {
            document.getElementById('ac-modal').style.display = 'none';
            this.isLocked = false;
            this.lastTaps = [];
        }
    };

    const UI = {
        nav(id, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('scr-' + id).classList.add('active');
            el.classList.add('active');
            if(id === 'top') Game.loadTop();
            if(id === 'ref') Game.loadRefs();
            if(id === 'wallet') Game.loadHistory();
        }
    };

    window.onload = () => Game.init();
    </script>
</body>
</html>
