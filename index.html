<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nebula: Zero | Galactic Command</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --neon: #00f2ff;
            --bg-deep: #020205;
            --panel: rgba(18, 18, 26, 0.95);
            --border: #1f1f2e;
            --gold: #ffcc00;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Orbitron', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-deep); 
            color: #fff; 
            height: 100vh; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* CANVAS BACKGROUND */
        #space-canvas {
            position: fixed;
            top: 0; left: 0;
            z-index: -1;
        }

        /* TOP HUD */
        .hud {
            padding: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .res-group { display: flex; gap: 15px; }
        .res-item { text-align: center; }
        .res-item i { color: var(--neon); font-size: 14px; display: block; }
        .res-item span { font-size: 12px; font-weight: bold; }

        /* MAIN INTERFACE */
        .main-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
        }

        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }

        /* MODULE CARDS */
        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 2px; height: 100%;
            background: var(--neon);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #111;
            margin-top: 10px;
            border-radius: 2px;
        }

        .progress-fill {
            height: 100%;
            background: var(--neon);
            width: 0%;
            transition: width 0.3s;
        }

        /* NAVIGATION CUSTOM */
        .nav-bar {
            background: var(--panel);
            border-top: 1px solid var(--border);
            display: flex;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-btn {
            flex: 1;
            padding: 15px 5px;
            text-align: center;
            color: var(--dim);
            font-size: 11px;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.3s;
        }

        .nav-btn.active { color: var(--neon); box-shadow: inset 0 2px 0 var(--neon); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* TABS INSIDE SCREENS */
        .sub-nav { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .sub-btn { 
            padding: 8px 16px; background: #1a1a24; border: 1px solid var(--border); 
            border-radius: 20px; font-size: 10px; white-space: nowrap; 
        }

    </style>
</head>
<body>

    <canvas id="space-canvas"></canvas>

    <div class="hud">
        <div class="res-group">
            <div class="res-item"><i class="fas fa-atom"></i><span id="res-matter">0</span></div>
            <div class="res-item"><i class="fas fa-bolt"></i><span id="res-energy">0</span></div>
        </div>
        <div class="rank-info">
            <small style="color:var(--neon)">LEVEL</small>
            <b id="player-lvl">1</b>
        </div>
    </div>

    <div class="main-container">
        
        <div id="scr-command" class="screen active">
            <div class="card" id="central-reactor" onclick="Engine.tap()">
                <h3>CENTRAL REACTOR</h3>
                <p style="font-size: 11px; color: #888;">Tap to catalyze dark matter</p>
                <div class="progress-bar"><div class="progress-fill" id="energy-bar"></div></div>
            </div>

            <div id="automated-modules">
                </div>
        </div>

        <div id="scr-tech" class="screen">
            <h3>TECHNOLOGY TREE</h3>
            <div id="tech-tree"></div>
        </div>

        <div id="scr-fleet" class="screen">
            <h3>GALACTIC EXPEDITIONS</h3>
            <div id="mission-list"></div>
        </div>

    </div>

    <div class="nav-bar">
        <div class="nav-btn active" onclick="UI.navigate('command', this)"><i class="fas fa-microchip"></i><br>Base</div>
        <div class="nav-btn" onclick="UI.navigate('tech', this)"><i class="fas fa-flask"></i><br>Tech</div>
        <div class="nav-btn" onclick="UI.navigate('fleet', this)"><i class="fas fa-rocket"></i><br>Fleet</div>
        <div class="nav-btn" onclick="UI.navigate('market', this)"><i class="fas fa-box"></i><br>Market</div>
    </div>

    <script>
        /**
         * GLOBAL GAME ENGINE - NEBULA: ZERO
         * Краткая документация:
         * 1. Engine - логика ресурсов и тиков.
         * 2. ResearchManager - дерево технологий.
         * 3. ExpeditionSystem - механика миссий.
         * 4. RenderCore - отрисовка Canvas.
         */

        const Engine = {
            state: {
                matter: 0,
                energy: 100,
                maxEnergy: 100,
                level: 1,
                exp: 0,
                lastTick: Date.now(),
                modules: [
                    { id: 'miner', name: 'Nano Miner', count: 0, baseCost: 15, power: 0.5 },
                    { id: 'bot', name: 'Logic Drone', count: 0, baseCost: 100, power: 2.5 }
                ]
            },

            init() {
                this.load();
                this.startLoops();
                UI.renderModules();
                RenderCore.init();
            },

            tap() {
                this.state.matter += 1;
                this.state.exp += 0.1;
                this.checkLevel();
                UI.updateHUD();
                Telegram.WebApp.HapticFeedback.impactOccurred('medium');
            },

            checkLevel() {
                const nextLevel = this.state.level * 100;
                if(this.state.exp >= nextLevel) {
                    this.state.level++;
                    Telegram.WebApp.showAlert(`Level Up! Current Rank: ${this.state.level}`);
                }
            },

            startLoops() {
                // Основной цикл 60 FPS для Canvas
                const loop = () => {
                    RenderCore.draw();
                    requestAnimationFrame(loop);
                };
                loop();

                // Экономический тик (1 секунда)
                setInterval(() => {
                    this.processEconomy();
                }, 1000);
            },

            processEconomy() {
                let production = 0;
                this.state.modules.forEach(m => {
                    production += m.count * m.power;
                });
                this.state.matter += production;
                UI.updateHUD();
            },

            buyModule(id) {
                const mod = this.state.modules.find(m => m.id === id);
                const cost = Math.floor(mod.baseCost * Math.pow(1.15, mod.count));
                
                if(this.state.matter >= cost) {
                    this.state.matter -= cost;
                    mod.count++;
                    UI.renderModules();
                    UI.updateHUD();
                }
            },

            save() {
                localStorage.setItem('nebula_zero_state', JSON.stringify(this.state));
            },

            load() {
                const data = localStorage.getItem('nebula_zero_state');
                if(data) this.state = Object.assign(this.state, JSON.parse(data));
            }
        };

        const UI = {
            navigate(screenId, btn) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('scr-' + screenId).classList.add('active');
                btn.classList.add('active');
            },

            updateHUD() {
                document.getElementById('res-matter').innerText = Math.floor(Engine.state.matter);
                document.getElementById('res-energy').innerText = Math.floor(Engine.state.energy);
                document.getElementById('player-lvl').innerText = Engine.state.level;
            },

            renderModules() {
                const container = document.getElementById('automated-modules');
                container.innerHTML = '';
                Engine.state.modules.forEach(m => {
                    const cost = Math.floor(m.baseCost * Math.pow(1.15, m.count));
                    container.innerHTML += `
                        <div class="card">
                            <div style="display:flex; justify-content:space-between">
                                <b>${m.name} [v.${m.count}]</b>
                                <button class="sub-btn" onclick="Engine.buyModule('${m.id}')">UPGRADE (${cost})</button>
                            </div>
                            <small style="color:#666">Produces ${m.power} matter/s</small>
                        </div>
                    `;
                });
            }
        };

        const RenderCore = {
            canvas: null, ctx: null, stars: [],
            init() {
                this.canvas = document.getElementById('space-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.onresize = () => this.resize();
                for(let i=0; i<100; i++) this.stars.push({
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height,
                    s: Math.random() * 2
                });
            },
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },
            draw() {
                this.ctx.fillStyle = '#020205';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.fillStyle = '#fff';
                this.stars.forEach(s => {
                    this.ctx.beginPath();
                    this.ctx.arc(s.x, s.y, s.s, 0, Math.PI*2);
                    this.ctx.fill();
                    s.y += 0.2;
                    if(s.y > this.canvas.height) s.y = 0;
                });
            }
        };

        window.onload = () => Engine.init();
    </script>
</body>
</html>
