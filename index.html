<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nebula Elite: Supernova</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        :root {
            --p-color: #00d4ff;
            --p-deep: #0055ff;
            --gold: #ffcc00;
            --bg: #050508;
            --card: rgba(255, 255, 255, 0.04);
            --brd: rgba(255, 255, 255, 0.08);
            --safe: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: none; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; position: fixed; width: 100%; }

        /* –≠—Ñ—Ñ–µ–∫—Ç –ø—ã–ª–∏ –Ω–∞ —Ñ–æ–Ω–µ */
        #bg-canvas { position: absolute; inset: 0; z-index: 0; pointer-events: none; }

        .app { position: relative; z-index: 10; display: flex; flex-direction: column; height: 100%; padding: 20px 20px calc(95px + var(--safe)); }

        /* Header */
        .header { text-align: center; margin-bottom: 20px; transition: transform 0.1s; }
        .bal-val { font-size: 50px; font-weight: 900; letter-spacing: -1px; background: linear-gradient(#fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 20px rgba(0,212,255,0.3)); }
        
        /* Level System */
        .lvl-container { background: var(--card); border: 1px solid var(--brd); padding: 14px; border-radius: 20px; backdrop-filter: blur(10px); margin-top: 15px; }
        .lvl-meta { display: flex; justify-content: space-between; font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--p-color); margin-bottom: 8px; letter-spacing: 1px; }
        .bar-outer { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden; border: 1px solid var(--brd); }
        .bar-inner { height: 100%; width: 0%; background: linear-gradient(90deg, var(--p-deep), var(--p-color)); box-shadow: 0 0 15px var(--p-color); transition: width 0.3s cubic-bezier(0.22, 1, 0.36, 1); }

        /* Crystal Zone */
        .game-core { flex: 1; display: flex; align-items: center; justify-content: center; perspective: 1000px; }
        .crystal { 
            width: 240px; height: 240px; 
            background: linear-gradient(135deg, var(--p-color), var(--p-deep));
            clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.05s ease-out;
            box-shadow: 0 0 50px rgba(0, 212, 255, 0.2);
            position: relative;
        }
        .crystal::after { content: ''; position: absolute; inset: 4px; background: rgba(0,0,0,0.1); clip-path: inherit; }
        .crystal span { font-size: 90px; z-index: 2; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3)); }

        /* Stats & Boost */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-card { background: var(--card); border: 1px solid var(--brd); padding: 14px; border-radius: 18px; text-align: center; }
        .stat-card small { font-size: 9px; color: rgba(255,255,255,0.4); text-transform: uppercase; display: block; margin-bottom: 4px; }
        .stat-card b { font-size: 18px; font-weight: 800; }

        .btn-boost { 
            grid-column: span 2; padding: 18px; border-radius: 20px; border: none;
            background: linear-gradient(135deg, #ff9d00, #ff5e00);
            color: #fff; font-weight: 900; font-size: 14px; text-transform: uppercase;
            box-shadow: 0 8px 20px rgba(255, 94, 0, 0.3); transition: 0.2s;
        }
        .btn-boost:active { transform: scale(0.96); }
        .btn-boost:disabled { filter: grayscale(1); opacity: 0.4; }

        /* UI Screens */
        .nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(75px + var(--safe)); background: rgba(5,5,8,0.9); backdrop-filter: blur(15px); display: flex; border-top: 1px solid var(--brd); padding-bottom: var(--safe); z-index: 1000; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #444; }
        .nav-btn.active { color: var(--p-color); }
        .nav-btn i { font-size: 24px; font-style: normal; margin-bottom: 2px; }
        .nav-btn span { font-size: 9px; font-weight: 800; text-transform: uppercase; }

        .screen { position: fixed; inset: 0; background: var(--bg); z-index: 500; display: none; padding: 30px 20px 110px; overflow-y: auto; }
        .screen.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .row { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--brd); }
        .row h4 { font-size: 16px; margin-bottom: 2px; }
        .row p { font-size: 12px; color: #666; }
        .price { background: #fff; color: #000; padding: 8px 12px; border-radius: 10px; font-weight: 900; font-size: 13px; }

        /* Vfx */
        .pop { position: absolute; pointer-events: none; font-weight: 900; animation: popUp 0.7s forwards; z-index: 2000; }
        @keyframes popUp { 0% { opacity: 1; transform: translate(-50%, 0) scale(1); } 100% { opacity: 0; transform: translate(-50%, -120px) scale(1.5); } }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>

    <div class="app" id="main-ui">
        <div class="header" id="header">
            <div class="bal-val" id="bal">0</div>
            <div class="lvl-container">
                <div class="lvl-meta">
                    <span id="lvl-name">–ö–∞–¥–µ—Ç</span>
                    <span id="lvl-num">–£–†. 1</span>
                </div>
                <div class="bar-outer"><div class="bar-inner" id="bar"></div></div>
            </div>
        </div>

        <div class="game-core">
            <div class="crystal" id="crystal"><span>üíé</span></div>
        </div>

        <div class="controls">
            <div class="stat-card"><small>–°–∏–ª–∞</small><b id="pwr">1.0</b></div>
            <div class="stat-card"><small>–ê–≤—Ç–æ</small><b id="dps">0.0</b></div>
            <button class="btn-boost" id="boost-btn" onclick="Game.activateBoost()">
                ‚ö° –ö–≤–∞–Ω—Ç–æ–≤—ã–π —Å–∫–∞—á–æ–∫ x3 (–†–ï–ö–õ–ê–ú–ê)
            </button>
        </div>
    </div>

    <div class="screen" id="scr-upg">
        <h2 style="margin-bottom:25px; text-align:center">–£–ª—É—á—à–µ–Ω–∏—è</h2>
        <div id="upg-list"></div>
    </div>

    <div class="screen" id="scr-market">
        <h2 style="margin-bottom:25px; text-align:center">–ú–∞—Ä–∫–µ—Ç</h2>
        <div class="row" style="flex-direction:column; text-align:center; gap:15px">
            <p>–ó–¥–µ—Å—å –≤—ã —Å–º–æ–∂–µ—Ç–µ –æ–±–º–µ–Ω—è—Ç—å –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –Ω–∞ Gold –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 15 —É—Ä–æ–≤–Ω—è.</p>
            <div id="m-lock" style="color:#ff3b30; font-weight:bold">–î–û–°–¢–£–ü–ù–û –° 15 –£–†–û–í–ù–Ø</div>
            <button id="m-btn" style="display:none; width:100%; padding:15px; border:none; border-radius:15px; background:var(--p-color); font-weight:900" onclick="Game.exchange()">–û–ë–ú–ï–ù–Ø–¢–¨ 1000 üíé</button>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-btn active" onclick="UI.nav('main', this)"><i>üõ∏</i><span>–î–æ–±—ã—á–∞</span></div>
        <div class="nav-btn" onclick="UI.nav('upg', this)"><i>üõ†Ô∏è</i><span>–ê–ø–≥—Ä–µ–π–¥—ã</span></div>
        <div class="nav-btn" onclick="UI.nav('market', this)"><i>üåå</i><span>–ú–∞—Ä–∫–µ—Ç</span></div>
    </nav>

    <script>
        // --- SOUND ENGINE ---
        const Sound = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            play(freq, type = 'sine', duration = 0.1) {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            }
        };

        // --- PARTICLE ENGINE ---
        const Canvas = {
            el: document.getElementById('bg-canvas'),
            ctx: null,
            parts: [],
            init() {
                this.ctx = this.el.getContext('2d');
                this.resize();
                window.onresize = () => this.resize();
                this.loop();
            },
            resize() {
                this.el.width = window.innerWidth;
                this.el.height = window.innerHeight;
            },
            spawn(x, y, color) {
                for(let i=0; i<8; i++) {
                    this.parts.push({
                        x, y, 
                        vx: (Math.random()-0.5)*10, 
                        vy: (Math.random()-0.5)*10, 
                        life: 1, 
                        c: color
                    });
                }
            },
            loop() {
                this.ctx.clearRect(0,0,this.el.width,this.el.height);
                this.parts.forEach((p, i) => {
                    p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                    this.ctx.fillStyle = p.c;
                    this.ctx.globalAlpha = p.life;
                    this.ctx.fillRect(p.x, p.y, 4, 4);
                    if(p.life <= 0) this.parts.splice(i, 1);
                });
                requestAnimationFrame(() => this.loop());
            }
        };

        // --- GAME ENGINE ---
        const Game = {
            state: { bal: 0, pwr: 1, dps: 0, xp: 0, lvl: 1, mult: 1, upgC: 0, upgA: 0 },
            titles: ["–ö–∞–¥–µ—Ç", "–°—Ç–∞—Ä–∞—Ç–µ–ª—å", "–¢–µ—Ö–Ω–∏–∫", "–°–µ—Ä–∂–∞–Ω—Ç", "–ú–∞—Å—Ç–µ—Ä", "–ü–∏–ª–æ—Ç", "–ö–∞–ø–∏—Ç–∞–Ω", "–ö–æ–º–∞–Ω–¥–æ—Ä", "–õ–µ–≥–µ–Ω–¥–∞", "–ê–≤–∞—Ç–∞—Ä–∞"],
            
            init() {
                this.load();
                Canvas.init();
                
                const cry = document.getElementById('crystal');
                cry.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    for(let t of e.changedTouches) this.tap(t.clientX, t.clientY);
                });

                setInterval(() => this.auto(), 100);
                setInterval(() => this.save(), 5000);
                this.render();
            },

            tap(x, y) {
                const gain = this.state.pwr * this.state.mult;
                this.state.bal += gain;
                this.state.xp += 15;
                
                this.checkLvl();
                this.render();
                this.vfx(x, y, gain);
                
                // –≠—Ñ—Ñ–µ–∫—Ç—ã
                document.getElementById('crystal').style.transform = 'scale(0.9) rotate(2deg)';
                setTimeout(() => document.getElementById('crystal').style.transform = 'scale(1)', 50);
                
                Sound.play(this.state.mult > 1 ? 800 : 400, 'square', 0.05);
                if(window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.impactOccurred('medium');
            },

            vfx(x, y, val) {
                const p = document.createElement('div');
                p.className = 'pop';
                p.style.left = x + 'px'; p.style.top = y + 'px';
                p.style.color = this.state.mult > 1 ? 'var(--gold)' : 'var(--p-color)';
                p.innerText = `+${val.toFixed(1)}`;
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 700);
                Canvas.spawn(x, y, this.state.mult > 1 ? '#ffcc00' : '#00d4ff');
            },

            auto() {
                if(this.state.dps > 0) {
                    this.state.bal += this.state.dps / 10;
                    this.render();
                }
            },

            checkLvl() {
                const req = this.state.lvl * 1000;
                if(this.state.xp >= req) {
                    this.state.xp = 0;
                    this.state.lvl++;
                    Sound.play(1200, 'sine', 0.3);
                    Telegram.WebApp.showAlert(`–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: ${this.titles[this.state.lvl-1] || "–ë–æ–≥"}`);
                }
            },

            activateBoost() {
                const btn = document.getElementById('boost-btn');
                // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Adsgram
                const ad = window.Adsgram ? Adsgram.init({ blockId: "19895" }) : null;
                
                const go = () => {
                    this.state.mult = 3;
                    btn.disabled = true;
                    let time = 30;
                    const inv = setInterval(() => {
                        time--;
                        btn.innerText = `–Ø–†–û–°–¢–¨ x3: ${time}—Å`;
                        if(time <= 0) {
                            clearInterval(inv);
                            this.state.mult = 1;
                            btn.disabled = false;
                            btn.innerText = `‚ö° –ö–≤–∞–Ω—Ç–æ–≤—ã–π —Å–∫–∞—á–æ–∫ x3 (–†–ï–ö–õ–ê–ú–ê)`;
                        }
                    }, 1000);
                };

                if(ad) ad.show().then(go).catch(go); else go();
            },

            buy(type) {
                const cost = type === 'pwr' ? 
                    Math.floor(100 * Math.pow(1.6, this.state.upgC)) : 
                    Math.floor(500 * Math.pow(1.7, this.state.upgA));

                if(this.state.bal >= cost) {
                    this.state.bal -= cost;
                    if(type === 'pwr') { this.state.upgC++; this.state.pwr += 0.5; }
                    else { this.state.upgA++; this.state.dps += 1.5; }
                    Sound.play(600, 'sine', 0.1);
                    this.render();
                    UI.upd();
                    this.save();
                } else {
                    Telegram.WebApp.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤!");
                }
            },

            render() {
                document.getElementById('bal').innerText = Math.floor(this.state.bal).toLocaleString();
                document.getElementById('pwr').innerText = (this.state.pwr * this.state.mult).toFixed(1);
                document.getElementById('dps').innerText = this.state.dps.toFixed(1);
                
                const idx = Math.min(this.state.lvl-1, this.titles.length-1);
                document.getElementById('lvl-name').innerText = this.titles[idx];
                document.getElementById('lvl-num').innerText = `–£–†. ${this.state.lvl}`;
                
                const req = this.state.lvl * 1000;
                document.getElementById('bar').style.width = (this.state.xp/req*100) + "%";

                if(this.state.lvl >= 15) {
                    document.getElementById('m-lock').style.display = 'none';
                    document.getElementById('m-btn').style.display = 'block';
                }
            },

            save() { localStorage.setItem('nebula_ultra_v4', JSON.stringify(this.state)); },
            load() { 
                const s = localStorage.getItem('nebula_ultra_v4'); 
                if(s) this.state = {...this.state, ...JSON.parse(s)}; 
            },
            exchange() {
                const id = prompt("–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä–æ–∫–∞:");
                if(id && this.state.bal >= 1000) {
                    this.state.bal -= 1000;
                    this.render();
                    this.save();
                    alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!");
                }
            }
        };

        const UI = {
            nav(id, btn) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                btn.classList.add('active');
                if(id !== 'main') {
                    document.getElementById('scr-' + id).classList.add('active');
                    if(id === 'upg') this.upd();
                }
            },
            upd() {
                const l = document.getElementById('upg-list');
                const pC = Math.floor(100 * Math.pow(1.6, Game.state.upgC));
                const pA = Math.floor(500 * Math.pow(1.7, Game.state.upgA));
                l.innerHTML = `
                    <div class="row" onclick="Game.buy('pwr')">
                        <div><h4>–õ–∞–∑–µ—Ä–Ω—ã–π –±—É—Ä</h4><p>+0.5 –∫ –∫–ª–∏–∫—É (–£—Ä. ${Game.state.upgC})</p></div>
                        <div class="price">${pC} üíé</div>
                    </div>
                    <div class="row" onclick="Game.buy('auto')">
                        <div><h4>–ê–≤—Ç–æ-—Å–±–æ—Ä—â–∏–∫</h4><p>+1.5/—Å–µ–∫ (–£—Ä. ${Game.state.upgA})</p></div>
                        <div class="price">${pA} üíé</div>
                    </div>
                `;
            }
        };

        window.onload = () => Game.init();
    </script>
</body>
</html>
