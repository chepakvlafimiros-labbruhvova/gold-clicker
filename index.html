<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gold Locus - Bonus System</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body {
            margin: 0; padding: 0; background-color: #000; color: #fff;
            font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; height: 100vh;
        }

        /* –°—Ç—Ä–∞–Ω–∏—Ü—ã */
        .page { display: none; flex-direction: column; align-items: center; width: 100%; flex-grow: 1; overflow-y: auto; }
        .page.active { display: flex; }

        /* –í–µ—Ä—Ö–Ω–∏–π —Å—á–µ—Ç—á–∏–∫ */
        .score-panel {
            width: 90%; background: #1a1a1a; border-radius: 20px;
            padding: 15px 0; text-align: center; margin-top: 20px; border: 1px solid #333;
        }
        #gold-display { font-size: 48px; font-weight: 900; color: #ffca28; }

        /* –ú–æ–Ω–µ—Ç–∞ */
        .coin-section { flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        #click-btn {
            width: 220px; height: 220px; background: #ffca28; border-radius: 50%;
            border: 8px solid #b8860b; font-size: 80px; cursor: pointer;
        }

        /* –°–ø–∏—Å–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ */
        .ref-list { width: 90%; margin-top: 20px; }
        .ref-item {
            background: #111; padding: 10px; border-radius: 10px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #222;
        }
        .progress-bar { width: 100px; height: 10px; background: #333; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: #2ecc71; width: 0%; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            width: 90%; padding: 15px; border-radius: 12px; border: none;
            font-weight: bold; cursor: pointer; margin: 10px 0; color: white;
        }
        .btn-blue { background: #3498db; }
        .btn-green { background: #2ecc71; }
        .btn-claim { background: #f1c40f; color: #000; display: none; }

        /* –¢–∞–±-–±–∞—Ä */
        .tab-bar { width: 100%; display: flex; background: #111; border-top: 1px solid #222; }
        .tab { flex: 1; padding: 15px; text-align: center; font-size: 12px; color: #555; }
        .tab.active { color: #ffca28; }
    </style>
</head>
<body>

    <div class="score-panel">
        <div id="gold-display">0</div>
    </div>

    <div id="page-main" class="page active">
        <div class="coin-section">
            <button id="click-btn" onclick="handleClick()">G</button>
        </div>
    </div>

    <div id="page-bonus" class="page">
        <button class="btn btn-blue" onclick="watchAd()">üì∫ –°–ú–û–¢–†–ï–¢–¨ –†–ï–ö–õ–ê–ú–£ (+10G)</button>
        <button class="btn btn-green" onclick="copyInviteLink()">üîó –ü–†–ò–ì–õ–ê–°–ò–¢–¨ –î–†–£–ì–ê</button>
        
        <h3>–í–∞—à–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–µ:</h3>
        <div id="ref-list-container" class="ref-list">
            </div>

        <button id="claim-btn" class="btn btn-claim" onclick="claimPrize()">üéÅ –ó–ê–ë–†–ê–¢–¨ –ü–†–ò–ó (100G)</button>
    </div>

    <div class="tab-bar">
        <div class="tab active" onclick="showPage('main')">–ì–õ–ê–í–ù–ê–Ø</div>
        <div class="tab" onclick="showPage('bonus')">–ë–û–ù–£–°–´</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCoa29KS-sin6hoRz0ZbE4f3ki0tZLwkKI",
            authDomain: "gold-clicker-5d882.firebaseapp.com",
            projectId: "gold-clicker-5d882",
            storageBucket: "gold-clicker-5d882.firebasestorage.app",
            messagingSenderId: "83489312782",
            appId: "1:83489312782:web:ee5b7bdc390e53e7dd6c5f"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        tg.expand();

        const userId = tg.initDataUnsafe?.user?.id ? tg.initDataUnsafe.user.id.toString() : "5223115893";
        const playerRef = db.collection('players').doc(userId);

        let gold = 0;
        let adsWatched = 0;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤—Ö–æ–¥–µ
        async function init() {
            const doc = await playerRef.get();
            const data = doc.data() || {};
            gold = data.gold || 0;
            adsWatched = data.adsWatched || 0;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
            const urlParams = new URLSearchParams(window.location.search);
            const refId = tg.initDataUnsafe.start_param;
            if (refId && refId !== userId && !data.referredBy) {
                // –ï—Å–ª–∏ –∑–∞—à–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ, –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∫ –∫–æ–º—É
                await playerRef.set({ referredBy: refId }, { merge: true });
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ
                await db.collection('players').doc(refId).collection('myRefs').doc(userId).set({
                    name: tg.initDataUnsafe.user.first_name || "–î—Ä—É–≥",
                    ads: 0
                });
            }

            updateUI();
            loadReferrals();
        }

        function updateUI() {
            document.getElementById('gold-display').innerText = gold;
        }

        // –ö–ª–∏–∫
        function handleClick() {
            gold++;
            updateUI();
            playerRef.update({ gold: gold });
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        // –†–µ–∫–ª–∞–º–∞
        async function watchAd() {
            // –ò–º–∏—Ç–∞—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            adsWatched++;
            gold += 10;
            updateUI();
            await playerRef.update({ gold: gold, adsWatched: adsWatched });
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —É –Ω–µ–≥–æ
            const doc = await playerRef.get();
            const refId = doc.data().referredBy;
            if (refId) {
                await db.collection('players').doc(refId).collection('myRefs').doc(userId).update({
                    ads: adsWatched
                });
            }
            tg.showAlert("–í—ã –ø–æ–ª—É—á–∏–ª–∏ +10G –∑–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä!");
            loadReferrals();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö
        async function loadReferrals() {
            const container = document.getElementById('ref-list-container');
            container.innerHTML = "";
            let readyToClaim = false;

            const snapshot = await playerRef.collection('myRefs').get();
            snapshot.forEach(doc => {
                const ref = doc.data();
                const progress = Math.min((ref.ads / 5) * 100, 100);
                if (ref.ads >= 5) readyToClaim = true;

                container.innerHTML += `
                    <div class="ref-item">
                        <span>${ref.name}</span>
                        <div>
                            <span style="font-size:10px">${ref.ads}/5 —Ä–µ–∫–ª–∞–º</span>
                            <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
                        </div>
                    </div>
                `;
            });

            if (readyToClaim) document.getElementById('claim-btn').style.display = 'block';
        }

        function copyInviteLink() {
            const link = `https://t.me/Locus_Gold_bot?start=${userId}`;
            tg.showAlert("–í–∞—à–∞ —Å—Å—ã–ª–∫–∞: " + link);
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if(page === 'bonus') loadReferrals();
        }

        init();
    </script>
</body>
</html>
