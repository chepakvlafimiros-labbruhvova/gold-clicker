<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Locus Gold Premium</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --gold: #FFD700;
            --gold-bright: #FFF5B7;
            --gold-dark: #B8860B;
            --bg: #000000;
            --surface: #121212;
            --surface-light: #1e1e1e;
            --text-main: #FFFFFF;
            --text-dim: #A0A0A0;
            --accent-blue: #007AFF;
            --accent-green: #34C759;
            --accent-red: #FF3B30;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none; -webkit-user-select: none;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Roboto", sans-serif;
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* –ü–†–ï–ú–ò–£–ú –î–ò–ó–ê–ô–ù –°–ß–ï–¢–ê */
        .header {
            padding: 30px 20px 20px;
            display: flex; flex-direction: column; align-items: center;
            background: radial-gradient(circle at top, #1a1a1a 0%, #000 100%);
        }

        .balance-card {
            width: 100%; max-width: 360px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 28px;
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: ''; position: absolute; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255,215,0,0.1), transparent);
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate { 100% { transform: rotate(360deg); } }

        .balance-label {
            font-size: 11px; font-weight: 800; color: var(--gold);
            letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px;
            position: relative; z-index: 1;
        }

        .balance-value {
            font-size: 56px; font-weight: 900; letter-spacing: -1px;
            background: linear-gradient(180deg, var(--gold-bright) 0%, var(--gold) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            position: relative; z-index: 1;
        }

        /* –ö–û–ù–¢–ï–ù–¢ –ò –°–¢–†–ê–ù–ò–¶–´ */
        .viewport {
            flex: 1; position: relative; width: 100%;
        }

        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center;
            padding: 20px; overflow-y: auto;
        }

        .page.active { display: flex; animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* –ú–û–ù–ï–¢–ê: –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–ò–ó–ò–ö–ê */
        .clicker-container {
            flex: 1; display: flex; align-items: center; justify-content: center;
            width: 100%; min-height: 300px;
        }

        .coin-outer {
            width: 280px; height: 280px;
            background: #111; border-radius: 50%;
            padding: 12px; border: 1px solid #333;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }

        .coin-inner {
            width: 100%; height: 100%;
            background: linear-gradient(145deg, var(--gold) 0%, var(--gold-dark) 100%);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 120px; font-weight: 900; color: rgba(0,0,0,0.7);
            cursor: pointer; position: relative;
            box-shadow: inset 0 4px 10px rgba(255,255,255,0.5), inset 0 -4px 10px rgba(0,0,0,0.3);
            transition: transform 0.05s;
        }

        .coin-inner:active { transform: scale(0.92); }

        /* –ö–ù–û–ü–ö–ò */
        .action-stack { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 14px; }

        .main-btn {
            width: 100%; padding: 22px; border-radius: 20px; border: none;
            font-size: 17px; font-weight: 700; color: #fff;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            transition: all 0.2s;
        }

        .btn-blue { background: linear-gradient(90deg, #007AFF, #00C7FF); }
        .btn-green { background: linear-gradient(90deg, #34C759, #30D158); }
        .btn-disabled { background: #222; color: #555; pointer-events: none; }
        .btn-withdraw-active { background: linear-gradient(90deg, #FF9500, #FFCC00); color: #000; }

        /* –°–ü–ò–°–ö–ò */
        .card-list {
            width: 100%; background: var(--surface); border-radius: 24px;
            margin-top: 20px; border: 1px solid #222; overflow: hidden;
        }

        .card-item {
            padding: 18px 20px; border-bottom: 1px solid #222;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* –¢–ê–ë-–ë–ê–† (iOS Style) */
        .tab-bar {
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; height: 85px; padding-bottom: var(--safe-area-bottom);
        }

        .tab {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            justify-content: center; color: #666; font-size: 10px; font-weight: 700;
        }

        .tab.active { color: var(--gold); }
        .tab-icon { font-size: 24px; margin-bottom: 4px; }

        /* –ü–õ–ê–í–ê–Æ–©–ò–ô –¢–ï–ö–°–¢ (+1) */
        .tap-anim {
            position: absolute; color: var(--gold); font-weight: 900;
            font-size: 32px; pointer-events: none;
            animation: tapFloat 0.7s ease-out forwards;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        @keyframes tapFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-120px) scale(1.2); opacity: 0; }
        }

        #sync-indicator {
            position: fixed; top: env(safe-area-inset-top); right: 20px;
            width: 8px; height: 8px; border-radius: 50%; background: #34C759;
            box-shadow: 0 0 10px #34C759; z-index: 9999;
        }
    </style>
</head>
<body>

    <div id="sync-indicator"></div>

    <header class="header">
        <div class="balance-card">
            <div class="balance-label">Current Balance</div>
            <div id="gold-value" class="balance-value">0</div>
        </div>
    </header>

    <main class="viewport">
        <div id="page-main" class="page active">
            <div class="clicker-container">
                <div class="coin-outer">
                    <div id="click-target" class="coin-inner">G</div>
                </div>
            </div>
            <p style="color: #444; font-size: 12px; font-weight: bold;">v3.0 ENTERPRISE STABLE</p>
        </div>

        <div id="page-bonuses" class="page">
            <div class="action-stack">
                <button class="main-btn btn-blue" onclick="App.handleAd()">
                    <span>üì∫</span> Watch Ad & Get +10G
                </button>
                <button class="main-btn btn-green" onclick="App.copyRef()">
                    <span>üîó</span> Invite Friends
                </button>
            </div>
            <div class="card-list" id="ref-container">
                <div style="padding: 30px; text-align: center; color: #555;">No referrals yet</div>
            </div>
        </div>

        <div id="page-withdraw" class="page">
            <div class="action-stack">
                <button id="withdraw-btn" class="main-btn btn-disabled" onclick="App.initWithdraw()">
                    <span>üè¶</span> Withdraw Gold
                </button>
            </div>
            <div class="card-list" id="history-container">
                <div style="padding: 30px; text-align: center; color: #555;">History is empty</div>
            </div>
        </div>
    </main>

    <nav class="tab-bar">
        <div class="tab active" onclick="App.setTab('main', this)">
            <span class="tab-icon">ü™ô</span><span>MAIN</span>
        </div>
        <div class="tab" onclick="App.setTab('bonuses', this)">
            <span class="tab-icon">üíé</span><span>BONUS</span>
        </div>
        <div class="tab" onclick="App.setTab('withdraw', this)">
            <span class="tab-icon">üìä</span><span>WALLET</span>
        </div>
    </nav>

    <script>
        /**
         * –ö–û–†–ü–û–†–ê–¢–ò–í–ù–û–ï –Ø–î–†–û –°–ò–°–¢–ï–ú–´ (THE CORE)
         */
        const App = {
            db: null,
            tg: window.Telegram.WebApp,
            uid: null,
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ (Memory)
            state: {
                gold: 0,
                journal: 0, // –ù–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–ª–∏–∫–∏ (WAL)
                isSyncing: false,
                lastSyncTime: Date.now()
            },

            // –ö–æ–Ω—Ñ–∏–≥
            config: {
                minWithdraw: 750,
                syncInterval: 2500, // –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∫–∞–∂–¥—ã–µ 2.5 —Å–µ–∫
                fb: {
                    apiKey: "AIzaSyCoa29KS-sin6hoRz0ZbE4f3ki0tZLwkKI",
                    authDomain: "gold-clicker-5d882.firebaseapp.com",
                    projectId: "gold-clicker-5d882",
                    storageBucket: "gold-clicker-5d882.firebasestorage.app",
                    messagingSenderId: "83489312782",
                    appId: "1:83489312782:web:ee5b7bdc390e53e7dd6c5f"
                }
            },

            async init() {
                this.tg.expand();
                this.tg.ready();
                this.uid = this.tg.initDataUnsafe?.user?.id?.toString() || "DEBUG_5223115893";

                // Firebase Init
                if (!firebase.apps.length) firebase.initializeApp(this.config.fb);
                this.db = firebase.firestore();

                // 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∂—É—Ä–Ω–∞–ª–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç –∫—Ä–∞—à–∞)
                const savedJournal = localStorage.getItem('locus_journal');
                if (savedJournal) this.state.journal = Number(savedJournal);

                // 2. –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
                await this.syncData();
                
                // 3. –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–æ–≤
                this.startHeartbeat();
                this.bindInputs();
                this.render();
            },

            /**
             * –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø: –ê–¢–û–ú–ê–†–ù–ê–Ø –ò –ë–ï–ó–û–ü–ê–°–ù–ê–Ø
             */
            async syncData() {
                if (this.state.isSyncing) return;
                this.state.isSyncing = true;
                this.setSyncIndicator(true);

                try {
                    const toSync = this.state.journal;
                    const docRef = this.db.collection('players').doc(this.uid);

                    if (toSync > 0) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –±–∞–∑–µ —Ç–æ–ª—å–∫–æ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç (–¥–µ–ª—å—Ç—É)
                        await docRef.update({
                            gold: firebase.firestore.FieldValue.increment(toSync),
                            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        this.state.journal -= toSync;
                        localStorage.setItem('locus_journal', this.state.journal);
                    }

                    // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    const doc = await docRef.get();
                    if (doc.exists) {
                        this.state.gold = doc.data().gold || 0;
                    } else {
                        await docRef.set({ gold: 0, name: this.tg.initDataUnsafe?.user?.first_name || "Unknown" });
                    }

                } catch (e) {
                    console.error("Sync Error:", e);
                } finally {
                    this.state.isSyncing = false;
                    this.setSyncIndicator(false);
                    this.render();
                }
            },

            /**
             * HEARTBEAT: –ü–û–°–¢–û–Ø–ù–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï
             */
            startHeartbeat() {
                setInterval(() => {
                    if (this.state.journal > 0) this.syncData();
                }, this.config.syncInterval);

                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏
                window.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') this.syncData();
                });
            },

            /**
             * –û–ë–†–ê–ë–û–¢–ö–ê –í–í–û–î–ê
             */
            bindInputs() {
                const target = document.getElementById('click-target');
                
                const handler = (e) => {
                    e.preventDefault();
                    const x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    const y = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                    // 1. –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–º—è—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
                    this.state.gold++;
                    this.state.journal++;
                    localStorage.setItem('locus_journal', this.state.journal);

                    // 2. –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                    this.render();
                    this.spawnTapAnim(x, y);
                    if (this.tg.HapticFeedback) this.tg.HapticFeedback.impactOccurred('medium');
                };

                target.addEventListener('touchstart', handler, {passive: false});
            },

            /**
             * –ì–†–ê–§–ò–ß–ï–°–ö–ò–ô –î–í–ò–ñ–û–ö (RENDER)
             */
            render() {
                const valEl = document.getElementById('gold-value');
                const wBtn = document.getElementById('withdraw-btn');
                
                // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Ü–∏—Ñ—Ä
                valEl.innerText = Math.floor(this.state.gold).toLocaleString();

                if (this.state.gold >= this.config.minWithdraw) {
                    wBtn.className = "main-btn btn-withdraw-active";
                    wBtn.innerText = "üè¶ WITHDRAW GOLD NOW";
                } else {
                    wBtn.className = "main-btn btn-disabled";
                    wBtn.innerText = `NEED ${this.config.minWithdraw - Math.floor(this.state.gold)} G MORE`;
                }
            },

            spawnTapAnim(x, y) {
                const el = document.createElement('div');
                el.className = 'tap-anim';
                el.innerText = '+1';
                el.style.left = `${x - 20}px`;
                el.style.top = `${y - 40}px`;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 700);
            },

            /**
             * –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–´–ï –ú–û–î–£–õ–ò
             */
            async initWithdraw() {
                if (this.state.gold < this.config.minWithdraw) return;

                const wallet = prompt("Enter your Wallet Address (TON/Card):");
                if (!wallet || wallet.length < 5) return;

                this.tg.showConfirm(`Confirm withdrawal of ${Math.floor(this.state.gold)} G?`, async (ok) => {
                    if (ok) {
                        try {
                            const amount = Math.floor(this.state.gold);
                            const tx = { amount, wallet, status: 'pending', date: new Date().toLocaleString() };
                            
                            await this.db.collection('withdrawals').add({ ...tx, uid: this.uid });
                            await this.db.collection('players').doc(this.uid).collection('history').add(tx);
                            
                            // –û–±–Ω—É–ª–µ–Ω–∏–µ
                            this.state.gold = 0;
                            this.state.journal = 0;
                            await this.db.collection('players').doc(this.uid).update({ gold: 0 });
                            
                            this.render();
                            this.loadHistory();
                            this.tg.showAlert("Success! Your request is being processed.");
                        } catch (e) {
                            this.tg.showAlert("Error creating request.");
                        }
                    }
                });
            },

            handleAd() {
                this.tg.showPopup({
                    title: "Watching Advertisement",
                    message: "Watch a short video to get 10 Gold coins.",
                    buttons: [{type: "default", text: "Watch"}]
                }, async () => {
                    // –°–∏–º—É–ª—è—Ü–∏—è –Ω–∞–≥—Ä–∞–¥—ã
                    this.state.gold += 10;
                    this.state.journal += 10;
                    this.render();
                    this.syncData();
                });
            },

            copyRef() {
                const link = `https://t.me/Locus_Gold_bot/Locus_Gold?startapp=${this.uid}`;
                const el = document.createElement('textarea');
                el.value = link; document.body.appendChild(el); el.select();
                document.execCommand('copy'); document.body.removeChild(el);
                this.tg.showAlert("Invite link copied!");
            },

            setTab(id, el) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.getElementById(`page-${id}`).classList.add('active');
                el.classList.add('active');
                if (id === 'withdraw') this.loadHistory();
            },

            setSyncIndicator(syncing) {
                document.getElementById('sync-indicator').style.opacity = syncing ? "1" : "0.2";
            },

            async loadHistory() {
                const cont = document.getElementById('history-container');
                const snap = await this.db.collection('players').doc(this.uid).collection('history').orderBy('date', 'desc').limit(5).get();
                if (snap.empty) return;
                cont.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    cont.innerHTML += `<div class="card-item"><div><b>${d.amount}G</b><br><small>${d.date}</small></div><span style="color:orange">${d.status}</span></div>`;
                });
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
