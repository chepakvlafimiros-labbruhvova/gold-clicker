<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nebula: Cloud Empire</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --p-color: #00d4ff; --gold: #ffcc00; --bg: #050608;
            --card: rgba(255, 255, 255, 0.04); --brd: rgba(255, 255, 255, 0.08);
            --safe: env(safe-area-inset-bottom);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: none; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; position: fixed; width: 100%; }
        #fx-canvas { position: absolute; inset: 0; z-index: 5; pointer-events: none; }
        .app { position: relative; z-index: 10; display: flex; flex-direction: column; height: 100%; padding: 20px 20px calc(85px + var(--safe)); }
        
        /* UI Elements */
        .header { text-align: center; margin-bottom: 10px; }
        .bal-main { font-size: 44px; font-weight: 900; background: linear-gradient(#fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .gold-row { display: flex; justify-content: center; align-items: center; gap: 8px; color: var(--gold); font-weight: 800; font-size: 20px; }
        
        .lvl-box { background: var(--card); border: 1px solid var(--brd); padding: 12px; border-radius: 18px; margin-top: 10px; }
        .lvl-meta { display: flex; justify-content: space-between; font-size: 10px; font-weight: 800; color: var(--p-color); margin-bottom: 6px; text-transform: uppercase; }
        .bar-wrap { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 10px; overflow: hidden; position: relative; }
        .bar-fill { position: absolute; top: 0; left: 0; height: 100%; width: 100%; background: var(--p-color); transform-origin: left; transform: scaleX(0); will-change: transform; }

        .mine-zone { flex: 1; display: flex; align-items: center; justify-content: center; }
        .crystal { 
            width: 220px; height: 220px; background: linear-gradient(135deg, var(--p-color), #0044ff);
            clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%);
            display: flex; align-items: center; justify-content: center; transition: transform 0.05s;
        }
        .crystal span { font-size: 80px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.4)); }

        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: var(--card); border: 1px solid var(--brd); padding: 12px; border-radius: 15px; text-align: center; }
        .card small { font-size: 9px; opacity: 0.5; text-transform: uppercase; display: block; }
        .btn-boost { grid-column: span 2; padding: 16px; border-radius: 18px; border: none; background: linear-gradient(135deg, #ff9d00, #ff5e00); color: #fff; font-weight: 900; text-transform: uppercase; margin-top: 5px; }

        /* Navigation */
        .nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(75px + var(--safe)); background: rgba(5,6,8,0.95); display: flex; border-top: 1px solid var(--brd); padding-bottom: var(--safe); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #444; }
        .nav-item.active { color: var(--p-color); }

        .screen { position: fixed; inset: 0; background: var(--bg); z-index: 500; display: none; padding: 30px 20px 110px; overflow-y: auto; }
        .screen.active { display: block; }
        .item { background: var(--card); padding: 16px; border-radius: 18px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--brd); }
    </style>
</head>
<body>
    <canvas id="fx-canvas"></canvas>
    <div class="app">
        <div class="header">
            <div class="bal-main" id="ui-bal">0</div>
            <div class="gold-row">üí∞ <span id="ui-gold">0</span></div>
            <div class="lvl-box">
                <div class="lvl-meta"><span id="ui-rank">–®–ê–•–¢–ï–†</span><span id="ui-lvl">–£–†. 1</span></div>
                <div class="bar-wrap"><div class="bar-fill" id="ui-bar"></div></div>
            </div>
        </div>
        <div class="mine-zone"><div class="crystal" id="crystal"><span>üíé</span></div></div>
        <div class="stats">
            <div class="card"><small>–ö–ï–†–ù</small><b id="ui-pwr">1.0</b></div>
            <div class="card"><small>–ê–í–¢–û</small><b id="ui-dps">0.0</b></div>
            <button class="btn-boost" onclick="Game.runAd()">üöÄ –§–û–†–°–ê–ñ x3 (AD)</button>
        </div>
    </div>

    <div class="screen" id="scr-shop"><h2>–ú–∞–≥–∞–∑–∏–Ω</h2><div id="shop-list"></div></div>
    
    <div class="screen" id="scr-ref">
        <h2>–ê—Ä—Ç–µ–ª—å</h2>
        <div class="item" style="flex-direction:column; gap:10px; text-align:center">
            <p>–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π <b style="color:var(--p-color)">20%</b> –æ—Ç –∏—Ö –¥–æ–±—ã—á–∏!</p>
            <button class="btn-boost" style="width:100%" onclick="Game.invite()">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>
        </div>
        <div id="ref-list"></div>
    </div>

    <div class="screen" id="scr-market">
        <h2>–†–µ–∑–µ—Ä–≤</h2>
        <div class="item" style="flex-direction:column; gap:15px; text-align:center">
            <p>–û–±–º–µ–Ω 100,000 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ ‚ûî 1 —Å–ª–∏—Ç–æ–∫</p>
            <button id="m-btn" class="btn-boost" style="width:100%; display:none" onclick="Game.exchange()">–í—ã–ø–ª–∞–≤–∏—Ç—å –∑–æ–ª–æ—Ç–æ</button>
            <button id="ui-withdraw" class="btn-boost" style="width:100%; background:var(--gold); color:#000; display:none" onclick="Game.withdraw()">–í—ã–≤–µ—Å—Ç–∏ 100 —Å–ª–∏—Ç–∫–æ–≤</button>
            <div id="m-lock" style="color:red; font-weight:bold">–ù–£–ñ–ï–ù 15 –£–†–û–í–ï–ù–¨</div>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="UI.go('main', this)"><i>‚õèÔ∏è</i></div>
        <div class="nav-item" onclick="UI.go('shop', this)"><i>üõí</i></div>
        <div class="nav-item" onclick="UI.go('ref', this)"><i>üë•</i></div>
        <div class="nav-item" onclick="UI.go('market', this)"><i>üí∞</i></div>
    </nav>

    <script>
        const Game = {
            d: { bal: 0, gold: 0, pwr: 1, dps: 0, xp: 0, lvl: 1, mult: 1, u: [0,0,0,0] },
            shop: [
                { n: "–ö–∏—Ä–∫–∞", p: 100, b: 0.5, t: 'pwr' },
                { n: "–ë—É—Ä", p: 500, b: 1.5, t: 'dps' },
                { n: "–õ–∞–∑–µ—Ä", p: 2000, b: 5, t: 'pwr' },
                { n: "–ò–ò-–®–∞—Ö—Ç–∞", p: 10000, b: 25, t: 'dps' }
            ],

            async init() {
                await this.load();
                FX.init();
                document.getElementById('crystal').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    for(let t of e.changedTouches) this.tap(t.clientX, t.clientY);
                });
                setInterval(() => this.tick(), 100);
                setInterval(() => this.save(), 10000); // –û–±–ª–∞—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–∑ –≤ 10 —Å–µ–∫
                this.renderLoop();
            },

            tap(x, y) {
                const g = this.d.pwr * this.d.mult;
                this.d.bal += g; this.d.xp += 15;
                FX.pop(x, y, `+${g.toFixed(1)}`);
                if(window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.impactOccurred('light');
                document.getElementById('crystal').style.transform = 'scale(0.95)';
                setTimeout(()=> document.getElementById('crystal').style.transform='scale(1)', 40);
                this.checkLvl();
            },

            tick() { if(this.d.dps > 0) this.d.bal += this.d.dps/10; },

            checkLvl() {
                const req = this.d.lvl * 1000;
                if(this.d.xp >= req) { this.d.xp = 0; this.d.lvl++; this.save(); }
            },

            renderLoop() {
                document.getElementById('ui-bal').innerText = Math.floor(this.d.bal).toLocaleString();
                document.getElementById('ui-gold').innerText = this.d.gold;
                document.getElementById('ui-pwr').innerText = (this.d.pwr * this.d.mult).toFixed(1);
                document.getElementById('ui-dps').innerText = this.d.dps.toFixed(1);
                document.getElementById('ui-lvl').innerText = `–£–†. ${this.d.lvl}`;
                
                const req = this.d.lvl * 1000;
                document.getElementById('ui-bar').style.transform = `scaleX(${Math.min(this.d.xp/req, 1)})`;

                document.getElementById('m-btn').style.display = this.d.lvl >= 15 ? 'block' : 'none';
                document.getElementById('m-lock').style.display = this.d.lvl >= 15 ? 'none' : 'block';
                document.getElementById('ui-withdraw').style.display = this.d.gold >= 100 ? 'block' : 'none';

                requestAnimationFrame(() => this.renderLoop());
            },

            async save() {
                const dataStr = JSON.stringify(this.d);
                localStorage.setItem('nebula_backup', dataStr); // –õ–æ–∫–∞–ª—å–Ω—ã–π –±—ç–∫–∞–ø
                if (window.Telegram?.WebApp?.CloudStorage) {
                    Telegram.WebApp.CloudStorage.setItem('game_data', dataStr);
                }
            },

            async load() {
                return new Promise((res) => {
                    if (window.Telegram?.WebApp?.CloudStorage) {
                        Telegram.WebApp.CloudStorage.getItem('game_data', (err, val) => {
                            const saved = val || localStorage.getItem('nebula_backup');
                            if(saved) this.d = {...this.d, ...JSON.parse(saved)};
                            res();
                        });
                    } else {
                        const saved = localStorage.getItem('nebula_backup');
                        if(saved) this.d = {...this.d, ...JSON.parse(saved)};
                        res();
                    }
                });
            },

            exchange() {
                if(this.d.bal >= 100000) { this.d.bal -= 100000; this.d.gold += 1; this.save(); }
            },

            invite() {
                const uid = Telegram.WebApp.initDataUnsafe?.user?.id || "0";
                Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=https://t.me/YOUR_BOT/app?startapp=${uid}&text=–î–æ–±—ã–≤–∞–π –∑–æ–ª–æ—Ç–æ —Å–æ –º–Ω–æ–π!`);
            },

            buy(i) {
                const itm = this.shop[i];
                const cost = Math.floor(itm.p * Math.pow(1.6, this.d.u[i]));
                if(this.d.bal >= cost) {
                    this.d.bal -= cost; this.d.u[i]++;
                    if(itm.t === 'pwr') this.d.pwr += itm.b; else this.d.dps += itm.b;
                    UI.drawShop(); this.save();
                }
            }
        };

        const FX = {
            c: document.getElementById('fx-canvas'), ctx: null, p: [],
            init() { this.ctx = this.c.getContext('2d'); this.res(); window.onresize = () => this.res(); this.loop(); },
            res() { this.c.width = window.innerWidth; this.c.height = window.innerHeight; },
            pop(x, y, t) { this.p.push({ x, y, t, a: 1 }); },
            loop() {
                this.ctx.clearRect(0,0,this.c.width,this.c.height);
                this.ctx.font = "bold 24px sans-serif";
                for(let i=this.p.length-1; i>=0; i--) {
                    let p = this.p[i]; p.y -= 2; p.a -= 0.02;
                    this.ctx.fillStyle = `rgba(0, 212, 255, ${p.a})`;
                    this.ctx.fillText(p.t, p.x, p.y);
                    if(p.a <= 0) this.p.splice(i, 1);
                }
                requestAnimationFrame(() => this.loop());
            }
        };

        const UI = {
            go(id, el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                el.classList.add('active');
                if(id !== 'main') {
                    document.getElementById('scr-'+id).classList.add('active');
                    if(id === 'shop') this.drawShop();
                }
            },
            drawShop() {
                document.getElementById('shop-list').innerHTML = Game.shop.map((itm, i) => {
                    const cost = Math.floor(itm.p * Math.pow(1.6, Game.d.u[i]));
                    return `<div class="item" onclick="Game.buy(${i})">
                        <div><b>${itm.n}</b><br><small>+${itm.b} –º–æ—â—å</small></div>
                        <div style="font-weight:900">${cost.toLocaleString()} üíé</div>
                    </div>`;
                }).join('');
            }
        };

        window.onload = () => Game.init();
    </script>
</body>
</html>
