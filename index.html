<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Locus Gold Elite Pro</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        :root {
            --bg: #000000;
            --surface: #111112;
            --accent: #ff9d00;
            --accent-dim: #b36e00;
            --error: #ff3b30;
            --text-dim: #8e8e93;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; position: fixed; width: 100%; display: flex; flex-direction: column; }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —ç–∫—Ä–∞–Ω–æ–≤ */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; padding: 20px 16px calc(80px + var(--safe-bottom)); overflow-y: auto; }
        .screen.active { display: flex; animation: screenIn 0.25s ease-out; }
        @keyframes screenIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –®–∞–ø–∫–∞ */
        .rank-tag { align-self: center; background: #222; padding: 4px 14px; border-radius: 20px; color: var(--accent); font-size: 11px; font-weight: 800; text-transform: uppercase; margin-bottom: 10px; }
        .balance-main { font-size: 52px; font-weight: 900; text-align: center; color: var(--accent); margin-bottom: 20px; letter-spacing: -1px; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 30px; }
        .stat-box { background: var(--surface); border-radius: 18px; padding: 15px; text-align: center; border: 1px solid #1c1c1e; }
        .stat-box span { display: block; color: var(--text-dim); font-size: 10px; text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
        .stat-box b { font-size: 18px; color: #fff; }

        /* –ú–æ–Ω–µ—Ç–∞ */
        .mining-area { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; min-height: 250px; }
        .coin-wrapper { position: relative; cursor: pointer; transition: transform 0.05s; user-select: none; }
        .coin-wrapper:active { transform: scale(0.92); }
        .coin-circle { width: 240px; height: 240px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #ffc400, #ff8000); border: 12px solid #1a1a1c; box-shadow: 0 0 50px rgba(255,157,0,0.1); display: flex; align-items: center; justify-content: center; }
        .coin-circle span { font-size: 90px; font-weight: 900; color: rgba(0,0,0,0.15); }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .btn-act { background: var(--surface); border: 1px solid #222; border-radius: 20px; padding: 15px 10px; text-align: center; color: #fff; text-decoration: none; }
        .btn-act img { width: 24px; margin-bottom: 6px; }
        .btn-act b { display: block; font-size: 14px; }
        .btn-act small { color: var(--accent); font-size: 10px; font-weight: 700; }

        .btn-upgrade { grid-column: span 2; background: none; border: 1.5px solid var(--accent); padding: 20px; border-radius: 22px; margin-top: 10px; position: relative; overflow: hidden; }
        .btn-upgrade:disabled { opacity: 0.4; border-color: #333; }
        .btn-upgrade b { display: block; font-size: 15px; margin-bottom: 4px; }
        .btn-upgrade span { color: var(--text-dim); font-size: 11px; }

        /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é (–ö–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ) */
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: calc(65px + var(--safe-bottom)); background: #080808; border-top: 1px solid #161618; display: flex; padding-bottom: var(--safe-bottom); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dim); transition: 0.2s; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 22px; margin-bottom: 4px; }
        .nav-item span { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        /* –°–ø–∏—Å–∫–∏ */
        .list-container { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .card-item { background: var(--surface); padding: 16px; border-radius: 18px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #1c1c1e; }
        .card-info h4 { font-size: 14px; margin-bottom: 2px; }
        .card-info p { font-size: 11px; color: var(--text-dim); }
        .card-val { font-weight: 800; color: var(--accent); }

        /* –ê–Ω—Ç–∏—á–∏—Ç */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 30px; }
        .modal-body { background: #1c1c1e; padding: 30px; border-radius: 28px; text-align: center; border: 1px solid var(--error); width: 100%; }
        .modal-body h2 { color: var(--error); margin-bottom: 12px; }
        .modal-body p { color: #fff; line-height: 1.5; margin-bottom: 25px; }

        .f-pop { position: absolute; color: var(--accent); font-weight: 900; pointer-events: none; animation: fPop 0.7s ease-out forwards; font-size: 26px; z-index: 500; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        @keyframes fPop { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-120px) scale(1.2); } }
    </style>
</head>
<body>

    <div class="modal" id="modal-ac">
        <div class="modal-body">
            <div style="font-size: 40px; margin-bottom: 10px;">üõ°Ô∏è</div>
            <h2>–°–¢–û–ü-–ö–õ–ò–ö–ï–†!</h2>
            <p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º –∑–∞–ø—Ä–µ—â–µ–Ω–æ. –£–ª—É—á—à–∞–π—Ç–µ —Å–∏–ª—É –∫–ª–∏–∫–∞ –∏–ª–∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã –∑–∞ —Ä–µ–∫–ª–∞–º—É!</p>
            <button class="btn-act btn-upgrade" style="background: var(--accent); color: #000; border: none; width: 100%;" onclick="App.closeAC()"><b>–•–û–†–û–®–û, –Ø –ü–û–ù–Ø–õ</b></button>
        </div>
    </div>

    <div class="screen active" id="scr-mining">
        <div class="rank-tag" id="rank-name">BRONZE</div>
        <div class="balance-main"><span id="val-gold">0.000</span> G</div>
        
        <div class="stats-grid">
            <div class="stat-box"><span>–°–∏–ª–∞ –∫–ª–∏–∫–∞</span><b id="val-pwr">0.001</b></div>
            <div class="stat-box"><span>–†–µ—Ñ–µ—Ä–∞–ª—ã</span><b id="val-refs">0</b></div>
        </div>

        <div class="mining-area">
            <div class="coin-wrapper" id="coin-trigger">
                <div class="coin-circle"><span>G</span></div>
            </div>
        </div>

        <div class="actions-grid">
            <div class="btn-act" id="ad-bonus"><b>–ë–û–ù–£–° +5.0 G</b><small>ADSGRAM</small></div>
            <div class="btn-act" id="ad-power"><b>–°–ò–õ–ê +0.005</b><small>–†–ï–ö–õ–ê–ú–ê</small></div>
            <button class="btn-upgrade" id="btn-upg">
                <b id="upg-title">–£–õ–£–ß–®–ò–¢–¨ –ó–ê 1.000 G</b>
                <span id="upg-desc">+0.005 –ö –°–ò–õ–ï</span>
            </button>
        </div>
    </div>

    <div class="screen" id="scr-top">
        <h2 style="text-align:center; margin-bottom:20px;">–¢–æ–ø-50 –õ–∏–¥–µ—Ä–æ–≤</h2>
        <div class="list-container" id="list-top"></div>
    </div>

    <div class="screen" id="scr-friends">
        <h2 style="text-align:center; margin-bottom:5px;">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h2>
        <p style="text-align:center; color:var(--text-dim); font-size:12px; margin-bottom:20px;">–î–∞—Ä–∏–º 100.0 G –∑–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞!</p>
        <button class="btn-act btn-upgrade" style="background:var(--accent); color:#000; border:none;" onclick="App.invite()"><b>–ü–†–ò–ì–õ–ê–°–ò–¢–¨</b></button>
        <div class="list-container" id="list-friends" style="margin-top:20px;"></div>
    </div>

    <div class="screen" id="scr-wallet">
        <h2 style="text-align:center; margin-bottom:15px;">–í—ã–≤–æ–¥ Gold</h2>
        <div class="stat-box" style="margin-bottom:20px;">
            <span>–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞ (–ú–∏–Ω. 750 G)</span>
            <button class="btn-act btn-upgrade" id="btn-withdraw" style="width:100%; margin-top:10px;"><b>–í–´–í–ï–°–¢–ò</b></button>
        </div>
        <h4 style="margin-bottom:10px; color:var(--text-dim); font-size:12px; text-transform:uppercase;">–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç</h4>
        <div class="list-container" id="list-history"></div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="App.showScreen('mining', this)"><i>‚õèÔ∏è</i><span>–î–æ–±—ã—á–∞</span></div>
        <div class="nav-item" onclick="App.showScreen('top', this)"><i>üèÜ</i><span>–¢–æ–ø-50</span></div>
        <div class="nav-item" onclick="App.showScreen('friends', this)"><i>üë•</i><span>–î—Ä—É–∑—å—è</span></div>
        <div class="nav-item" onclick="App.showScreen('wallet', this)"><i>üè¶</i><span>–í—ã–≤–æ–¥</span></div>
    </nav>

    <script>
    const App = {
        db: null, tg: window.Telegram.WebApp, uid: null,
        user: { gold: 0, pwr: 0.001, upgCount: 0, name: 'User' },
        lastTaps: [], isLocked: false, syncTimer: null,

        async init() {
            this.tg.expand();
            this.uid = this.tg.initDataUnsafe?.user?.id?.toString() || "DEV_5223115893";
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
            firebase.initializeApp({
                apiKey: "AIzaSyCoa29KS-sin6hoRz0ZbE4f3ki0tZLwkKI",
                projectId: "gold-clicker-5d882",
                appId: "1:83489312782:web:ee5b7bdc390e53e7dd6c5f"
            });
            this.db = firebase.firestore();

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            const doc = await this.db.collection('players').doc(this.uid).get();
            if(doc.exists) {
                this.user = { ...this.user, ...doc.data() };
            } else {
                this.user.name = this.tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫";
                await this.db.collection('players').doc(this.uid).set(this.user);
            }

            this.bindEvents();
            this.updateUI();
            
            // –ê–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
            setInterval(() => this.save(), 10000);
        },

        bindEvents() {
            // –ö–ª–∏–∫ –ø–æ –º–æ–Ω–µ—Ç–µ
            const coin = document.getElementById('coin-trigger');
            coin.addEventListener('touchstart', (e) => {
                e.preventDefault();
                for(let i=0; i<e.changedTouches.length; i++) this.handleTap(e.changedTouches[i]);
            });

            // –ö–Ω–æ–ø–∫–∏
            document.getElementById('ad-bonus').onclick = () => this.showAd('gold');
            document.getElementById('ad-power').onclick = () => this.showAd('pwr');
            document.getElementById('btn-upg').onclick = () => this.upgrade();
            document.getElementById('btn-withdraw').onclick = () => this.withdraw();
            
            // –°–ª–µ–¥–∏–º –∑–∞ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            window.addEventListener('beforeunload', () => this.save());
        },

        handleTap(touch) {
            if(this.isLocked) return;
            
            const now = Date.now();
            this.lastTaps.push(now);
            this.lastTaps = this.lastTaps.filter(t => now - t < 1000);

            if(this.lastTaps.length > 20) {
                this.isLocked = true;
                document.getElementById('modal-ac').style.display = 'flex';
                return;
            }

            this.user.gold += this.user.pwr;
            this.updateUI();
            this.spawnPop(touch.clientX, touch.clientY);
            if(this.tg.HapticFeedback) this.tg.HapticFeedback.impactOccurred('light');
        },

        // –†–ê–°–ß–ï–¢ –¶–ï–ù–´ (–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è –∏–∑ –¢–ó)
        getUpgradePrice() {
            const count = this.user.upgCount || 0;
            if (count >= 20) return 150;
            if (count >= 10) return 15;
            if (count >= 3) return 5;
            return 1;
        },

        upgrade() {
            const price = this.getUpgradePrice();
            if(this.user.gold < price) return this.tg.showAlert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Gold! –ù—É–∂–Ω–æ ${price} G`);
            
            this.user.gold -= price;
            this.user.pwr += 0.005;
            this.user.upgCount = (this.user.upgCount || 0) + 1;
            
            this.save();
            this.updateUI();
            this.tg.HapticFeedback.notificationOccurred('success');
        },

        async save() {
            try {
                await this.db.collection('players').doc(this.uid).update({
                    gold: this.user.gold,
                    pwr: this.user.pwr,
                    upgCount: this.user.upgCount,
                    lastSync: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log("Saved safely.");
            } catch(e) { console.error("Save error", e); }
        },

        updateUI() {
            document.getElementById('val-gold').innerText = this.user.gold.toFixed(3);
            document.getElementById('val-pwr').innerText = this.user.pwr.toFixed(3);
            
            const price = this.getUpgradePrice();
            document.getElementById('upg-title').innerText = `–£–õ–£–ß–®–ò–¢–¨ –ó–ê ${price.toFixed(3)} G`;
            
            const btnW = document.getElementById('btn-withdraw');
            btnW.disabled = this.user.gold < 750;
            btnW.style.background = this.user.gold >= 750 ? 'var(--accent)' : 'none';
            btnW.style.color = this.user.gold >= 750 ? '#000' : '#fff';
        },

        showScreen(id, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById('scr-' + id).classList.add('active');
            el.classList.add('active');

            if(id === 'top') this.loadTop();
            if(id === 'friends') this.loadFriends();
            if(id === 'wallet') this.loadHistory();
        },

        async loadHistory() {
            const container = document.getElementById('list-history');
            container.innerHTML = '<p style="text-align:center; color:gray">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>';
            
            // –§–∏–∫—Å: –ó–∞–ø—Ä–æ—Å –∏–º–µ–Ω–Ω–æ –ø–æ —Ç–µ–∫—É—â–µ–º—É UID
            const snap = await this.db.collection('withdrawals')
                .where('uid', '==', this.uid)
                .orderBy('date', 'desc')
                .get();
            
            container.innerHTML = snap.empty ? '<p style="text-align:center; color:gray; margin-top:20px;">–ò—Å—Ç–æ—Ä–∏–∏ –≤—ã–ø–ª–∞—Ç –ø–æ–∫–∞ –Ω–µ—Ç</p>' : '';
            
            snap.forEach(doc => {
                const d = doc.data();
                container.innerHTML += `
                    <div class="card-item">
                        <div class="card-info">
                            <h4>–í—ã–≤–æ–¥ Gold</h4>
                            <p>${d.date || '–ù–µ–¥–∞–≤–Ω–æ'}</p>
                        </div>
                        <div class="card-val" style="color:${d.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' ? '#4cd964' : 'var(--accent)'}">${d.amount} G</div>
                    </div>
                `;
            });
        },

        async withdraw() {
            if(this.user.gold < 750) return;
            const sid = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à ID Standoff 2:");
            if(!sid || sid.length < 5) return;

            const amount = Math.floor(this.user.gold);
            const request = {
                uid: this.uid,
                sid: sid,
                amount: amount,
                status: "–û–∂–∏–¥–∞–Ω–∏–µ",
                date: new Date().toLocaleString()
            };

            await this.db.collection('withdrawals').add(request);
            this.user.gold -= amount;
            await this.save();
            this.updateUI();
            this.loadHistory();
            this.tg.showAlert("–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ 24 —á–∞—Å–æ–≤.");
        },

        async loadTop() {
            const container = document.getElementById('list-top');
            container.innerHTML = '';
            const snap = await this.db.collection('players').orderBy('gold', 'desc').limit(50).get();
            let rank = 1;
            snap.forEach(doc => {
                const d = doc.data();
                container.innerHTML += `
                    <div class="card-item">
                        <div class="card-info"><h4>${rank++}. ${d.name || '–ê–Ω–æ–Ω–∏–º'}</h4></div>
                        <div class="card-val">${Math.floor(d.gold)} G</div>
                    </div>
                `;
            });
        },

        async loadFriends() {
            const container = document.getElementById('list-friends');
            const snap = await this.db.collection('players').doc(this.uid).collection('referrals').get();
            document.getElementById('val-refs').innerText = snap.size;
            container.innerHTML = snap.empty ? '<p style="text-align:center; color:gray">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π</p>' : '';
            snap.forEach(doc => {
                container.innerHTML += `<div class="card-item"><span>${doc.data().name}</span><b>+100 G</b></div>`;
            });
        },

        invite() {
            const link = `https://t.me/Locus_Gold_bot/app?startapp=${this.uid}`;
            this.tg.openTelegramLink(`https://t.me/share/url?url=${link}&text=–ó–∞–±–∏—Ä–∞–π –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –≥–æ–ª–¥—É –≤ Locus Gold!`);
        },

        showAd(type) {
            if(!window.Adsgram) return this.tg.showAlert("–†–µ–∫–ª–∞–º–Ω–∞—è —Å–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
            const Ad = Adsgram.init({ blockId: "19895" });
            Ad.show().then(() => {
                if(type === 'gold') this.user.gold += 5; else this.user.pwr += 0.005;
                this.save(); this.updateUI();
            }).catch(e => this.tg.showAlert("–†–µ–∫–ª–∞–º–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."));
        },

        spawnPop(x, y) {
            const p = document.createElement('div');
            p.className = 'f-pop';
            p.innerText = `+${this.user.pwr.toFixed(3)}`;
            p.style.left = x + 'px'; p.style.top = y + 'px';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 700);
        },

        closeAC() {
            document.getElementById('modal-ac').style.display = 'none';
            this.isLocked = false;
            this.lastTaps = [];
        }
    };

    window.onload = () => App.init();
    </script>
</body>
</html>
